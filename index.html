<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#111827">
  <meta name="description" content="Track your workouts, monitor progress, and achieve your fitness goals">
  <title>Workout Pro</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="apple-touch-icon" href="/favicon.svg">
  <link rel="manifest" href="/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Workout Pro">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overscroll-behavior-y: contain; }
    *::-webkit-scrollbar { width: 0; background: transparent; }
    * { -ms-overflow-style: none; scrollbar-width: none; }

    /* Mobile scrolling performance optimizations */
    .transform-gpu {
      transform: translateZ(0);
      will-change: transform;
      -webkit-transform: translateZ(0);
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }

    /* Smooth scrolling with hardware acceleration */
    #root {
      -webkit-overflow-scrolling: touch;
      transform: translateZ(0);
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // Simple SVG icon components
    const Dumbbell = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg>;
    
    const TrendingUp = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>;
    
    const Calendar = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
    
    const Download = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;

    const Upload = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;

    const Edit2 = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>;
    
    const Plus = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>;

    const PlusCircle = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>;

    const Trash2 = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
    
    const Check = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>;
    
    const X = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;

    const RepeatIcon = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>;
    
    const ChevronRight = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>;

    const ChevronUp = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m18 15-6-6-6 6"/></svg>;

    const ChevronDown = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>;

    const Sun = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>;
    
    const Moon = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>;
    
    const BarChart3 = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>;
    
    const Zap = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
    
    const Target = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>;
    
    const Award = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>;

    // Additional workout-specific icons
    const Activity = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>;

    const GripVertical = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>;

    const Flame = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>;

    // Popular exercises database - organized by category
    const popularExercises = {
      chest: [
        'Bench Press',
        'Incline Bench Press',
        'Decline Bench Press',
        'Dumbbell Bench Press',
        'Incline DB Press',
        'Chest Fly',
        'Cable Fly',
        'Push-ups',
        'Dips (Chest Focus)'
      ],
      back: [
        'Deadlift',
        'Trap Bar Deadlift',
        'Romanian Deadlift (RDL)',
        'Barbell Row',
        'Dumbbell Row',
        'T-Bar Row',
        'Pull-ups',
        'Lat Pulldown',
        'Cable Row',
        'Face Pulls',
        'Shrugs'
      ],
      shoulders: [
        'Overhead Press (OHP)',
        'Military Press',
        'Dumbbell Shoulder Press',
        'Lateral Raises',
        'Front Raises',
        'Rear Delt Fly',
        'Arnold Press',
        'Upright Row'
      ],
      legs: [
        'Back Squat',
        'Front Squat',
        'Leg Press',
        'Bulgarian Split Squat',
        'Lunges',
        'Leg Extension',
        'Leg Curl',
        'Calf Raises',
        'Hack Squat'
      ],
      arms: [
        'Barbell Curl',
        'Dumbbell Curl',
        'Hammer Curls',
        'Preacher Curl',
        'Cable Curl',
        'Triceps Pushdown',
        'Overhead Triceps Extension',
        'Skull Crushers',
        'Close-Grip Bench Press',
        'Dips (Triceps Focus)'
      ],
      core: [
        'Plank',
        'Side Plank',
        'Ab Wheel Rollout',
        'Hanging Leg Raises',
        'Cable Crunch',
        'Russian Twist',
        'Dead Bug',
        'Pallof Press',
        'Bicycle Crunches',
        'Mountain Climbers'
      ],
      other: [
        "Farmer's Walk",
        'Sled Push',
        'Sled Pull',
        'Battle Ropes',
        'Box Jumps',
        'Burpees',
        'Kettlebell Swings'
      ]
    };

    // Flatten all exercises into single searchable array
    const allExercises = Object.values(popularExercises).flat().sort();

    // Icon mapper - maps emoji to icon component
    const WorkoutIcon = ({emoji, size = 40, className = ""}) => {
      const iconMap = {
        'ðŸ¦µ': <Dumbbell size={size} className={className} />,
        'ðŸ’ª': <Activity size={size} className={className} />,
        'âš¡': <Zap size={size} className={className} />,
        'ðŸŽ¯': <Target size={size} className={className} />,
        'ðŸ”¥': <Flame size={size} className={className} />
      };
      return iconMap[emoji] || <span className="text-4xl">{emoji}</span>;
    };

    // LineChart component for timeline visualization
    const LineChart = ({data, metric, darkMode, onPointClick, selectedPoint}) => {
      if (!data || data.length === 0) return null;

      const width = 350;
      const height = 220;
      const padding = {top: 20, right: 20, bottom: 45, left: 50};

      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      // Get values for the selected metric
      const values = data.map(d => {
        if (metric === 'volume') return d.volume;
        if (metric === 'reps') return d.reps;
        return 0;
      });

      const maxValue = Math.max(...values, 1);
      const minValue = Math.min(...values, 0);

      // Scale functions
      const scaleX = (index) => {
        if (data.length === 1) return padding.left + chartWidth / 2;
        return padding.left + (index / (data.length - 1)) * chartWidth;
      };
      const scaleY = (value) => padding.top + chartHeight - ((value - minValue) / (maxValue - minValue)) * chartHeight;

      // Generate path for line
      const pathData = data.map((point, i) => {
        const x = scaleX(i);
        const y = scaleY(values[i]);
        return i === 0 ? `M ${x} ${y}` : `L ${x} ${y}`;
      }).join(' ');

      // Format date labels
      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return '';
        const month = date.toLocaleDateString('en-US', {month: 'short'});
        const day = date.getDate();
        return `${month} ${day}`;
      };

      // Y-axis labels
      const yAxisLabels = [maxValue, Math.round(maxValue / 2), 0];

      return (
        <svg width={width} height={height} className="touch-manipulation">
          {/* Grid lines */}
          {yAxisLabels.map((value, i) => {
            const y = scaleY(value);
            return (
              <g key={i}>
                <line
                  x1={padding.left}
                  y1={y}
                  x2={width - padding.right}
                  y2={y}
                  stroke={darkMode ? '#374151' : '#E5E7EB'}
                  strokeWidth="1"
                  strokeDasharray="3,3"
                />
                <text
                  x={padding.left - 10}
                  y={y + 4}
                  textAnchor="end"
                  fontSize="12"
                  fill={darkMode ? '#9CA3AF' : '#6B7280'}
                >
                  {value}
                </text>
              </g>
            );
          })}

          {/* Line */}
          <path
            d={pathData}
            fill="none"
            stroke={darkMode ? '#60A5FA' : '#3B82F6'}
            strokeWidth="3"
            strokeLinecap="round"
            strokeLinejoin="round"
          />

          {/* Data points */}
          {data.map((point, i) => {
            const x = scaleX(i);
            const y = scaleY(values[i]);
            const isSelected = selectedPoint && selectedPoint.date === point.date;

            return (
              <g key={i}>
                <circle
                  cx={x}
                  cy={y}
                  r={isSelected ? 8 : 5}
                  fill={darkMode ? '#60A5FA' : '#3B82F6'}
                  stroke={darkMode ? '#1F2937' : '#FFFFFF'}
                  strokeWidth="2"
                  style={{cursor: 'pointer'}}
                  onClick={() => onPointClick(point)}
                  className="transition-all"
                />
                {/* X-axis label - smart labeling based on data count */}
                {(() => {
                  const dataCount = data.length;
                  let shouldShowLabel = false;

                  if (dataCount <= 7) {
                    // Show all labels for â‰¤7 days
                    shouldShowLabel = true;
                  } else if (dataCount <= 14) {
                    // Show every other label for 8-14 days
                    shouldShowLabel = i % 2 === 0 || i === dataCount - 1;
                  } else if (dataCount <= 30) {
                    // Show ~5 labels for 15-30 days
                    const step = Math.floor(dataCount / 5);
                    shouldShowLabel = i % step === 0 || i === dataCount - 1;
                  } else if (dataCount <= 90) {
                    // Show ~7 labels for 31-90 days
                    const step = Math.floor(dataCount / 7);
                    shouldShowLabel = i % step === 0 || i === dataCount - 1;
                  } else {
                    // Show ~10 labels for >90 days
                    const step = Math.floor(dataCount / 10);
                    shouldShowLabel = i % step === 0 || i === dataCount - 1;
                  }

                  return shouldShowLabel ? (
                    <text
                      x={x}
                      y={height - padding.bottom + 20}
                      textAnchor="middle"
                      fontSize="11"
                      fill={darkMode ? '#9CA3AF' : '#6B7280'}
                    >
                      {formatDate(point.date)}
                    </text>
                  ) : null;
                })()}
              </g>
            );
          })}
        </svg>
      );
    };

    // Exercise input with autocomplete dropdown
    const ExerciseInput = ({value, onChange, darkMode, placeholder = "Exercise name"}) => {
      const [showDropdown, setShowDropdown] = React.useState(false);
      const [filteredExercises, setFilteredExercises] = React.useState([]);
      const inputRef = React.useRef(null);

      React.useEffect(() => {
        if (value && value.length > 0) {
          const filtered = allExercises.filter(ex =>
            ex.toLowerCase().includes(value.toLowerCase())
          ).slice(0, 8); // Show max 8 suggestions
          setFilteredExercises(filtered);
        } else {
          setFilteredExercises([]);
        }
      }, [value]);

      const handleInputChange = (e) => {
        onChange(e.target.value);
        setShowDropdown(true);
      };

      const handleSelect = (exercise) => {
        onChange(exercise);
        setShowDropdown(false);
        inputRef.current?.blur();
      };

      return (
        <div className="relative flex-1">
          <input
            ref={inputRef}
            type="text"
            value={value}
            onChange={handleInputChange}
            onFocus={() => setShowDropdown(true)}
            onBlur={() => setTimeout(() => setShowDropdown(false), 200)}
            className={`w-full px-3 py-2 ${darkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg focus:border-gray-500 focus:outline-none`}
            placeholder={placeholder}
          />
          {showDropdown && filteredExercises.length > 0 && (
            <div className={`absolute z-50 w-full mt-1 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-300'} border rounded-lg shadow-lg max-h-60 overflow-y-auto`}>
              {filteredExercises.map((exercise, idx) => (
                <button
                  key={idx}
                  type="button"
                  onClick={() => handleSelect(exercise)}
                  className={`w-full text-left px-3 py-2 ${darkMode ? 'hover:bg-gray-700 text-gray-200' : 'hover:bg-gray-100 text-gray-900'} transition-colors text-sm`}
                >
                  {exercise}
                </button>
              ))}
            </div>
          )}
        </div>
      );
    };

    // Icon picker component for selecting workout icons
    const IconPicker = ({selectedEmoji, onSelect, darkMode}) => {
      const availableIcons = [
        {emoji: 'ðŸ¦µ', name: 'Dumbbell'},
        {emoji: 'ðŸ’ª', name: 'Activity'},
        {emoji: 'âš¡', name: 'Zap'},
        {emoji: 'ðŸŽ¯', name: 'Target'},
        {emoji: 'ðŸ”¥', name: 'Flame'}
      ];

      return (
        <div className="grid grid-cols-5 gap-2 mt-2">
          {availableIcons.map(icon => (
            <button
              key={icon.emoji}
              type="button"
              onClick={() => onSelect(icon.emoji)}
              className={`p-3 rounded-lg transition-colors ${
                selectedEmoji === icon.emoji
                  ? 'bg-blue-600 ring-2 ring-blue-400'
                  : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'
              }`}
            >
              <WorkoutIcon emoji={icon.emoji} size={24} className={selectedEmoji === icon.emoji ? 'text-white' : (darkMode ? 'text-gray-300' : 'text-gray-700')} />
            </button>
          ))}
        </div>
      );
    };

// IndexedDB wrapper
const DB_NAME = 'WorkoutTrackerDB';
const DB_VERSION = 2;

const initDB = () => {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve(request.result);
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;

      if (!db.objectStoreNames.contains('workouts')) {
        db.createObjectStore('workouts', { keyPath: 'id' });
      }

      if (!db.objectStoreNames.contains('history')) {
        const historyStore = db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
        historyStore.createIndex('date', 'date', { unique: false });
        historyStore.createIndex('workoutId', 'workoutId', { unique: false });
      }

      if (!db.objectStoreNames.contains('bodyWeight')) {
        const bodyWeightStore = db.createObjectStore('bodyWeight', { keyPath: 'id', autoIncrement: true });
        bodyWeightStore.createIndex('date', 'date', { unique: false });
      }
    };
  });
};

const dbOperations = {
  async saveWorkouts(workouts) {
    const db = await initDB();
    const tx = db.transaction('workouts', 'readwrite');
    const store = tx.objectStore('workouts');
    
    await store.clear();
    for (const workout of workouts) {
      await store.put(workout);
    }
    
    return new Promise((resolve, reject) => {
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },
  
  async getWorkouts() {
    const db = await initDB();
    const tx = db.transaction('workouts', 'readonly');
    const store = tx.objectStore('workouts');
    const request = store.getAll();
    
    return new Promise((resolve, reject) => {
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  },
  
  async saveHistory(history) {
    const db = await initDB();
    const tx = db.transaction('history', 'readwrite');
    const store = tx.objectStore('history');
    
    await store.put(history);
    
    return new Promise((resolve, reject) => {
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },
  
  async getHistory() {
    const db = await initDB();
    const tx = db.transaction('history', 'readonly');
    const store = tx.objectStore('history');
    const request = store.getAll();

    return new Promise((resolve, reject) => {
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  },

  async saveBodyWeight(weight, gender = 'male') {
    const db = await initDB();
    const tx = db.transaction('bodyWeight', 'readwrite');
    const store = tx.objectStore('bodyWeight');

    const entry = {
      weight: Number(weight),
      gender: gender,
      date: new Date().toISOString(),
      unit: 'kg'
    };

    await store.put(entry);

    return new Promise((resolve, reject) => {
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },

  async getBodyWeightHistory() {
    const db = await initDB();
    const tx = db.transaction('bodyWeight', 'readonly');
    const store = tx.objectStore('bodyWeight');
    const request = store.getAll();

    return new Promise((resolve, reject) => {
      request.onsuccess = () => {
        const records = request.result;
        // Sort by date descending (newest first)
        records.sort((a, b) => new Date(b.date) - new Date(a.date));
        resolve(records);
      };
      request.onerror = () => reject(request.error);
    });
  },

  async getLatestBodyWeight() {
    const history = await this.getBodyWeightHistory();
    return history.length > 0 ? history[0] : null;
  }
};

// Intelligent markdown parser - auto-detects any format
const parseMarkdownWorkout = (markdownText) => {
  // Helper: Check if line is likely a workout day separator
  const isWorkoutDayHeader = (line, upperLine) => {
    // Pattern 1: Starts with # or ##
    if (!line.startsWith('#')) return false;

    // Pattern 2: Contains day indicators
    const dayIndicators = ['DAY', 'DAN', 'WORKOUT', 'TRAINING', 'TRENING', 'WEEK', 'Ð¡Ð•Ð”ÐœÐ˜Ð¦Ð'];
    const hasDay = dayIndicators.some(indicator => upperLine.includes(indicator));

    // Pattern 3: Contains numbers (Day 1, Dan 2, etc.)
    const hasNumber = /\d/.test(line);

    // Pattern 4: Contains common workout types
    const workoutTypes = ['PUSH', 'PULL', 'LEG', 'UPPER', 'LOWER', 'FULL', 'CARDIO', 'STRENGTH'];
    const hasWorkoutType = workoutTypes.some(type => upperLine.includes(type));

    // Heuristic: It's a workout day if it has day indicator + number, or H1/H2 with workout type
    return (hasDay && hasNumber) || (line.match(/^#{1,2}\s/) && hasWorkoutType);
  };

  // Helper: Extract numeric value (handles ranges like "3-4", "8â€“10")
  const extractNumber = (text) => {
    const match = text.match(/(\d+)/);
    return match ? parseInt(match[1]) : null;
  };

  // Helper: Check if text looks like exercise data (sets/reps)
  const looksLikeExerciseData = (text) => {
    // Pattern: Contains numbers or x notation (3x8, 3 x 10, etc.)
    return /\d+\s*[xXÃ—]\s*\d+/.test(text) || /\d+/.test(text);
  };

  // Helper: Detect if line is likely a table header
  const isTableHeader = (cells) => {
    if (!cells || cells.length === 0) return false;
    const firstCell = cells[0].toLowerCase();
    const headerWords = ['exercise', 'vjeÅ¾ba', 'vjezba', 'name', 'naziv', 'sets', 'serije', 'reps', 'ponavljanja'];
    return headerWords.some(word => firstCell.includes(word));
  };

  // Helper: Smart extraction of sets/reps from any text
  const extractSetsReps = (text) => {
    // Try compact format first: "3x8", "4 x 10-12"
    const compactMatch = text.match(/(\d+)\s*[xXÃ—]\s*([\d\-â€“s]+)/);
    if (compactMatch) {
      return { sets: parseInt(compactMatch[1]), reps: compactMatch[2] };
    }

    // Try separate format: "Sets: 3" "Reps: 8"
    const setsMatch = text.match(/(?:sets?|serije):\s*(\d+)/i);
    const repsMatch = text.match(/(?:reps?|ponavljanja):\s*([\d\-â€“s]+)/i);

    return {
      sets: setsMatch ? parseInt(setsMatch[1]) : null,
      reps: repsMatch ? repsMatch[1] : null
    };
  };

  const workouts = [];
  let currentWorkout = null;
  let currentExercise = null;
  const lines = markdownText.split('\n');

  for (let line of lines) {
    line = line.trim();

    // Skip empty lines, dividers, and markdown table alignment rows
    if (!line || line.startsWith('|---') || line === '---' ||
        (line.startsWith('|') && line.includes(':---'))) continue;  // Markdown table alignment (| :--- | :---: |)

    const upperLine = line.toUpperCase();

    // STEP 1: Detect workout day headers using intelligent heuristics
    if (isWorkoutDayHeader(line, upperLine)) {
      // Save previous workout
      if (currentWorkout && currentWorkout.exercises.length > 0) {
        workouts.push(currentWorkout);
      }

      // Extract emoji
      const emojiMatch = line.match(/[\u{1F300}-\u{1F9FF}]/u);
      const emoji = emojiMatch ? emojiMatch[0] : 'ðŸ”¥';

      // Clean up name
      let name = line.replace(/^#+\s*/, '').replace(emoji, '').trim();

      currentWorkout = {
        id: Date.now() + workouts.length,
        name: name || 'Workout',
        emoji: emoji,
        exercises: []
      };
      currentExercise = null;
      continue;
    }

    // STEP 2: Append descriptions (H3 headers only - NOT bold exercise names)
    if (line.startsWith('###')) {
      const description = line.replace(/^###\s*/, '').trim();

      // Only append if it looks like a description (contains keywords or is short)
      const isDescription = description.length < 80 &&
                           (description.toLowerCase().includes('fokus') ||
                            description.toLowerCase().includes('focus') ||
                            description.toLowerCase().includes(':'));

      if (isDescription && currentWorkout) {
        const cleanDesc = description.replace(/^(?:fokus|focus):\s*/i, '').trim();
        if (cleanDesc && !currentWorkout.name.includes(cleanDesc)) {
          currentWorkout.name = `${currentWorkout.name} - ${cleanDesc}`;
        }
      }
      continue;
    }

    // STEP 3: Parse table rows (most common format)
    if (line.startsWith('|') && line.endsWith('|')) {
      const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell);

      // Skip headers
      if (isTableHeader(cells)) continue;

      // Auto-create workout if table appears without header
      if (!currentWorkout) {
        currentWorkout = {
          id: Date.now(),
          name: 'Workout',
          emoji: 'ðŸ”¥',
          exercises: []
        };
      }

      // Smart column detection - find exercise name, sets, reps
      if (cells.length >= 2) {
        // Remove bold markers (**text**) and italic markers (*text* or _text_)
        const exerciseName = cells[0].trim()
          .replace(/^\*\*/, '').replace(/\*\*$/, '')  // Remove bold
          .replace(/^\*/, '').replace(/\*$/, '')      // Remove italic (*)
          .replace(/^_/, '').replace(/_$/, '');       // Remove italic (_)

        // Skip if first cell looks like data, not exercise name
        if (exerciseName.length < 3 || /^\d+$/.test(exerciseName)) continue;

        let sets = 3, reps = 10, notes = '';

        // Intelligently detect which columns contain sets/reps
        for (let i = 1; i < cells.length; i++) {
          const cell = cells[i];
          const extracted = extractSetsReps(cell);

          if (extracted.sets !== null) sets = extracted.sets;
          if (extracted.reps !== null) reps = extracted.reps;

          // Check if cell is pure number (likely sets or reps)
          if (/^\d+$/.test(cell) && i === 1) sets = parseInt(cell);
          else if (/^[\d\-â€“s]+$/.test(cell) && i === 2) reps = cell;

          // Last column or cells with text = notes
          if (i >= 4 && cell.length > 2 && !/^\d/.test(cell)) {
            // Clean up notes (remove bold/italic markers)
            notes = cell
              .replace(/\*\*/g, '')  // Remove all bold markers
              .replace(/\*/g, '')    // Remove all italic markers (*)
              .replace(/_/g, '');    // Remove all italic markers (_)
          }
        }

        currentWorkout.exercises.push({ name: exerciseName, sets, reps, notes });
      }
      continue;
    }

    // STEP 4: Parse bold exercise format (common in workout logs)
    // Pattern: **Exercise Name**
    //          70kg â€” 3x5
    // Also handles: **Exercise** *(notes in italics)*
    const boldExerciseMatch = line.match(/^\*\*(.+?)\*\*/);
    if (boldExerciseMatch) {
      // Auto-create workout if needed
      if (!currentWorkout) {
        currentWorkout = {
          id: Date.now(),
          name: 'Workout Log',
          emoji: 'ðŸ”¥',
          exercises: []
        };
      }

      const exerciseName = boldExerciseMatch[1].trim();

      // Extract inline notes (e.g., *(superset with X)*)
      const inlineNotesMatch = line.match(/\*\*\s*\*(.+?)\*/);
      const inlineNotes = inlineNotesMatch ? inlineNotesMatch[1].trim() : '';

      currentExercise = { name: exerciseName, sets: 3, reps: 10, notes: inlineNotes };
      currentWorkout.exercises.push(currentExercise);
      continue;
    }

    // STEP 5: Parse list/heading format exercises (## Exercise or - Exercise)
    if (line.startsWith('##') && !isWorkoutDayHeader(line, upperLine)) {
      // Auto-create workout if needed
      if (!currentWorkout) {
        currentWorkout = {
          id: Date.now(),
          name: 'Workout',
          emoji: 'ðŸ”¥',
          exercises: []
        };
      }

      // Remove header marker and formatting (bold/italic)
      const exerciseName = line.replace(/^##\s*/, '').trim()
        .replace(/^\*\*/, '').replace(/\*\*$/, '')  // Remove bold
        .replace(/^\*/, '').replace(/\*$/, '')      // Remove italic (*)
        .replace(/^_/, '').replace(/_$/, '');       // Remove italic (_)

      currentExercise = { name: exerciseName, sets: 3, reps: 10, notes: '' };
      currentWorkout.exercises.push(currentExercise);
      continue;
    }

    // STEP 6: Parse exercise details (sets/reps/notes on following lines)
    if (currentExercise) {
      // Try to extract weight + setsÃ—reps format: "70kg â€” 3x5" or "20kg â€” 2x5, 1x10"
      const weightSetsMatch = line.match(/(\d+(?:\.\d+)?)\s*kg\s*[â€”â€“-]\s*(.+)/i);
      if (weightSetsMatch) {
        const weight = weightSetsMatch[1];
        const setsRepsText = weightSetsMatch[2].trim();

        // Extract RPE/notes if present (e.g., "@ RPE 9.5" or "(superset with X)")
        const notesMatch = setsRepsText.match(/[@\(](.+)/);
        if (notesMatch) {
          currentExercise.notes = notesMatch[1].trim().replace(/^\s*RPE\s*/i, 'RPE ').replace(/[\(\)]/g, '');
        }

        // Parse setsÃ—reps (handles "3x5" or "2x5, 1x10")
        const cleanSetsReps = setsRepsText.split(/[@\(]/)[0].trim();
        const extracted = extractSetsReps(cleanSetsReps);

        if (extracted.sets) currentExercise.sets = extracted.sets;
        if (extracted.reps) currentExercise.reps = extracted.reps;

        // Store weight in notes if not already present
        if (!currentExercise.notes || !currentExercise.notes.includes(weight)) {
          const weightNote = `${weight}kg`;
          currentExercise.notes = currentExercise.notes
            ? `${weightNote} | ${currentExercise.notes}`
            : weightNote;
        }
        continue;
      }

      // Fallback: standard sets/reps extraction
      const extracted = extractSetsReps(line);
      if (extracted.sets) currentExercise.sets = extracted.sets;
      if (extracted.reps) currentExercise.reps = extracted.reps;

      // Notes detection
      const notesMatch = line.match(/(?:notes?|napomena):\s*(.+)/i);
      if (notesMatch) currentExercise.notes = notesMatch[1];
    }
  }

  // Save last workout
  if (currentWorkout && currentWorkout.exercises.length > 0) {
    workouts.push(currentWorkout);
  }

  // Auto-assign icons cyclically
  const defaultIcons = ['ðŸ¦µ', 'ðŸ’ª', 'âš¡', 'ðŸŽ¯', 'ðŸ”¥'];
  workouts.forEach((workout, idx) => {
    if (workout.emoji === 'ðŸ”¥') {
      workout.emoji = defaultIcons[idx % defaultIcons.length];
    }
  });

  return workouts;
};

// CSV/Excel parser - auto-detects workout structure
const parseCSVWorkout = (csvText) => {
  const workouts = [];
  let currentWorkout = null;

  // Parse CSV (simple split by comma, handling quoted values)
  const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);

  // Helper: Parse CSV line with quoted value support
  const parseCSVLine = (line) => {
    const cells = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];

      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        cells.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    cells.push(current.trim());
    return cells;
  };

  // Detect headers
  let headerRow = null;
  let workoutColIdx = -1, exerciseColIdx = -1, setsColIdx = -1, repsColIdx = -1, notesColIdx = -1;

  for (let i = 0; i < Math.min(5, lines.length); i++) {
    const cells = parseCSVLine(lines[i]);
    const lowerCells = cells.map(c => c.toLowerCase());

    // Check if this looks like a header row
    if (lowerCells.some(c => c.includes('workout') || c.includes('day') || c.includes('exercise') ||
                             c.includes('vjeÅ¾ba') || c.includes('sets') || c.includes('serije'))) {
      headerRow = i;

      // Find column indices
      lowerCells.forEach((cell, idx) => {
        if (cell.includes('workout') || cell.includes('day') || cell.includes('dan')) workoutColIdx = idx;
        if (cell.includes('exercise') || cell.includes('vjeÅ¾ba') || cell.includes('vjezba')) exerciseColIdx = idx;
        if (cell.includes('sets') || cell.includes('serije')) setsColIdx = idx;
        if (cell.includes('reps') || cell.includes('ponavljanja')) repsColIdx = idx;
        if (cell.includes('notes') || cell.includes('napomena')) notesColIdx = idx;
      });
      break;
    }
  }

  // If no clear headers, assume first row is header and guess columns
  if (headerRow === null) {
    headerRow = 0;
    const firstDataRow = lines.length > 1 ? parseCSVLine(lines[1]) : [];

    // Guess: Column 0 = workout/exercise, Column 1 = sets, Column 2 = reps
    if (firstDataRow.length >= 3) {
      exerciseColIdx = 0;
      setsColIdx = 1;
      repsColIdx = 2;
      if (firstDataRow.length >= 4) notesColIdx = 3;
    }
  }

  // Parse data rows
  for (let i = headerRow + 1; i < lines.length; i++) {
    const cells = parseCSVLine(lines[i]);
    if (cells.length === 0 || cells.every(c => !c)) continue;

    // Check if this row defines a new workout day
    const workoutName = workoutColIdx >= 0 && cells[workoutColIdx] ? cells[workoutColIdx].trim() : '';
    const exerciseName = exerciseColIdx >= 0 && cells[exerciseColIdx] ? cells[exerciseColIdx].trim() : cells[0]?.trim() || '';

    // If workout column has value, start new workout
    if (workoutName && workoutName !== currentWorkout?.name) {
      if (currentWorkout && currentWorkout.exercises.length > 0) {
        workouts.push(currentWorkout);
      }

      currentWorkout = {
        id: Date.now() + workouts.length,
        name: workoutName,
        emoji: 'ðŸ”¥',
        exercises: []
      };
    }

    // Auto-create workout if no workout column exists
    if (!currentWorkout) {
      currentWorkout = {
        id: Date.now(),
        name: 'Imported Workout',
        emoji: 'ðŸ”¥',
        exercises: []
      };
    }

    // Add exercise if we have a name
    if (exerciseName && exerciseName.length >= 2) {
      const sets = setsColIdx >= 0 && cells[setsColIdx] ? parseInt(cells[setsColIdx]) || 3 : 3;
      const reps = repsColIdx >= 0 && cells[repsColIdx] ? cells[repsColIdx] : '10';
      const notes = notesColIdx >= 0 && cells[notesColIdx] ? cells[notesColIdx] : '';

      currentWorkout.exercises.push({
        name: exerciseName,
        sets: sets,
        reps: reps,
        notes: notes
      });
    }
  }

  // Save last workout
  if (currentWorkout && currentWorkout.exercises.length > 0) {
    workouts.push(currentWorkout);
  }

  // Auto-assign icons
  const defaultIcons = ['ðŸ¦µ', 'ðŸ’ª', 'âš¡', 'ðŸŽ¯', 'ðŸ”¥'];
  workouts.forEach((workout, idx) => {
    if (workout.emoji === 'ðŸ”¥') {
      workout.emoji = defaultIcons[idx % defaultIcons.length];
    }
  });

  return workouts;
};

// Sound system - generates subtle beeps using Web Audio API
const soundSystem = {
  audioContext: null,

  init() {
    if (!this.audioContext) {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
  },

  playTone(frequency, duration, volume = 0.3) {
    if (!this.audioContext) this.init();

    const oscillator = this.audioContext.createOscillator();
    const gainNode = this.audioContext.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(this.audioContext.destination);

    oscillator.frequency.value = frequency;
    oscillator.type = 'sine';

    gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);

    oscillator.start(this.audioContext.currentTime);
    oscillator.stop(this.audioContext.currentTime + duration);
  },

  appLaunch() {
    // Gentle ascending beep
    this.playTone(440, 0.1, 0.2);
    setTimeout(() => this.playTone(554, 0.15, 0.15), 80);
  },

  workoutStart() {
    // Energetic double beep
    this.playTone(523, 0.12, 0.25);
    setTimeout(() => this.playTone(659, 0.15, 0.2), 100);
  },

  workoutComplete() {
    // Satisfying success chord
    this.playTone(523, 0.15, 0.2);
    setTimeout(() => this.playTone(659, 0.15, 0.2), 100);
    setTimeout(() => this.playTone(784, 0.25, 0.25), 200);
  }
};

const WorkoutTracker = () => {
  const [workouts, setWorkouts] = useState([
    {
      id: 1,
      name: "DAY 1 â€“ PUSH A (Heavy Bench & Quads)",
      emoji: "ðŸ¦µ",
      exercises: [
        { name: "Bench Press", sets: 3, reps: 5, notes: "Main lift. Last set AMRAP." },
        { name: "Back Squat", sets: 3, reps: 8, notes: "Focus on depth and control." },
        { name: "Lateral Raises", sets: 4, reps: "15â€“20", notes: "Light weight, burn effect." },
        { name: "Triceps Pushdown", sets: 3, reps: 12, notes: "Focus on full lockout." },
        { name: "Ab Wheel Rollout", sets: 3, reps: "8â€“10", notes: "Anti-extension core." }
      ]
    },
    {
      id: 2,
      name: "DAY 2 â€“ PULL A (Deadlift & Lat Width)",
      emoji: "ðŸ’ª",
      exercises: [
        { name: "Trap Bar Deadlift", sets: 3, reps: 5, notes: "Explosive from the floor." },
        { name: "Pull-ups / Lat Pulldown", sets: 3, reps: "8â€“10", notes: "Wide grip for V-taper." },
        { name: "Face Pulls", sets: 3, reps: 15, notes: "1-second pause at contraction." },
        { name: "Hammer Curls", sets: 3, reps: 12, notes: "Bicep and forearm thickness." },
        { name: "Back Extension", sets: 3, reps: 12, notes: "Lower back strength." },
        { name: "Dead Bug", sets: 2, reps: "10/side", notes: "Core stability." }
      ]
    },
    {
      id: 3,
      name: "DAY 3 â€“ PUSH B (Heavy OHP & Upper Chest)",
      emoji: "âš¡",
      exercises: [
        { name: "Overhead Press", sets: 3, reps: "5â€“6", notes: "Squeeze glutes, no cheating." },
        { name: "Bulgarian Split Squat", sets: 3, reps: 10, notes: "Per leg. Key for athletic build." },
        { name: "Incline DB Press", sets: 3, reps: "10â€“12", notes: "Focus on upper chest." },
        { name: "Dips", sets: 3, reps: "To failure", notes: "Lean forward." },
        { name: "Pallof Press", sets: 3, reps: "12/side", notes: "Anti-rotation core." },
        { name: "Side Plank", sets: 2, reps: "30â€“45 s", notes: "Oblique stability." }
      ]
    },
    {
      id: 4,
      name: "DAY 4 â€“ PULL B (Posterior Chain & Back Thickness)",
      emoji: "ðŸŽ¯",
      exercises: [
        { name: "Romanian Deadlift", sets: 3, reps: 10, notes: "Focus on hamstring stretch." },
        { name: "Dumbbell Row", sets: 3, reps: 10, notes: "Pull elbow to hip." },
        { name: "Farmer's Walk", sets: 3, reps: "40 m", notes: "Heavy dumbbells (grip and core)." },
        { name: "Hanging Leg Raises", sets: 3, reps: "12â€“15", notes: "Controlled leg lift." },
        { name: "Back Extension Hold", sets: 2, reps: "30 s", notes: "Erector spinae endurance." }
      ]
    }
  ]);

  const [completedWorkouts, setCompletedWorkouts] = useState([]);
  const [activeView, setActiveView] = useState('home');
  const [currentLog, setCurrentLog] = useState(null);
  const [editingWorkout, setEditingWorkout] = useState(null);
  const [editingHistory, setEditingHistory] = useState(null);
  const [loading, setLoading] = useState(true);
  const [darkMode, setDarkMode] = useState(true);
  const [showStats, setShowStats] = useState(false);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(null);
  const [showAddDay, setShowAddDay] = useState(false);
  const [showDeleteHistory, setShowDeleteHistory] = useState(null);
  const [showUploadModal, setShowUploadModal] = useState(false);
  const [parsedWorkouts, setParsedWorkouts] = useState([]);
  const [draggedExerciseIndex, setDraggedExerciseIndex] = useState(null);
  const [draggedExercisePosition, setDraggedExercisePosition] = useState({ x: 0, y: 0 });
  const [dragStartPosition, setDragStartPosition] = useState({ x: 0, y: 0 });
  const [isDraggingExercise, setIsDraggingExercise] = useState(false);
  const [dropTargetIndex, setDropTargetIndex] = useState(null);
  const [timelineRange, setTimelineRange] = useState('2weeks'); // '2weeks', '4weeks', '3months', '6months', 'all'
  const [selectedTimelinePoint, setSelectedTimelinePoint] = useState(null);
  const [showUpdateNotification, setShowUpdateNotification] = useState(false);
  const [substituteDropdown, setSubstituteDropdown] = useState(null); // exerciseIndex or null
  const [exerciseProgressModal, setExerciseProgressModal] = useState(null); // {exerciseName: string} or null
  const [showExerciseProgress, setShowExerciseProgress] = useState(false); // collapsible Exercise Progress section (default: hidden)
  const [showProgressTimeline, setShowProgressTimeline] = useState(false); // collapsible Progress Timeline (default: hidden)
  const [expandedWorkouts, setExpandedWorkouts] = useState({}); // {workoutId: boolean} - track which workout previews are expanded
  const [statsPeriod, setStatsPeriod] = useState('week'); // 'week', 'month', 'all' - period selector for stats
  const [bodyWeight, setBodyWeight] = useState(null); // Current body weight in kg
  const [gender, setGender] = useState('male'); // 'male' or 'female'
  const [showBodyWeightInput, setShowBodyWeightInput] = useState(false); // Show/hide body weight input field
  const [show1RMModal, setShow1RMModal] = useState(null); // {exerciseName: string, data: array} or null
  const fileInputRef = React.useRef(null);
  const restoreBackupInputRef = React.useRef(null);
  const dragExerciseRef = React.useRef(null);

  useEffect(() => {
    loadData();
    // Load theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      setDarkMode(savedTheme === 'dark');
    }

    // Play app launch sound after short delay
    setTimeout(() => {
      soundSystem.appLaunch();
    }, 500);

    // Listen for service worker updates
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'SW_UPDATED') {
          console.log('[App] New version available:', event.data.version);
          setShowUpdateNotification(true);
        }
      });

      // Check for waiting service worker on load
      navigator.serviceWorker.ready.then((registration) => {
        if (registration.waiting) {
          console.log('[App] Service worker is waiting');
          setShowUpdateNotification(true);
        }

        // Listen for new service worker installing
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('[App] New service worker installed');
              setShowUpdateNotification(true);
            }
          });
        });
      });
    }
  }, []);

  const handleUpdateApp = () => {
    setShowUpdateNotification(false);
    window.location.reload();
  };

  // Global drag event listeners
  useEffect(() => {
    const handleGlobalMouseMove = (e) => {
      if (draggedExerciseIndex !== null) {
        handleExerciseDragMove(e);
      }
    };

    const handleGlobalMouseUp = (e) => {
      if (draggedExerciseIndex !== null) {
        handleExerciseDragEnd();
      }
    };

    const handleGlobalTouchMove = (e) => {
      if (draggedExerciseIndex !== null) {
        handleExerciseDragMove(e);
      }
    };

    const handleGlobalTouchEnd = (e) => {
      if (draggedExerciseIndex !== null) {
        handleExerciseDragEnd();
      }
    };

    if (draggedExerciseIndex !== null) {
      document.addEventListener('mousemove', handleGlobalMouseMove);
      document.addEventListener('mouseup', handleGlobalMouseUp);
      document.addEventListener('touchmove', handleGlobalTouchMove, { passive: false });
      document.addEventListener('touchend', handleGlobalTouchEnd);
    }

    return () => {
      document.removeEventListener('mousemove', handleGlobalMouseMove);
      document.removeEventListener('mouseup', handleGlobalMouseUp);
      document.removeEventListener('touchmove', handleGlobalTouchMove);
      document.removeEventListener('touchend', handleGlobalTouchEnd);
    };
  }, [draggedExerciseIndex, dragStartPosition]);

  const loadData = async () => {
    try {
      setLoading(true);
      const savedWorkouts = await dbOperations.getWorkouts();
      const savedHistory = await dbOperations.getHistory();
      const latestBodyWeight = await dbOperations.getLatestBodyWeight();

      // Check if IndexedDB is empty but localStorage has backup
      const hasIndexedDBData = (savedWorkouts && savedWorkouts.length > 0) || (savedHistory && savedHistory.length > 0);
      const workoutsBackup = localStorage.getItem('workouts_backup');
      const historyBackup = localStorage.getItem('history_backup');
      const hasBackupData = workoutsBackup || historyBackup;

      if (!hasIndexedDBData && hasBackupData) {
        console.log('Restoring data from localStorage backup...');

        // Restore workouts
        if (workoutsBackup) {
          const parsedWorkouts = JSON.parse(workoutsBackup);
          await dbOperations.saveWorkouts(parsedWorkouts);
          setWorkouts(parsedWorkouts);
        }

        // Restore history
        if (historyBackup) {
          const parsedHistory = JSON.parse(historyBackup);
          for (const item of parsedHistory) {
            await dbOperations.saveHistory(item);
          }
          setCompletedWorkouts(parsedHistory);
        }

        console.log('Data restored successfully!');
      } else {
        // Normal load path
        if (savedWorkouts && savedWorkouts.length > 0) {
          setWorkouts(savedWorkouts);
          // Update backup
          localStorage.setItem('workouts_backup', JSON.stringify(savedWorkouts));
        } else {
          await dbOperations.saveWorkouts(workouts);
          localStorage.setItem('workouts_backup', JSON.stringify(workouts));
        }

        if (savedHistory && savedHistory.length > 0) {
          setCompletedWorkouts(savedHistory);
          // Update backup
          localStorage.setItem('history_backup', JSON.stringify(savedHistory));
        }
      }

      // Load body weight and gender (no backup needed - stored only in IndexedDB)
      if (latestBodyWeight) {
        setBodyWeight(latestBodyWeight.weight);
        if (latestBodyWeight.gender) {
          setGender(latestBodyWeight.gender);
        }
      }
    } catch (error) {
      console.error('Error loading data:', error);
    } finally {
      setLoading(false);
    }
  };

  const saveWorkouts = async (newWorkouts) => {
    try {
      await dbOperations.saveWorkouts(newWorkouts);
      setWorkouts(newWorkouts);
      // Auto-backup to localStorage
      localStorage.setItem('workouts_backup', JSON.stringify(newWorkouts));
    } catch (error) {
      console.error('Error saving workouts:', error);
    }
  };

  const saveHistory = async (newHistoryItem) => {
    try {
      await dbOperations.saveHistory(newHistoryItem);
      const allHistory = await dbOperations.getHistory();
      setCompletedWorkouts(allHistory);
      // Auto-backup to localStorage
      localStorage.setItem('history_backup', JSON.stringify(allHistory));
    } catch (error) {
      console.error('Error saving history:', error);
    }
  };

  const handleSaveBodyWeight = async (weight) => {
    try {
      await dbOperations.saveBodyWeight(weight, gender);
      setBodyWeight(Number(weight));
      setShowBodyWeightInput(false);
      soundSystem.saveSuccess();
    } catch (error) {
      console.error('Error saving body weight:', error);
    }
  };

  const getLastWeight = (exerciseName) => {
    for (let i = completedWorkouts.length - 1; i >= 0; i--) {
      const workout = completedWorkouts[i];
      const exercise = workout.exercises.find(ex => ex.name === exerciseName);
      if (exercise && exercise.sets.length > 0) {
        const lastSet = exercise.sets.find(s => s.weight);
        if (lastSet) return lastSet.weight;
      }
    }
    return '';
  };

  const calculateEstimated1RM = (weight, reps) => {
    // Epley formula: 1RM = weight Ã— (1 + reps / 30)
    return weight * (1 + reps / 30);
  };

  // Calculate estimated 1RM for all exercises in history
  const getAll1RMs = () => {
    const exerciseMaxes = {}; // { exerciseName: best1RM }

    completedWorkouts.forEach(workout => {
      workout.exercises.forEach(exercise => {
        const exerciseName = exercise.name;

        // Skip core exercises (no weight)
        const isCoreExercise = exerciseName.toLowerCase().includes('plank') ||
                               exerciseName.toLowerCase().includes('hanging') ||
                               exerciseName.toLowerCase().includes('rollout') ||
                               exerciseName.toLowerCase().includes('dead bug') ||
                               exerciseName.toLowerCase().includes('pallof');

        if (isCoreExercise) return;

        exercise.sets.forEach(set => {
          const weight = parseFloat(set.weight) || 0;
          const reps = parseFloat(set.reps) || 0;

          // Only use sets with weight and 12 or fewer reps (strength range)
          if (weight > 0 && reps > 0 && reps <= 12) {
            const estimated1RM = calculateEstimated1RM(weight, reps);

            // Track the best 1RM for this exercise
            if (!exerciseMaxes[exerciseName] || estimated1RM > exerciseMaxes[exerciseName]) {
              exerciseMaxes[exerciseName] = estimated1RM;
            }
          }
        });
      });
    });

    return exerciseMaxes;
  };

  // Get 1RMs for main compound lifts only
  const getMainLifts1RMs = () => {
    const all1RMs = getAll1RMs();
    const mainLifts = {
      'Bench Press': null,
      'Squat': null,
      'Deadlift': null,
      'Overhead Press': null
    };

    // Fuzzy matching: map exercise names to standard lift categories
    Object.keys(all1RMs).forEach(exerciseName => {
      const lowerName = exerciseName.toLowerCase();

      if (lowerName.includes('bench press') || lowerName.includes('bench')) {
        if (!mainLifts['Bench Press'] || all1RMs[exerciseName] > mainLifts['Bench Press']) {
          mainLifts['Bench Press'] = all1RMs[exerciseName];
        }
      } else if (lowerName.includes('squat') || lowerName.includes('ÄuÄanj')) {
        if (!mainLifts['Squat'] || all1RMs[exerciseName] > mainLifts['Squat']) {
          mainLifts['Squat'] = all1RMs[exerciseName];
        }
      } else if (lowerName.includes('deadlift') || lowerName.includes('mrtvo')) {
        if (!mainLifts['Deadlift'] || all1RMs[exerciseName] > mainLifts['Deadlift']) {
          mainLifts['Deadlift'] = all1RMs[exerciseName];
        }
      } else if (lowerName.includes('overhead press') || lowerName.includes('ohp') || lowerName.includes('press') && !lowerName.includes('bench')) {
        if (!mainLifts['Overhead Press'] || all1RMs[exerciseName] > mainLifts['Overhead Press']) {
          mainLifts['Overhead Press'] = all1RMs[exerciseName];
        }
      }
    });

    // Filter out null values
    const result = {};
    Object.keys(mainLifts).forEach(lift => {
      if (mainLifts[lift] !== null) {
        result[lift] = mainLifts[lift];
      }
    });

    return result;
  };

  // Get 1RM progression history for a specific exercise
  const get1RMProgression = (exerciseName) => {
    const progression = [];

    completedWorkouts.forEach(workout => {
      const exercise = workout.exercises.find(ex => ex.name === exerciseName);

      if (exercise) {
        let best1RMForWorkout = 0;

        exercise.sets.forEach(set => {
          const weight = parseFloat(set.weight) || 0;
          const reps = parseFloat(set.reps) || 0;

          if (weight > 0 && reps > 0 && reps <= 12) {
            const estimated1RM = calculateEstimated1RM(weight, reps);
            if (estimated1RM > best1RMForWorkout) {
              best1RMForWorkout = estimated1RM;
            }
          }
        });

        if (best1RMForWorkout > 0) {
          progression.push({
            date: workout.date,
            estimated1RM: best1RMForWorkout
          });
        }
      }
    });

    // Sort by date ascending and take last 20
    progression.sort((a, b) => new Date(a.date) - new Date(b.date));
    return progression.slice(-20);
  };

  // Get best actual set (weight Ã— reps) for main lifts with 1RM
  const getMainLiftsBestSets = () => {
    const all1RMs = getAll1RMs();
    const bestSets = {};

    completedWorkouts.forEach(workout => {
      workout.exercises.forEach(exercise => {
        const exerciseName = exercise.name;
        const lowerName = exerciseName.toLowerCase();

        // Determine which main lift category this exercise belongs to
        let category = null;
        if (lowerName.includes('bench press') || lowerName.includes('bench')) {
          category = 'Bench Press';
        } else if (lowerName.includes('squat')) {
          category = 'Squat';
        } else if (lowerName.includes('deadlift') || lowerName.includes('mrtvo')) {
          category = 'Deadlift';
        } else if (lowerName.includes('overhead press') || lowerName.includes('ohp') || (lowerName.includes('press') && !lowerName.includes('bench'))) {
          category = 'Overhead Press';
        }

        if (!category) return;

        exercise.sets.forEach(set => {
          const weight = parseFloat(set.weight) || 0;
          const reps = parseFloat(set.reps) || 0;

          if (weight > 0 && reps > 0 && reps <= 12) {
            const estimated1RM = calculateEstimated1RM(weight, reps);

            if (!bestSets[category] || estimated1RM > bestSets[category].estimated1RM) {
              bestSets[category] = {
                weight: weight,
                reps: reps,
                estimated1RM: estimated1RM,
                exerciseName: exerciseName
              };
            }
          }
        });
      });
    });

    return bestSets;
  };

  // Strength standards data (Symmetric Strength)
  // Multipliers are relative to bodyweight
  const STRENGTH_STANDARDS = {
    male: {
      'Squat': {
        levels: ['Untrained', 'Novice', 'Intermediate', 'Advanced', 'Elite'],
        multipliers: [0.6, 1.0, 1.5, 2.0, 2.5]
      },
      'Bench Press': {
        levels: ['Untrained', 'Novice', 'Intermediate', 'Advanced', 'Elite'],
        multipliers: [0.5, 0.75, 1.25, 1.75, 2.25]
      },
      'Deadlift': {
        levels: ['Untrained', 'Novice', 'Intermediate', 'Advanced', 'Elite'],
        multipliers: [0.7, 1.25, 1.75, 2.25, 2.75]
      },
      'Overhead Press': {
        levels: ['Untrained', 'Novice', 'Intermediate', 'Advanced', 'Elite'],
        multipliers: [0.35, 0.5, 0.85, 1.15, 1.5]
      }
    },
    female: {
      'Squat': {
        levels: ['Untrained', 'Novice', 'Intermediate', 'Advanced', 'Elite'],
        multipliers: [0.4, 0.65, 1.0, 1.5, 1.9]
      },
      'Bench Press': {
        levels: ['Untrained', 'Novice', 'Intermediate', 'Advanced', 'Elite'],
        multipliers: [0.3, 0.4, 0.65, 1.0, 1.3]
      },
      'Deadlift': {
        levels: ['Untrained', 'Novice', 'Intermediate', 'Advanced', 'Elite'],
        multipliers: [0.5, 0.8, 1.25, 1.75, 2.15]
      },
      'Overhead Press': {
        levels: ['Untrained', 'Novice', 'Intermediate', 'Advanced', 'Elite'],
        multipliers: [0.2, 0.3, 0.5, 0.75, 1.0]
      }
    }
  };

  // Calculate strength standard level for a given lift
  const getStrengthStandard = (liftName, estimated1RM, bodyWeightKg, userGender = 'male') => {
    if (!bodyWeightKg || bodyWeightKg <= 0 || !estimated1RM || estimated1RM <= 0) {
      return null;
    }

    const genderStandards = STRENGTH_STANDARDS[userGender] || STRENGTH_STANDARDS.male;
    const standard = genderStandards[liftName];
    if (!standard) {
      return null;
    }

    const ratio = estimated1RM / bodyWeightKg;
    const multipliers = standard.multipliers;
    const levels = standard.levels;

    // Find which level the ratio falls into
    let currentLevelIndex = 0;
    for (let i = 0; i < multipliers.length; i++) {
      if (ratio >= multipliers[i]) {
        currentLevelIndex = i;
      } else {
        break;
      }
    }

    const currentLevel = levels[currentLevelIndex];
    const nextLevelIndex = Math.min(currentLevelIndex + 1, levels.length - 1);
    const nextLevel = levels[nextLevelIndex];

    // Calculate percentage progress to next level
    let percentageToNext = 0;
    if (currentLevelIndex < levels.length - 1) {
      const currentThreshold = multipliers[currentLevelIndex];
      const nextThreshold = multipliers[nextLevelIndex];
      const progress = ratio - currentThreshold;
      const range = nextThreshold - currentThreshold;
      percentageToNext = Math.min(100, Math.round((progress / range) * 100));
    } else {
      // Already at max level
      percentageToNext = 100;
    }

    return {
      level: currentLevel,
      levelIndex: currentLevelIndex,
      nextLevel: nextLevel,
      percentageToNext: percentageToNext,
      ratio: ratio.toFixed(2),
      totalLevels: levels.length
    };
  };

  const getSmartWeightSuggestion = (exerciseName) => {
    // Find last workout with this exercise
    for (let i = completedWorkouts.length - 1; i >= 0; i--) {
      const workout = completedWorkouts[i];
      const exercise = workout.exercises.find(ex => ex.name === exerciseName);

      if (exercise && exercise.sets.length > 0) {
        // Find best set (highest estimated 1RM)
        let bestSet = null;
        let bestEstimated1RM = 0;

        exercise.sets.forEach(set => {
          const weight = parseFloat(set.weight) || 0;
          const reps = parseFloat(set.reps) || 0;

          if (weight > 0 && reps > 0) {
            const estimated1RM = calculateEstimated1RM(weight, reps);
            if (estimated1RM > bestEstimated1RM) {
              bestEstimated1RM = estimated1RM;
              bestSet = set;
            }
          }
        });

        if (bestSet) {
          const lastWeight = parseFloat(bestSet.weight);
          const difficulty = exercise.difficulty;

          // Smart progression based on difficulty
          if (difficulty === 'easy') {
            // Easy â†’ +2.5 kg
            return {
              weight: (lastWeight + 2.5).toFixed(1),
              reason: 'felt easy last time (+2.5 kg)'
            };
          } else if (difficulty === 'medium') {
            // Medium â†’ Keep same
            return {
              weight: lastWeight.toFixed(1),
              reason: 'good weight (same as last time)'
            };
          } else if (difficulty === 'hard') {
            // Hard â†’ Keep same
            return {
              weight: lastWeight.toFixed(1),
              reason: 'felt hard last time (repeat weight)'
            };
          } else {
            // No difficulty rating â†’ return last weight
            return {
              weight: lastWeight.toFixed(1),
              reason: 'based on last workout'
            };
          }
        }
      }
    }

    return null;
  };

  const startWorkout = (workout) => {
    soundSystem.workoutStart(); // Play sound

    const log = {
      workoutId: workout.id,
      workoutName: workout.name,
      workoutEmoji: workout.emoji,
      date: new Date().toISOString(),
      exercises: workout.exercises.map(ex => {
        const isCoreExercise = ex.name.toLowerCase().includes('core') ||
                               ex.name.toLowerCase().includes('plank') ||
                               ex.name.toLowerCase().includes('hanging') ||
                               ex.name.toLowerCase().includes('rollout');
        const lastWeight = isCoreExercise ? '0' : getLastWeight(ex.name);
        return {
          name: ex.name,
          plannedSets: ex.sets,
          plannedReps: ex.reps,
          difficulty: null, // User can optionally rate difficulty
          sets: Array(ex.sets).fill(null).map(() => ({
            weight: lastWeight,
            reps: ex.reps
          }))
        };
      })
    };
    setCurrentLog(log);
    setActiveView('logging');
  };

  const updateSet = (exerciseIndex, setIndex, field, value) => {
    const updated = { ...currentLog };

    // If updating weight, replace comma with dot for decimal support
    if (field === 'weight' && value) {
      value = value.replace(',', '.');
    }

    updated.exercises[exerciseIndex].sets[setIndex][field] = value;
    setCurrentLog(updated);
  };

  const updateExerciseName = (exerciseIndex, newName) => {
    const updated = { ...currentLog };
    updated.exercises[exerciseIndex].name = newName;
    setCurrentLog(updated);
  };

  const finishWorkout = async () => {
    soundSystem.workoutComplete(); // Play sound
    await saveHistory(currentLog);
    setCurrentLog(null);
    setActiveView('home');
  };

  const exportToCSV = () => {
    if (completedWorkouts.length === 0) {
      alert('No workout data to export yet!');
      return;
    }

    const headers = ['Date', 'Workout', 'Exercise', 'Set', 'Weight', 'Reps'];
    const rows = [headers];

    completedWorkouts.forEach(workout => {
      workout.exercises.forEach(exercise => {
        exercise.sets.forEach((set, idx) => {
          rows.push([
            new Date(workout.date).toLocaleDateString('hr-HR'),
            workout.workoutName,
            exercise.name,
            idx + 1,
            set.weight || '',
            set.reps || ''
          ]);
        });
      });
    });

    const csv = rows.map(row => row.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `workout-data-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const exportProgram = () => {
    if (workouts.length === 0) {
      alert('No workout program to export!');
      return;
    }

    // Generate markdown format
    let markdown = '# Workout Program\n\n';
    markdown += `Exported: ${new Date().toLocaleDateString('hr-HR')}\n\n`;
    markdown += '---\n\n';

    workouts.forEach(workout => {
      markdown += `# ${workout.name} ${workout.emoji}\n\n`;
      workout.exercises.forEach(exercise => {
        markdown += `## ${exercise.name}\n`;
        markdown += `Sets: ${exercise.sets}\n`;
        markdown += `Reps: ${exercise.reps}\n`;
        if (exercise.notes) {
          markdown += `Notes: ${exercise.notes}\n`;
        }
        markdown += '\n';
      });
      markdown += '---\n\n';
    });

    const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `workout-program-${new Date().toISOString().split('T')[0]}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const startEditWorkout = (workout) => {
    setEditingWorkout(JSON.parse(JSON.stringify(workout)));
    setActiveView('edit');
  };

  const updateExercise = (index, field, value) => {
    setEditingWorkout(prev => ({
      ...prev,
      exercises: prev.exercises.map((ex, idx) =>
        idx === index ? { ...ex, [field]: value } : ex
      )
    }));
  };

  const addExercise = () => {
    const updated = { ...editingWorkout };
    updated.exercises.push({ name: '', sets: 3, reps: 10, notes: '' });
    setEditingWorkout(updated);
  };

  const deleteExercise = (index) => {
    const updated = { ...editingWorkout };
    updated.exercises.splice(index, 1);
    setEditingWorkout(updated);
  };

  const moveExerciseUp = (index) => {
    if (index === 0) return; // Already at the top
    const updated = { ...editingWorkout };
    const temp = updated.exercises[index];
    updated.exercises[index] = updated.exercises[index - 1];
    updated.exercises[index - 1] = temp;
    setEditingWorkout(updated);
  };

  const moveExerciseDown = (index) => {
    const updated = { ...editingWorkout };
    if (index >= updated.exercises.length - 1) return; // Already at the bottom
    const temp = updated.exercises[index];
    updated.exercises[index] = updated.exercises[index + 1];
    updated.exercises[index + 1] = temp;
    setEditingWorkout(updated);
  };

  const reorderExercise = (fromIndex, toIndex) => {
    if (fromIndex === toIndex) return;

    const updated = { ...editingWorkout };
    const exercises = [...updated.exercises];
    const [movedExercise] = exercises.splice(fromIndex, 1);
    exercises.splice(toIndex, 0, movedExercise);
    updated.exercises = exercises;
    setEditingWorkout(updated);
  };

  const handleExerciseDragStart = (e, index) => {
    // Prevent default and stop propagation for touch events
    if (e.type === 'touchstart') {
      e.preventDefault();
    }
    e.stopPropagation();

    const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
    const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

    setDraggedExerciseIndex(index);
    setDragStartPosition({ x: clientX, y: clientY });
    setDraggedExercisePosition({ x: clientX, y: clientY });
    setIsDraggingExercise(false); // Not dragging until moved a bit
    soundSystem.buttonPress();
  };

  const handleExerciseDragMove = (e) => {
    if (draggedExerciseIndex === null) return;

    e.preventDefault();
    const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
    const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

    // Start dragging if moved more than 5px
    const distance = Math.sqrt(
      Math.pow(clientX - dragStartPosition.x, 2) +
      Math.pow(clientY - dragStartPosition.y, 2)
    );

    if (distance > 5) {
      setIsDraggingExercise(true);
    }

    setDraggedExercisePosition({ x: clientX, y: clientY });

    // Find which exercise we're hovering over
    const exerciseElements = document.querySelectorAll('[data-exercise-index]');
    let foundTarget = null;

    exerciseElements.forEach(el => {
      const rect = el.getBoundingClientRect();
      const elIndex = parseInt(el.dataset.exerciseIndex);

      if (elIndex !== draggedExerciseIndex &&
          clientY >= rect.top && clientY <= rect.bottom) {
        foundTarget = elIndex;
      }
    });

    setDropTargetIndex(foundTarget);
  };

  const handleExerciseDragEnd = () => {
    if (draggedExerciseIndex !== null && dropTargetIndex !== null && isDraggingExercise) {
      reorderExercise(draggedExerciseIndex, dropTargetIndex);
      soundSystem.setComplete();
    }

    setDraggedExerciseIndex(null);
    setIsDraggingExercise(false);
    setDropTargetIndex(null);
    setDraggedExercisePosition({ x: 0, y: 0 });
  };

  const saveEditedWorkout = async () => {
    const updatedWorkouts = workouts.map(w =>
      w.id === editingWorkout.id ? editingWorkout : w
    );
    await saveWorkouts(updatedWorkouts);
    setEditingWorkout(null);
    setActiveView('home');
  };

  const saveEditedHistory = async () => {
    const updatedHistory = completedWorkouts.map(w =>
      w.id === editingHistory.id ? editingHistory : w
    );
    setCompletedWorkouts(updatedHistory);
    await dbOperations.saveHistory(updatedHistory);
    setEditingHistory(null);
    setActiveView('history');
  };

  const updateHistorySet = (exIdx, setIdx, field, value) => {
    const updated = { ...editingHistory };
    updated.exercises[exIdx].sets[setIdx][field] = value;
    setEditingHistory(updated);
  };

  const toggleTheme = () => {
    const newMode = !darkMode;
    setDarkMode(newMode);
    localStorage.setItem('theme', newMode ? 'dark' : 'light');
  };

  const deleteWorkoutDay = async (workoutId) => {
    const updatedWorkouts = workouts.filter(w => w.id !== workoutId);
    await saveWorkouts(updatedWorkouts);
    setShowDeleteConfirm(null);
  };

  const addNewWorkoutDay = async () => {
    const newId = Math.max(...workouts.map(w => w.id), 0) + 1;
    const newWorkout = {
      id: newId,
      name: `Dan ${newId}: New Workout`,
      emoji: "ðŸ”¥",
      exercises: [
        { name: "New Exercise", sets: 3, reps: 10, notes: "" }
      ]
    };
    const updatedWorkouts = [...workouts, newWorkout];
    await saveWorkouts(updatedWorkouts);
    setShowAddDay(false);
    startEditWorkout(newWorkout);
  };

  const triggerFileUpload = () => {
    // Mobile-friendly file input trigger
    if (fileInputRef.current) {
      // Reset the input first to allow re-uploading the same file
      fileInputRef.current.value = '';

      // Use setTimeout to ensure the click happens in a fresh event loop
      // This helps with iOS Safari compatibility
      setTimeout(() => {
        fileInputRef.current?.click();
      }, 100);
    }
  };

  const handleFileChange = async (e) => {
    const file = e.target.files?.[0];
    if (!file) {
      console.log('No file selected');
      return;
    }

    console.log('File selected:', file.name, 'Size:', file.size, 'Type:', file.type);

    const fileName = file.name.toLowerCase();
    const isMarkdown = fileName.endsWith('.md');
    const isCSV = fileName.endsWith('.csv');
    const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');

    if (!isMarkdown && !isCSV && !isExcel) {
      alert('Please upload a markdown (.md), CSV (.csv), or Excel (.xlsx/.xls) file');
      e.target.value = '';
      return;
    }

    try {
      let parsed = [];

      if (isMarkdown) {
        const text = await file.text();
        console.log('Markdown text length:', text.length);
        console.log('First 200 chars:', text.substring(0, 200));
        parsed = parseMarkdownWorkout(text);
        console.log('Parsed workouts:', parsed.length, parsed);
      } else if (isCSV) {
        const text = await file.text();
        console.log('CSV text length:', text.length);
        parsed = parseCSVWorkout(text);
        console.log('Parsed workouts:', parsed.length, parsed);
      } else if (isExcel) {
        alert('Excel files (.xlsx/.xls) support coming soon! For now, please export to CSV and upload that file.');
        e.target.value = '';
        return;
      }

      if (parsed && parsed.length > 0) {
        console.log('Setting parsed workouts and showing modal');
        setParsedWorkouts(parsed);
        setShowUploadModal(true);
      } else {
        alert(`No valid workouts found in the file. Please check the format.\n\nFile: ${file.name}\nSize: ${file.size} bytes`);
      }
    } catch (error) {
      console.error('Error parsing file:', error);
      alert(`Failed to parse file: ${error.message}\n\nFile: ${file.name}\nPlease check the console for details.`);
    }

    // Reset input
    e.target.value = '';
  };

  const handleImportChoice = async (choice) => {
    let finalWorkouts;

    if (choice === 'replace') {
      // Replace all - reassign clean sequential IDs starting from 1
      finalWorkouts = parsedWorkouts.map((w, idx) => ({
        ...w,
        id: idx + 1
      }));
    } else {
      // Add to existing - ensure unique IDs
      const maxId = Math.max(...workouts.map(w => w.id), 0);
      const updatedParsed = parsedWorkouts.map((w, idx) => ({
        ...w,
        id: maxId + idx + 1
      }));
      finalWorkouts = [...workouts, ...updatedParsed];
    }

    await saveWorkouts(finalWorkouts);
    setShowUploadModal(false);
    setParsedWorkouts([]);
    alert(`Successfully imported ${parsedWorkouts.length} workout day(s)!`);
  };

  const deleteHistoryEntry = async (entryId) => {
    try {
      const db = await initDB();
      const tx = db.transaction('history', 'readwrite');
      const store = tx.objectStore('history');
      
      await store.delete(entryId);
      
      await new Promise((resolve, reject) => {
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
      
      // Reload history
      const allHistory = await dbOperations.getHistory();
      setCompletedWorkouts(allHistory);
      setShowDeleteHistory(null);
    } catch (error) {
      console.error('Error deleting history entry:', error);
    }
  };

  const getMuscleGroupSuggestions = (exerciseName) => {
    const normalizedName = exerciseName.toLowerCase().trim();

    // Find muscle group for current exercise
    let muscleGroup = null;
    for (const [group, exercises] of Object.entries(popularExercises)) {
      if (exercises.some(ex => ex.toLowerCase() === normalizedName)) {
        muscleGroup = group;
        break;
      }
    }

    // If not found in popular exercises, return empty array
    if (!muscleGroup) {
      return [];
    }

    // Return suggestions from same muscle group, excluding current exercise
    return popularExercises[muscleGroup]
      .filter(ex => ex.toLowerCase() !== normalizedName)
      .slice(0, 7); // Limit to 7 suggestions
  };

  const substituteExercise = (exerciseIndex, newExerciseName) => {
    const updated = { ...currentLog };
    updated.exercises[exerciseIndex].name = newExerciseName;
    setCurrentLog(updated);
    setSubstituteDropdown(null); // Close dropdown after selection
  };

  const exportBackupToFile = () => {
    const backupData = {
      workouts: workouts,
      history: completedWorkouts,
      exportDate: new Date().toISOString(),
      version: '1.0'
    };

    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `workout-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  const restoreBackupFromFile = (file) => {
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const backupData = JSON.parse(e.target.result);

        if (!backupData.workouts || !backupData.history) {
          alert('Invalid backup file format');
          return;
        }

        // Restore workouts
        await dbOperations.saveWorkouts(backupData.workouts);
        setWorkouts(backupData.workouts);
        localStorage.setItem('workouts_backup', JSON.stringify(backupData.workouts));

        // Restore history
        for (const item of backupData.history) {
          await dbOperations.saveHistory(item);
        }
        setCompletedWorkouts(backupData.history);
        localStorage.setItem('history_backup', JSON.stringify(backupData.history));

        alert('Backup restored successfully!');
      } catch (error) {
        console.error('Error restoring backup:', error);
        alert('Failed to restore backup. Please check the file.');
      }
    };
    reader.readAsText(file);
  };

  const getWeekStats = () => {
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const recentWorkouts = completedWorkouts.filter(w => new Date(w.date) >= weekAgo);

    let totalVolume = 0;
    let totalReps = 0;
    let coreSets = 0;
    let totalSets = 0;

    recentWorkouts.forEach(workout => {
      workout.exercises.forEach(exercise => {
        const isCoreExercise = exercise.name.toLowerCase().includes('core') ||
                               exercise.name.toLowerCase().includes('plank') ||
                               exercise.name.toLowerCase().includes('hanging') ||
                               exercise.name.toLowerCase().includes('rollout');

        const isBodyweightExercise = exercise.name.toLowerCase().includes('pull-up') ||
                                     exercise.name.toLowerCase().includes('dip') ||
                                     exercise.name.toLowerCase().includes('chin-up') ||
                                     exercise.name.toLowerCase().includes('push-up');

        exercise.sets.forEach(set => {
          const weight = parseFloat(set.weight) || 0;
          const reps = parseFloat(set.reps) || 0;

          // Skip sets with no data (skipped exercises)
          if (reps === 0) return;

          if (isCoreExercise && reps > 0) {
            // Core exercises count separately
            coreSets += 1;
          } else if (reps > 0) {
            // Count all exercises with reps (weighted or bodyweight)
            if (weight > 0) {
              totalVolume += weight * reps;
            }
            totalReps += reps;
            totalSets += 1;
          }
        });
      });
    });

    return {
      count: recentWorkouts.length,
      totalSets: totalSets,
      coreSets: coreSets,
      totalVolume: Math.round(totalVolume),
      totalReps: totalReps
    };
  };

  // Helper: Format relative date
  const getRelativeDate = (dateString) => {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffDays === 0) return 'today';
    if (diffDays === 1) return 'yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
    return date.toLocaleDateString('hr-HR');
  };

  const getDetailedStats = () => {
    const now = new Date();
    const thisWeekStart = new Date(now);
    thisWeekStart.setDate(now.getDate() - 7);
    const lastWeekStart = new Date(now);
    lastWeekStart.setDate(now.getDate() - 14);
    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    
    const calculatePeriodStats = (workouts) => {
      let volume = 0;
      let reps = 0;
      let sets = 0;
      let coreSets = 0;

      workouts.forEach(workout => {
        workout.exercises.forEach(exercise => {
          const isCoreExercise = exercise.name.toLowerCase().includes('core') ||
                                 exercise.name.toLowerCase().includes('plank') ||
                                 exercise.name.toLowerCase().includes('hanging') ||
                                 exercise.name.toLowerCase().includes('rollout');

          const isBodyweightExercise = exercise.name.toLowerCase().includes('pull-up') ||
                                       exercise.name.toLowerCase().includes('dip') ||
                                       exercise.name.toLowerCase().includes('chin-up') ||
                                       exercise.name.toLowerCase().includes('push-up');

          exercise.sets.forEach(set => {
            const weight = parseFloat(set.weight) || 0;
            const rep = parseFloat(set.reps) || 0;

            // Skip sets with no reps (skipped exercises)
            if (rep === 0) return;

            if (isCoreExercise && rep > 0) {
              // Core exercises counted separately
              coreSets += 1;
            } else if (rep > 0) {
              // Count all exercises with reps (weighted or bodyweight)
              if (weight > 0) {
                volume += weight * rep;
              }
              reps += rep;
              sets += 1;
            }
          });
        });
      });

      return { volume: Math.round(volume), reps, sets, coreSets, workouts: workouts.length };
    };
    
    const thisWeekWorkouts = completedWorkouts.filter(w => new Date(w.date) >= thisWeekStart);
    const lastWeekWorkouts = completedWorkouts.filter(w => 
      new Date(w.date) >= lastWeekStart && new Date(w.date) < thisWeekStart
    );
    const thisMonthWorkouts = completedWorkouts.filter(w => new Date(w.date) >= thisMonthStart);
    const lastMonthWorkouts = completedWorkouts.filter(w => 
      new Date(w.date) >= lastMonthStart && new Date(w.date) < thisMonthStart
    );
    
    const thisWeek = calculatePeriodStats(thisWeekWorkouts);
    const lastWeek = calculatePeriodStats(lastWeekWorkouts);
    const thisMonth = calculatePeriodStats(thisMonthWorkouts);
    const lastMonth = calculatePeriodStats(lastMonthWorkouts);
    
    const volumeChange = lastWeek.volume > 0 
      ? Math.round(((thisWeek.volume - lastWeek.volume) / lastWeek.volume) * 100) 
      : 0;
    
    const monthVolumeChange = lastMonth.volume > 0
      ? Math.round(((thisMonth.volume - lastMonth.volume) / lastMonth.volume) * 100)
      : 0;
    
    // Personal records - only track main lifts
    const mainLiftsForPRs = {
      'Mrtvo dizanje (Trap Bar)': null,
      'Squat': null,
      'Bench Press': null,
      'Overhead Press (vojniÄki press)': null,
      'Lat Pulldown (ili zgibovi)': null
    };
    
    completedWorkouts.forEach(workout => {
      workout.exercises.forEach(exercise => {
        exercise.sets.forEach(set => {
          const weight = parseFloat(set.weight) || 0;
          if (weight > 0) {
            // Check for Deadlift
            if (exercise.name.includes('Mrtvo dizanje')) {
              if (!mainLiftsForPRs['Mrtvo dizanje (Trap Bar)'] || weight > mainLiftsForPRs['Mrtvo dizanje (Trap Bar)']) {
                mainLiftsForPRs['Mrtvo dizanje (Trap Bar)'] = weight;
              }
            }
            // Check for Squat (Front or Back)
            else if (exercise.name.includes('ÄŒuÄanj')) {
              if (!mainLiftsForPRs['Squat'] || weight > mainLiftsForPRs['Squat']) {
                mainLiftsForPRs['Squat'] = weight;
              }
            }
            // Check for Bench Press (regular or Incline)
            else if (exercise.name.includes('Bench Press')) {
              if (!mainLiftsForPRs['Bench Press'] || weight > mainLiftsForPRs['Bench Press']) {
                mainLiftsForPRs['Bench Press'] = weight;
              }
            }
            // Check for Overhead Press
            else if (exercise.name.includes('Overhead Press')) {
              if (!mainLiftsForPRs['Overhead Press (vojniÄki press)'] || weight > mainLiftsForPRs['Overhead Press (vojniÄki press)']) {
                mainLiftsForPRs['Overhead Press (vojniÄki press)'] = weight;
              }
            }
            // Check for Lat Pulldown or Pull-ups
            else if (exercise.name.includes('Lat Pulldown') || exercise.name.includes('Zgibovi')) {
              if (!mainLiftsForPRs['Lat Pulldown (ili zgibovi)'] || weight > mainLiftsForPRs['Lat Pulldown (ili zgibovi)']) {
                mainLiftsForPRs['Lat Pulldown (ili zgibovi)'] = weight;
              }
            }
          }
        });
      });
    });
    
    // Filter out lifts with no data
    const exerciseMaxes = {};
    Object.entries(mainLiftsForPRs).forEach(([lift, weight]) => {
      if (weight !== null) {
        exerciseMaxes[lift] = weight;
      }
    });
    
    // Average per workout
    const avgVolumePerWorkout = thisWeek.workouts > 0 
      ? Math.round(thisWeek.volume / thisWeek.workouts) 
      : 0;
    
    // Calculate all-time stats
    let allTimeVolume = 0;
    let allTimeReps = 0;
    let allTimeCoreSets = 0;
    completedWorkouts.forEach(workout => {
      workout.exercises.forEach(exercise => {
        const isCoreExercise = exercise.name.toLowerCase().includes('core') ||
                               exercise.name.toLowerCase().includes('plank') ||
                               exercise.name.toLowerCase().includes('hanging') ||
                               exercise.name.toLowerCase().includes('rollout');

        exercise.sets.forEach(set => {
          const weight = parseFloat(set.weight) || 0;
          const rep = parseFloat(set.reps) || 0;

          if (!isCoreExercise && weight > 0 && rep > 0) {
            allTimeVolume += weight * rep;
            allTimeReps += rep;
          }

          if (isCoreExercise && rep > 0) {
            allTimeCoreSets++;
          }
        });
      });
    });
    
    // Calculate average workouts per week
    let avgWorkoutsPerWeek = 0;
    if (completedWorkouts.length > 0) {
      // Sort workouts by date to find the earliest one
      const sortedWorkouts = [...completedWorkouts].sort((a, b) => new Date(a.date) - new Date(b.date));
      const firstWorkoutDate = new Date(sortedWorkouts[0].date);
      const lastWorkoutDate = new Date(sortedWorkouts[sortedWorkouts.length - 1].date);
      
      const daysBetween = (lastWorkoutDate - firstWorkoutDate) / (1000 * 60 * 60 * 24);
      const weeksBetween = daysBetween / 7;
      
      // If less than a week of data, use current week calculation
      if (weeksBetween < 1) {
        avgWorkoutsPerWeek = completedWorkouts.length;
      } else {
        avgWorkoutsPerWeek = Math.round((completedWorkouts.length / weeksBetween) * 10) / 10;
      }
    }
    
    return {
      thisWeek,
      lastWeek,
      thisMonth,
      lastMonth,
      volumeChange,
      monthVolumeChange,
      exerciseMaxes,
      avgVolumePerWorkout,
      totalWorkouts: completedWorkouts.length,
      allTimeVolume: Math.round(allTimeVolume),
      allTimeReps,
      allTimeCoreSets,
      avgWorkoutsPerWeek
    };
  };

  const getTimelineData = () => {
    if (completedWorkouts.length === 0) return [];

    const now = new Date();
    let startDate;

    // Determine date range based on timelineRange (always use daily grouping)
    switch (timelineRange) {
      case '2weeks':
        startDate = new Date(now);
        startDate.setDate(now.getDate() - 14);
        break;
      case '4weeks':
        startDate = new Date(now);
        startDate.setDate(now.getDate() - 28);
        break;
      case '3months':
        startDate = new Date(now);
        startDate.setMonth(now.getMonth() - 3);
        break;
      case '6months':
        startDate = new Date(now);
        startDate.setMonth(now.getMonth() - 6);
        break;
      case 'all':
        const sortedWorkouts = [...completedWorkouts].sort((a, b) => new Date(a.date) - new Date(b.date));
        startDate = new Date(sortedWorkouts[0].date);
        break;
    }

    // Group workouts by day (always daily)
    const grouped = {};

    completedWorkouts.forEach(workout => {
      const workoutDate = new Date(workout.date);
      if (workoutDate < startDate) return;

      // Always group by day
      const dayStart = new Date(workoutDate);
      dayStart.setHours(0, 0, 0, 0);
      const key = dayStart.toISOString().split('T')[0];

      if (!grouped[key]) {
        grouped[key] = {
          date: key,
          workouts: [],
          volume: 0,
          reps: 0,
          mainLifts: {
            deadlift: [],
            squat: [],
            bench: [],
            ohp: []
          }
        };
      }

      grouped[key].workouts.push(workout);

      // Calculate volume, reps, and track main lifts
      workout.exercises.forEach(exercise => {
        const isCoreExercise = exercise.name.toLowerCase().includes('core') ||
                               exercise.name.toLowerCase().includes('plank') ||
                               exercise.name.toLowerCase().includes('hanging') ||
                               exercise.name.toLowerCase().includes('rollout');

        const isBodyweightExercise = exercise.name.toLowerCase().includes('pull-up') ||
                                     exercise.name.toLowerCase().includes('dip') ||
                                     exercise.name.toLowerCase().includes('chin-up') ||
                                     exercise.name.toLowerCase().includes('push-up');

        exercise.sets.forEach(set => {
          const weight = parseFloat(set.weight) || 0;
          const reps = parseFloat(set.reps) || 0;

          if (reps === 0) return; // Skip empty sets

          // Count reps for all exercises (core, bodyweight, weighted)
          grouped[key].reps += reps;

          // Count volume only for weighted exercises
          if (!isCoreExercise && weight > 0 && reps > 0) {
            grouped[key].volume += weight * reps;
          }

          // Track main lifts
          if (weight > 0) {
            if (exercise.name.toLowerCase().includes('deadlift') || exercise.name.toLowerCase().includes('mrtvo')) {
              grouped[key].mainLifts.deadlift.push(weight);
            } else if (exercise.name.toLowerCase().includes('squat') || exercise.name.toLowerCase().includes('ÄuÄanj')) {
              grouped[key].mainLifts.squat.push(weight);
            } else if (exercise.name.toLowerCase().includes('bench press')) {
              grouped[key].mainLifts.bench.push(weight);
            } else if (exercise.name.toLowerCase().includes('overhead press') || exercise.name.toLowerCase().includes('ohp')) {
              grouped[key].mainLifts.ohp.push(weight);
            }
          }
        });
      });
    });

    // Get max weight for each main lift (after processing all workouts)
    Object.keys(grouped).forEach(key => {
      Object.keys(grouped[key].mainLifts).forEach(lift => {
        if (grouped[key].mainLifts[lift].length > 0) {
          grouped[key].mainLifts[lift] = Math.max(...grouped[key].mainLifts[lift]);
        } else {
          grouped[key].mainLifts[lift] = null;
        }
      });
    });

    // Convert to array and sort by date
    const timelineData = Object.values(grouped).sort((a, b) => new Date(a.date) - new Date(b.date));

    // Round volume
    timelineData.forEach(point => {
      point.volume = Math.round(point.volume);
    });

    return timelineData;
  };

  const getExerciseProgress = (exerciseName) => {
    const normalizedInput = exerciseName.toLowerCase().trim();
    const progressData = [];

    completedWorkouts.forEach(workout => {
      workout.exercises.forEach(exercise => {
        // Fuzzy match: check if input is in exercise name or vice versa
        const exerciseNameLower = exercise.name.toLowerCase();
        const isMatch = exerciseNameLower.includes(normalizedInput) ||
                       normalizedInput.includes(exerciseNameLower);

        if (isMatch) {
          // Check if core exercise
          const isCoreExercise = exerciseNameLower.includes('core') ||
                                exerciseNameLower.includes('plank') ||
                                exerciseNameLower.includes('hanging') ||
                                exerciseNameLower.includes('rollout');

          exercise.sets.forEach(set => {
            const weight = parseFloat(set.weight) || 0;
            const reps = parseFloat(set.reps) || 0;

            // Skip empty sets
            if (weight === 0 && reps === 0) return;

            // For core exercises, only track reps and volume
            if (isCoreExercise && reps > 0) {
              progressData.push({
                date: workout.date,
                weight: 0,
                reps: reps,
                volume: 0 // No volume for core
              });
            } else if (weight > 0 && reps > 0) {
              progressData.push({
                date: workout.date,
                weight: weight,
                reps: reps,
                volume: weight * reps
              });
            }
          });
        }
      });
    });

    // Sort by date
    return progressData.sort((a, b) => new Date(a.date) - new Date(b.date));
  };

  const getMostTrainedExercises = () => {
    const exerciseFrequency = {};

    completedWorkouts.forEach(workout => {
      workout.exercises.forEach(exercise => {
        const name = exercise.name;
        if (!exerciseFrequency[name]) {
          exerciseFrequency[name] = 0;
        }
        exerciseFrequency[name] += 1;
      });
    });

    // Convert to array and sort by frequency
    return Object.entries(exerciseFrequency)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10) // Top 10
      .map(([name, count]) => ({ name, count }));
  };

  if (loading) {
    return (
      <div className={`min-h-screen ${darkMode ? 'bg-gray-950' : 'bg-gray-100'} flex items-center justify-center`}>
        <div className="flex flex-col items-center gap-6">
          <Dumbbell size={120} className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} animate-pulse`} />
          <div className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Workout Pro</div>
        </div>
      </div>
    );
  }

  const stats = getWeekStats();
  let detailedStats;
  try {
    detailedStats = getDetailedStats();
  } catch (error) {
    console.error('Error calculating detailed stats:', error);
    detailedStats = {
      thisWeek: { volume: 0, reps: 0, sets: 0, coreSets: 0, workouts: 0 },
      lastWeek: { volume: 0, reps: 0, sets: 0, coreSets: 0, workouts: 0 },
      thisMonth: { volume: 0, reps: 0, sets: 0, coreSets: 0, workouts: 0 },
      lastMonth: { volume: 0, reps: 0, sets: 0, coreSets: 0, workouts: 0 },
      volumeChange: 0,
      monthVolumeChange: 0,
      exerciseMaxes: {},
      avgVolumePerWorkout: 0,
      totalWorkouts: 0,
      allTimeVolume: 0,
      allTimeReps: 0,
      allTimeCoreSets: 0,
      avgWorkoutsPerWeek: 0
    };
  }

  return (
    <div className={`min-h-screen ${darkMode ? 'bg-gray-950' : 'bg-gray-100'} pb-24`}>
      {/* Update Notification Banner */}
      {showUpdateNotification && (
        <div className="fixed top-0 left-0 right-0 z-50 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-3 shadow-lg">
          <div className="max-w-6xl mx-auto flex items-center justify-between gap-3">
            <div className="flex items-center gap-2">
              <svg className="w-5 h-5 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
              <span className="font-semibold text-sm">New version available!</span>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => setShowUpdateNotification(false)}
                className="px-3 py-1 text-sm bg-white/20 hover:bg-white/30 rounded-lg transition-colors"
              >
                Later
              </button>
              <button
                onClick={handleUpdateApp}
                className="px-3 py-1 text-sm bg-white text-blue-600 hover:bg-blue-50 rounded-lg font-semibold transition-colors"
              >
                Update Now
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Header */}
      <div className={`sticky ${showUpdateNotification ? 'top-[52px]' : 'top-0'} z-10 ${darkMode ? 'bg-gray-900/95' : 'bg-white/95'} ${darkMode ? 'border-gray-800' : 'border-gray-200'} border-b transform-gpu transition-all duration-300`}>
        <div className="max-w-6xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Dumbbell className={darkMode ? 'text-gray-400' : 'text-gray-600'} size={28} />
              <h1 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Workout Pro</h1>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={toggleTheme}
                className={`p-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg transition-colors`}
              >
                {darkMode ? <Sun size={20} className="text-gray-300" /> : <Moon size={20} className="text-gray-700" />}
              </button>
              {activeView === 'history' && (
                <button
                  onClick={exportToCSV}
                  disabled={completedWorkouts.length === 0}
                  className={`p-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg disabled:opacity-50`}
                >
                  <Download size={20} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                </button>
              )}
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-4 py-6">
        {activeView === 'home' && (
          <div className="space-y-6">
            {/* Stats Cards */}
            <div className="grid grid-cols-2 gap-4">
              <div className={`${darkMode ? 'bg-gradient-to-br from-gray-800 to-gray-700 border-gray-700' : 'bg-gradient-to-br from-gray-50 to-white border-gray-200'} rounded-2xl p-4 shadow-md border transform-gpu`}>
                <div className="flex items-center gap-2 mb-2">
                  <TrendingUp size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                  <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm font-medium`}>This Week</span>
                </div>
                <div className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{stats.count}</div>
                <div className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm`}>Workouts</div>
              </div>
              
              <div className={`${darkMode ? 'bg-gradient-to-br from-gray-800 to-gray-700 border-gray-700' : 'bg-gradient-to-br from-gray-50 to-white border-gray-200'} rounded-2xl p-4 shadow-md border transform-gpu`}>
                <div className="flex items-center gap-2 mb-2">
                  <Zap size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                  <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm font-medium`}>Volume</span>
                </div>
                <div className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{(stats.totalVolume / 1000).toFixed(1)}k</div>
                <div className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm`}>kg lifted</div>
              </div>

              <div className={`${darkMode ? 'bg-gradient-to-br from-gray-800 to-gray-700 border-gray-700' : 'bg-gradient-to-br from-gray-50 to-white border-gray-200'} rounded-2xl p-4 shadow-md border transform-gpu`}>
                <div className="flex items-center gap-2 mb-2">
                  <Dumbbell size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                  <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm font-medium`}>Total Reps</span>
                </div>
                <div className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{stats.totalReps}</div>
                <div className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm`}>{stats.totalSets} sets</div>
              </div>

              <div className={`${darkMode ? 'bg-gradient-to-br from-gray-800 to-gray-700 border-gray-700' : 'bg-gradient-to-br from-gray-50 to-white border-gray-200'} rounded-2xl p-4 shadow-md border transform-gpu`}>
                <div className="flex items-center gap-2 mb-2">
                  <Target size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                  <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm font-medium`}>Core Work</span>
                </div>
                <div className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{stats.coreSets}</div>
                <div className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm`}>sets completed</div>
              </div>
            </div>

            {/* View Detailed Stats Button */}
            <button
              onClick={() => setActiveView('stats')}
              className={`w-full ${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-4 flex items-center justify-between hover:scale-[1.02] transition-all`}
            >
              <div className="flex items-center gap-3">
                <BarChart3 size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                <div className="text-left">
                  <div className={`font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Detailed Statistics</div>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Progress tracking & PRs</div>
                </div>
              </div>
              <ChevronRight size={20} className={darkMode ? 'text-gray-500' : 'text-gray-400'} />
            </button>

            {/* Workouts */}
            <div>
              <h2 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-3`}>
                Your Program
              </h2>

              <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                {/* Mobile-friendly file upload using label */}
                <label
                  htmlFor="workout-file-input"
                  className={`px-4 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-lg flex items-center gap-2 font-semibold transition-colors cursor-pointer active:scale-95 touch-manipulation whitespace-nowrap`}
                >
                  <Download size={18} />
                  Import
                </label>
                <button
                  onClick={exportProgram}
                  className={`px-4 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-lg flex items-center gap-2 font-semibold transition-colors active:scale-95 touch-manipulation whitespace-nowrap`}
                >
                  <Upload size={18} />
                  Export
                </button>
                <button
                  onClick={() => setShowAddDay(true)}
                  className={`px-4 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-lg flex items-center gap-2 font-semibold transition-colors whitespace-nowrap`}
                >
                  <PlusCircle size={18} />
                  Add Day
                </button>
              </div>

              {/* Backup/Restore Section */}
              <div className={`${darkMode ? 'bg-gray-800/30 border-gray-700' : 'bg-blue-50 border-blue-200'} border rounded-xl p-4 mt-4`}>
                <div className={`flex items-center gap-2 mb-3`}>
                  <div className={`text-sm font-semibold ${darkMode ? 'text-blue-400' : 'text-blue-700'}`}>
                    Data Protection
                  </div>
                </div>
                <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-3`}>
                  Your data is auto-backed up to browser storage. Download a backup file for extra safety.
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={exportBackupToFile}
                    className={`flex-1 px-3 py-2 ${darkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-600 hover:bg-blue-700'} text-white rounded-lg flex items-center justify-center gap-2 font-semibold transition-colors text-sm`}
                  >
                    <Download size={16} />
                    Backup to File
                  </button>
                  <label
                    htmlFor="restore-backup-input"
                    className={`flex-1 px-3 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-300 hover:bg-gray-400'} text-white rounded-lg flex items-center justify-center gap-2 font-semibold transition-colors cursor-pointer text-sm`}
                  >
                    <Upload size={16} />
                    Restore
                  </label>
                </div>
              </div>

              {/* Mobile-friendly file input using both hidden input and id-based label */}
              <input
                id="workout-file-input"
                ref={fileInputRef}
                type="file"
                accept="*/*"
                onChange={handleFileChange}
                style={{display: 'none'}}
              />
              <input
                id="restore-backup-input"
                ref={restoreBackupInputRef}
                type="file"
                accept=".json,application/json"
                onChange={(e) => {
                  if (e.target.files && e.target.files[0]) {
                    restoreBackupFromFile(e.target.files[0]);
                  }
                  e.target.value = ''; // Reset input
                }}
                style={{display: 'none'}}
              />
              <div className="grid gap-4">
                {workouts.map(workout => (
                  <div
                    key={workout.id}
                    className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5 shadow-lg transform-gpu`}
                  >
                    <div className="flex items-start justify-between mb-4">
                      <button
                        onClick={() => setExpandedWorkouts(prev => ({...prev, [workout.id]: !prev[workout.id]}))}
                        className="flex items-center gap-3 flex-1 text-left"
                      >
                        <WorkoutIcon emoji={workout.emoji} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                        <div className="flex-1">
                          <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{workout.name}</h3>
                          <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{workout.exercises.length} exercises</div>
                        </div>
                        {expandedWorkouts[workout.id] ? (
                          <ChevronUp size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                        ) : (
                          <ChevronDown size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                        )}
                      </button>
                      <div className="flex gap-2 ml-2">
                        <button
                          onClick={() => startEditWorkout(workout)}
                          className={`p-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg transition-colors`}
                        >
                          <Edit2 size={16} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                        </button>
                        <button
                          onClick={() => setShowDeleteConfirm(workout.id)}
                          className="p-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors"
                        >
                          <Trash2 size={16} className="text-white" />
                        </button>
                      </div>
                    </div>

                    {expandedWorkouts[workout.id] && (
                      <div className={`mb-4 space-y-2 ${darkMode ? 'bg-gray-900/50' : 'bg-gray-50'} rounded-xl p-4`}>
                        {workout.exercises.map((exercise, idx) => (
                          <div key={idx} className={`flex items-center justify-between py-2 ${idx !== workout.exercises.length - 1 ? 'border-b ' + (darkMode ? 'border-gray-700' : 'border-gray-200') : ''}`}>
                            <div className={`text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                              {exercise.name}
                            </div>
                            <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                              {exercise.sets} Ã— {exercise.reps}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}

                    <button
                      onClick={() => startWorkout(workout)}
                      className={`w-full ${darkMode ? 'bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500' : 'bg-gradient-to-r from-gray-800 to-gray-700 hover:from-gray-700 hover:to-gray-600'} text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg`}
                    >
                      Start Workout
                      <ChevronRight size={20} />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {activeView === 'stats' && (
          <div className="space-y-4">
            <div className="flex items-center justify-between mb-4">
              <h2 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} flex items-center gap-2`}>
                <BarChart3 size={24} />
                Statistics
              </h2>
              <button
                onClick={() => setActiveView('home')}
                className={`p-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg`}
              >
                <X size={20} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
              </button>
            </div>

            {/* Body Weight Tracker */}
            <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5`}>
              <div className="flex items-center justify-between mb-3">
                <h3 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'}`}>Body Weight</h3>
                {bodyWeight && !showBodyWeightInput && (
                  <button
                    onClick={() => setShowBodyWeightInput(true)}
                    className={`px-3 py-1 rounded-lg text-sm font-medium ${
                      darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'
                    }`}
                  >
                    Update
                  </button>
                )}
              </div>

              {bodyWeight && !showBodyWeightInput ? (
                <div>
                  <div className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-1`}>
                    {bodyWeight} kg
                  </div>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    {gender === 'male' ? 'â™‚ Male' : 'â™€ Female'} Â· Last updated {getRelativeDate(new Date().toISOString())}
                  </div>
                </div>
              ) : (
                <div>
                  {!bodyWeight && (
                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-3`}>
                      Add your body weight and gender to see strength standards and track progress
                    </p>
                  )}
                  <div className="space-y-3">
                    <div className="flex gap-2">
                      <input
                        type="number"
                        step="0.1"
                        placeholder="Enter weight (kg)"
                        defaultValue={bodyWeight || ''}
                        className={`flex-1 px-3 py-2 rounded-lg ${
                          darkMode
                            ? 'bg-gray-700 text-white placeholder-gray-400'
                            : 'bg-gray-100 text-gray-900 placeholder-gray-500'
                        }`}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') {
                            const value = e.target.value;
                            if (value && Number(value) > 0) {
                              handleSaveBodyWeight(value);
                            }
                          }
                        }}
                        id="bodyWeightInput"
                      />
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setGender('male')}
                        className={`flex-1 px-3 py-2 rounded-lg font-medium transition-colors ${
                          gender === 'male'
                            ? darkMode
                              ? 'bg-blue-600 text-white'
                              : 'bg-blue-500 text-white'
                            : darkMode
                            ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        â™‚ Male
                      </button>
                      <button
                        onClick={() => setGender('female')}
                        className={`flex-1 px-3 py-2 rounded-lg font-medium transition-colors ${
                          gender === 'female'
                            ? darkMode
                              ? 'bg-blue-600 text-white'
                              : 'bg-blue-500 text-white'
                            : darkMode
                            ? 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                      >
                        â™€ Female
                      </button>
                    </div>
                    <button
                      onClick={() => {
                        const input = document.getElementById('bodyWeightInput');
                        if (input && input.value && Number(input.value) > 0) {
                          handleSaveBodyWeight(input.value);
                        }
                      }}
                      className={`w-full px-4 py-2 rounded-lg font-medium ${
                        darkMode ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-blue-500 hover:bg-blue-600 text-white'
                      }`}
                    >
                      Save
                    </button>
                    {bodyWeight && (
                      <button
                        onClick={() => setShowBodyWeightInput(false)}
                        className={`px-4 py-2 rounded-lg font-medium ${
                          darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-300' : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                        }`}
                      >
                        Cancel
                      </button>
                    )}
                  </div>
                </div>
              )}
            </div>

            {/* Performance Overview */}
            <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5`}>
              <h3 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} mb-4`}>Performance Overview</h3>

              {/* Period Selector */}
              <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                {[
                  { value: 'week', label: 'This Week' },
                  { value: 'month', label: 'This Month' },
                  { value: 'all', label: 'All Time' }
                ].map(period => (
                  <button
                    key={period.value}
                    onClick={() => setStatsPeriod(period.value)}
                    className={`px-4 py-2 rounded-lg whitespace-nowrap font-medium transition-all touch-manipulation ${
                      statsPeriod === period.value
                        ? darkMode
                          ? 'bg-blue-600 text-white'
                          : 'bg-blue-500 text-white'
                        : darkMode
                          ? 'bg-gray-700 hover:bg-gray-600 text-gray-300'
                          : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                    }`}
                  >
                    {period.label}
                  </button>
                ))}
              </div>

              {/* Dynamic Stats Display */}
              {(() => {
                const periodData = statsPeriod === 'week'
                  ? detailedStats.thisWeek
                  : statsPeriod === 'month'
                  ? detailedStats.thisMonth
                  : { volume: detailedStats.allTimeVolume, workouts: detailedStats.totalWorkouts, reps: detailedStats.allTimeReps, sets: 0, coreSets: detailedStats.allTimeCoreSets };

                const volumeChange = statsPeriod === 'week' ? detailedStats.volumeChange : statsPeriod === 'month' ? detailedStats.monthVolumeChange : 0;

                return (
                  <>
                    <div className="grid grid-cols-2 gap-4 mb-4">
                      <div>
                        <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>
                          {statsPeriod === 'all' ? 'Total Workouts' : 'Workouts'}
                        </div>
                        <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                          {periodData.workouts || detailedStats.thisWeek.count}
                        </div>
                        {statsPeriod === 'all' && (
                          <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            {detailedStats.avgWorkoutsPerWeek} avg/week
                          </div>
                        )}
                      </div>

                      <div>
                        <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Volume</div>
                        <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                          {(periodData.volume / 1000).toFixed(1)}k kg
                        </div>
                        {statsPeriod === 'week' && (
                          <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                            {(detailedStats.avgVolumePerWorkout / 1000).toFixed(1)}k avg/workout
                          </div>
                        )}
                        {volumeChange !== 0 && statsPeriod !== 'all' && statsPeriod !== 'week' && (
                          <div className={`text-sm ${volumeChange > 0 ? 'text-green-500' : 'text-red-500'}`}>
                            {volumeChange > 0 ? 'â†‘' : 'â†“'} {Math.abs(volumeChange)}% vs last {statsPeriod}
                          </div>
                        )}
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3`}>
                        <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Total Reps</div>
                        <div className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                          {periodData.reps}
                        </div>
                        {statsPeriod !== 'all' && (
                          <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                            {periodData.sets} weighted sets
                          </div>
                        )}
                      </div>

                      <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3`}>
                        <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Core Sets</div>
                        <div className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                          {periodData.coreSets}
                        </div>
                      </div>
                    </div>
                  </>
                );
              })()}
            </div>

            {/* Personal Records (Main Lifts) */}
            {(() => {
              const bestSets = getMainLiftsBestSets();
              const hasLifts = Object.keys(bestSets).length > 0;

              return (
                <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5`}>
                  <h3 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} mb-2 flex items-center gap-2`}>
                    <Award size={20} />
                    Personal Records (Main Lifts)
                  </h3>
                  <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>
                    Your best lifts and estimated 1RM (Epley formula). Tap to view progression.
                  </div>

                  {!hasLifts ? (
                    <div className={`text-center py-4 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      No records yet. Complete workouts to see your PRs!
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {Object.keys(bestSets).map(liftName => {
                        const bestSet = bestSets[liftName];

                        return (
                          <button
                            key={liftName}
                            onClick={() => {
                              const progression = get1RMProgression(bestSet.exerciseName);
                              if (progression.length > 0) {
                                setShow1RMModal({ exerciseName: liftName, data: progression });
                              }
                            }}
                            className={`w-full flex flex-col p-3 ${darkMode ? 'bg-gray-900 hover:bg-gray-800' : 'bg-gray-50 hover:bg-gray-100'} rounded-lg transition-colors text-left`}
                          >
                            <div className="flex justify-between items-center mb-1">
                              <div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                {liftName}
                              </div>
                              <ChevronRight size={16} className={darkMode ? 'text-gray-500' : 'text-gray-400'} />
                            </div>
                            <div className="flex justify-between items-baseline">
                              <div className={`text-lg font-bold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                                {bestSet.weight} kg Ã— {bestSet.reps} reps
                              </div>
                              <div className={`text-sm ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                                ~{bestSet.estimated1RM.toFixed(1)} kg (1RM)
                              </div>
                            </div>
                          </button>
                        );
                      })}
                    </div>
                  )}
                </div>
              );
            })()}

            {/* Strength Standards */}
            {(() => {
              const mainLifts1RMs = getMainLifts1RMs();
              const hasLifts = Object.keys(mainLifts1RMs).length > 0;
              const hasBodyWeight = bodyWeight && bodyWeight > 0;

              if (!hasBodyWeight || !hasLifts) return null;

              return (
                <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5`}>
                  <h3 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} mb-2 flex items-center gap-2`}>
                    <Target size={20} />
                    Strength Standards
                  </h3>
                  <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>
                    Your strength level based on estimated 1RM relative to your {bodyWeight} kg bodyweight
                  </div>

                  <div className="space-y-5">
                    {Object.keys(mainLifts1RMs).map(liftName => {
                      const estimated1RM = mainLifts1RMs[liftName];
                      const standard = getStrengthStandard(liftName, estimated1RM, bodyWeight, gender);

                      if (!standard) return null;

                      return (
                        <div key={liftName}>
                          <div className="flex justify-between items-baseline mb-1">
                            <div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                              {liftName}
                            </div>
                            <div className={`text-sm font-bold ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                              {estimated1RM.toFixed(1)} kg (est. 1RM)
                            </div>
                          </div>

                          <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                            <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{standard.level}</span> level
                            {standard.levelIndex < standard.totalLevels - 1 && ` â€¢ ${standard.percentageToNext}% to ${standard.nextLevel}`}
                            {' â€¢ '}{standard.ratio}x bodyweight
                          </div>

                          {/* Progress bar with level labels */}
                          <div className={`h-4 ${darkMode ? 'bg-gray-700' : 'bg-gray-200'} rounded-full overflow-hidden flex mb-1`}>
                            {Array.from({ length: standard.totalLevels }).map((_, idx) => {
                              const isCompleted = idx < standard.levelIndex;
                              const isCurrent = idx === standard.levelIndex;
                              const percentage = isCurrent ? standard.percentageToNext : 0;

                              return (
                                <div
                                  key={idx}
                                  className="flex-1 relative"
                                  style={{
                                    borderRight: idx < standard.totalLevels - 1 ? `1px solid ${darkMode ? '#374151' : '#e5e7eb'}` : 'none'
                                  }}
                                >
                                  {isCompleted && (
                                    <div className={`h-full ${darkMode ? 'bg-gray-500' : 'bg-gray-400'}`}></div>
                                  )}
                                  {isCurrent && (
                                    <div
                                      className={`h-full ${darkMode ? 'bg-blue-600' : 'bg-blue-500'}`}
                                      style={{ width: `${percentage}%` }}
                                    ></div>
                                  )}
                                </div>
                              );
                            })}
                          </div>

                          {/* Level labels */}
                          <div className="flex justify-between text-[9px] mt-1">
                            {['Untrained', 'Novice', 'Intermediate', 'Advanced', 'Elite'].map((levelName, idx) => (
                              <div
                                key={idx}
                                className={`flex-1 text-center ${
                                  idx === standard.levelIndex
                                    ? darkMode ? 'text-blue-400 font-semibold' : 'text-blue-600 font-semibold'
                                    : darkMode ? 'text-gray-500' : 'text-gray-400'
                                }`}
                              >
                                {levelName}
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })()}

            {/* Exercise Progress */}
            {(() => {
              const mostTrained = getMostTrainedExercises();
              return mostTrained.length > 0 && (
                <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5`}>
                  <button
                    onClick={() => setShowExerciseProgress(!showExerciseProgress)}
                    className="w-full flex items-center justify-between mb-4"
                  >
                    <h3 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} flex items-center gap-2`}>
                      <TrendingUp size={20} />
                      Exercise Progress
                    </h3>
                    {showExerciseProgress ? (
                      <ChevronUp size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                    ) : (
                      <ChevronDown size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                    )}
                  </button>
                  {showExerciseProgress && (
                    <>
                      <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>
                        Tap an exercise to view detailed progress charts
                      </div>
                      <div className="space-y-2">
                        {mostTrained.map((exercise, idx) => (
                          <button
                            key={idx}
                            onClick={() => setExerciseProgressModal({ exerciseName: exercise.name })}
                            className={`w-full flex justify-between items-center p-3 ${darkMode ? 'bg-gray-900 hover:bg-gray-800' : 'bg-gray-50 hover:bg-gray-100'} rounded-lg transition-colors text-left`}
                          >
                            <div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                              {exercise.name}
                            </div>
                            <div className="flex items-center gap-2">
                              <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                {exercise.count} workout{exercise.count !== 1 ? 's' : ''}
                              </div>
                              <ChevronRight size={16} className={darkMode ? 'text-gray-500' : 'text-gray-400'} />
                            </div>
                          </button>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              );
            })()}

            {/* Progress Timeline */}
            <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5`}>
              <button
                onClick={() => setShowProgressTimeline(!showProgressTimeline)}
                className="w-full flex items-center justify-between mb-4"
              >
                <h3 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} flex items-center gap-2`}>
                  <TrendingUp size={20} />
                  Progress Timeline
                </h3>
                {showProgressTimeline ? (
                  <ChevronUp size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                ) : (
                  <ChevronDown size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                )}
              </button>

              {showProgressTimeline && (
                <>
                  {/* Time Range Selector */}
                  <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                {[
                  { value: '2weeks', label: '2 Weeks' },
                  { value: '4weeks', label: '4 Weeks' },
                  { value: '3months', label: '3 Months' },
                  { value: '6months', label: '6 Months' },
                  { value: 'all', label: 'All Time' }
                ].map(range => (
                  <button
                    key={range.value}
                    onClick={() => {
                      setTimelineRange(range.value);
                      setSelectedTimelinePoint(null);
                    }}
                    className={`px-4 py-2 rounded-lg whitespace-nowrap font-medium transition-all touch-manipulation ${
                      timelineRange === range.value
                        ? darkMode
                          ? 'bg-blue-600 text-white'
                          : 'bg-blue-500 text-white'
                        : darkMode
                          ? 'bg-gray-700 hover:bg-gray-600 text-gray-300'
                          : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                    }`}
                  >
                    {range.label}
                  </button>
                ))}
              </div>

              {(() => {
                const timelineData = getTimelineData();

                if (timelineData.length === 0) {
                  return (
                    <div className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      No workout data available for this time range.
                    </div>
                  );
                }

                return (
                  <div className="space-y-6">
                    {/* Volume Chart */}
                    <div>
                      <div className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                        Total Volume (kg)
                      </div>
                      <div className="flex justify-center">
                        <LineChart
                          data={timelineData}
                          metric="volume"
                          darkMode={darkMode}
                          onPointClick={setSelectedTimelinePoint}
                          selectedPoint={selectedTimelinePoint}
                        />
                      </div>
                    </div>

                    {/* Total Reps Chart */}
                    <div>
                      <div className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                        Total Reps (per day)
                      </div>
                      <div className="flex justify-center">
                        <LineChart
                          data={timelineData}
                          metric="reps"
                          darkMode={darkMode}
                          onPointClick={setSelectedTimelinePoint}
                          selectedPoint={selectedTimelinePoint}
                        />
                      </div>
                    </div>
                  </div>
                );
              })()}
                </>
              )}
            </div>
          </div>
        )}

        {activeView === 'logging' && currentLog && (
          <div className="space-y-4">
            {/* Workout Header */}
            <div className={`${darkMode ? 'bg-gradient-to-br from-gray-800 to-gray-700 border-gray-700' : 'bg-gradient-to-br from-gray-100 to-gray-50 border-gray-200'} rounded-2xl p-6 shadow-md border transform-gpu`}>
              <div className="flex items-center gap-3 mb-2">
                <WorkoutIcon emoji={currentLog.workoutEmoji} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                <div>
                  <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{currentLog.workoutName}</h2>
                  <div className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm`}>
                    {new Date(currentLog.date).toLocaleString('hr-HR', { 
                      day: 'numeric', 
                      month: 'long',
                      hour: '2-digit',
                      minute: '2-digit'
                    })}
                  </div>
                </div>
              </div>
            </div>

            {/* Exercises */}
            {currentLog.exercises.map((exercise, exIdx) => (
              <div key={exIdx} className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5 shadow-sm transform-gpu relative`}>
                <div className="flex items-center gap-2 mb-2">
                  <input
                    type="text"
                    value={exercise.name}
                    onChange={(e) => updateExerciseName(exIdx, e.target.value)}
                    className={`font-bold text-lg ${darkMode ? 'text-white bg-gray-900 border-gray-700' : 'text-gray-900 bg-gray-50 border-gray-300'} border rounded-lg px-3 py-2 flex-1 focus:border-gray-500 focus:outline-none`}
                    placeholder="Exercise name"
                  />
                  <button
                    onClick={() => setSubstituteDropdown(substituteDropdown === exIdx ? null : exIdx)}
                    className={`p-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg transition-colors flex-shrink-0`}
                    title="Swap exercise"
                  >
                    <RepeatIcon size={18} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                  </button>
                </div>

                {/* Substitution Dropdown */}
                {substituteDropdown === exIdx && (() => {
                  const suggestions = getMuscleGroupSuggestions(exercise.name);
                  return (
                    <div className={`absolute left-5 right-5 mt-1 ${darkMode ? 'bg-gray-900 border-gray-700' : 'bg-white border-gray-200'} border rounded-lg shadow-xl z-50 max-h-48 overflow-y-auto`}>
                      {suggestions.length > 0 ? (
                        <>
                          <div className={`px-3 py-2 text-xs font-semibold ${darkMode ? 'text-gray-400 border-gray-700' : 'text-gray-600 border-gray-200'} border-b`}>
                            Suggestions (same muscle group):
                          </div>
                          {suggestions.map((suggestion, idx) => (
                            <button
                              key={idx}
                              onClick={() => substituteExercise(exIdx, suggestion)}
                              className={`w-full text-left px-3 py-2 ${darkMode ? 'hover:bg-gray-800 text-white' : 'hover:bg-gray-50 text-gray-900'} transition-colors`}
                            >
                              {suggestion}
                            </button>
                          ))}
                        </>
                      ) : (
                        <div className={`px-3 py-3 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} text-center`}>
                          No suggestions (custom exercise)
                        </div>
                      )}
                    </div>
                  );
                })()}

                <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>Target: {exercise.plannedSets} Ã— {exercise.plannedReps}</div>

                {/* Smart Weight Suggestion */}
                {(() => {
                  const isCoreExercise = exercise.name.toLowerCase().includes('core') ||
                                        exercise.name.toLowerCase().includes('plank') ||
                                        exercise.name.toLowerCase().includes('hanging') ||
                                        exercise.name.toLowerCase().includes('rollout');
                  if (isCoreExercise) return null;

                  const suggestion = getSmartWeightSuggestion(exercise.name);
                  if (!suggestion) return null;

                  return (
                    <div className={`text-xs ${darkMode ? 'text-blue-400' : 'text-blue-600'} mb-4 flex items-center gap-1`}>
                      <Zap size={14} />
                      <span>Suggestion: <strong>{suggestion.weight} kg</strong> â€” {suggestion.reason}</span>
                    </div>
                  );
                })()}

                <div className="space-y-3">
                  {exercise.sets.map((set, setIdx) => (
                    <div key={setIdx} className="flex items-center gap-2">
                      <div className="w-12 text-center">
                        <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Set</div>
                        <div className={`${darkMode ? 'text-white' : 'text-gray-900'} font-bold`}>{setIdx + 1}</div>
                      </div>
                      
                      <input
                        type="text"
                        inputMode="decimal"
                        placeholder="kg"
                        value={set.weight}
                        onChange={(e) => updateSet(exIdx, setIdx, 'weight', e.target.value)}
                        className={`w-20 px-3 py-2 ${darkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg text-center font-semibold focus:border-gray-500 focus:outline-none`}
                        disabled={exercise.name.toLowerCase().includes('core') ||
                                 exercise.name.toLowerCase().includes('plank') ||
                                 exercise.name.toLowerCase().includes('hanging') ||
                                 exercise.name.toLowerCase().includes('rollout')}
                      />
                      
                      <span className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} font-bold`}>Ã—</span>
                      
                      <input
                        type="number"
                        placeholder="reps"
                        value={set.reps}
                        onChange={(e) => updateSet(exIdx, setIdx, 'reps', e.target.value)}
                        className={`w-20 px-3 py-2 ${darkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg text-center font-semibold focus:border-gray-500 focus:outline-none`}
                      />
                    </div>
                  ))}

                  {/* Add Set Button */}
                  <button
                    onClick={() => {
                      const updatedLog = { ...currentLog };
                      const lastSet = exercise.sets[exercise.sets.length - 1];
                      updatedLog.exercises[exIdx].sets.push({
                        weight: lastSet?.weight || '',
                        reps: lastSet?.reps || exercise.plannedReps
                      });
                      setCurrentLog(updatedLog);
                      soundSystem.buttonPress();
                    }}
                    className={`w-full mt-2 px-4 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-lg flex items-center justify-center gap-2 transition-colors text-sm font-medium touch-manipulation`}
                  >
                    <Plus size={16} />
                    Add Set
                  </button>

                  {/* Difficulty Rating */}
                  <div className={`mt-4 pt-4 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                    <div className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-3`}>
                      How was it? (optional)
                    </div>
                    <div className="flex gap-2">
                      {[
                        { value: 'easy', label: 'Easy' },
                        { value: 'medium', label: 'Medium' },
                        { value: 'hard', label: 'Hard' }
                      ].map(option => (
                        <button
                          key={option.value}
                          onClick={() => {
                            const updated = { ...currentLog };
                            updated.exercises[exIdx].difficulty =
                              exercise.difficulty === option.value ? null : option.value;
                            setCurrentLog(updated);
                          }}
                          className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                            exercise.difficulty === option.value
                              ? darkMode
                                ? 'bg-blue-600 text-white'
                                : 'bg-blue-500 text-white'
                              : darkMode
                                ? 'bg-gray-700 hover:bg-gray-600 text-gray-300'
                                : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                          }`}
                        >
                          {option.label}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            ))}

            {/* Action Buttons */}
            <div className="flex gap-3 sticky bottom-4">
              <button
                onClick={() => {
                  setCurrentLog(null);
                  setActiveView('home');
                }}
                className={`px-6 py-4 ${darkMode ? 'bg-gray-800 hover:bg-gray-700 border-gray-700' : 'bg-white hover:bg-gray-50 border-gray-300'} border text-${darkMode ? 'white' : 'gray-900'} rounded-xl font-semibold transition-all`}
              >
                Cancel
              </button>
              <button
                onClick={finishWorkout}
                className="flex-1 px-6 py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold transition-colors transform-gpu"
              >
                Finish Workout
              </button>
            </div>
          </div>
        )}

        {activeView === 'history' && (
          <div className="space-y-4">
            <h2 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-4 flex items-center gap-2`}>
              <Calendar size={24} />
              History
            </h2>
            
            {completedWorkouts.length === 0 ? (
              <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} backdrop-blur border rounded-2xl p-12 text-center`}>
                <div className="mb-4 flex justify-center"><BarChart3 size={64} className={darkMode ? 'text-gray-600' : 'text-gray-400'} /></div>
                <div className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-lg`}>No workouts yet</div>
                <div className={`${darkMode ? 'text-gray-500' : 'text-gray-500'} text-sm mt-2`}>Start your first workout to see it here!</div>
              </div>
            ) : (
              completedWorkouts.slice().reverse().map((workout) => (
                <div key={workout.id} className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} backdrop-blur border rounded-2xl p-5 shadow-lg`}>
                  <div className="flex items-start gap-3 mb-4">
                    <WorkoutIcon emoji={workout.workoutEmoji} size={32} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                    <div className="flex-1">
                      <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{workout.workoutName}</h3>
                      <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        {new Date(workout.date).toLocaleString('hr-HR', {
                          weekday: 'short',
                          day: 'numeric',
                          month: 'short',
                          hour: '2-digit',
                          minute: '2-digit'
                        })}
                      </p>
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => {
                          setEditingHistory(JSON.parse(JSON.stringify(workout)));
                          setActiveView('edit-history');
                        }}
                        className={`p-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg transition-colors`}
                      >
                        <Edit2 size={16} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                      </button>
                      <button
                        onClick={() => setShowDeleteHistory(workout.id)}
                        className="p-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors"
                      >
                        <Trash2 size={16} className="text-white" />
                      </button>
                    </div>
                  </div>
                  
                  <div className="space-y-3">
                    {workout.exercises.map((ex, exIdx) => {
                      // Filter out skipped sets
                      const completedSets = ex.sets.filter(set => {
                        const weight = parseFloat(set.weight) || 0;
                        const reps = parseFloat(set.reps) || 0;
                        const isCoreExercise = ex.name.toLowerCase().includes('core') ||
                                              ex.name.toLowerCase().includes('plank') ||
                                              ex.name.toLowerCase().includes('hanging') ||
                                              ex.name.toLowerCase().includes('rollout');

                        const isBodyweightExercise = ex.name.toLowerCase().includes('pull-up') ||
                                                     ex.name.toLowerCase().includes('dip') ||
                                                     ex.name.toLowerCase().includes('chin-up') ||
                                                     ex.name.toLowerCase().includes('push-up');

                        // For core exercises and bodyweight exercises, only check reps
                        if (isCoreExercise || isBodyweightExercise) return reps > 0;
                        // For weighted exercises, check both weight and reps
                        return weight > 0 && reps > 0;
                      });
                      
                      // Don't render exercise if all sets were skipped
                      if (completedSets.length === 0) return null;
                      
                      return (
                        <div key={exIdx} className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'} pt-3`}>
                          <div className={`font-medium text-sm ${darkMode ? 'text-white' : 'text-gray-900'} mb-2`}>{ex.name}</div>
                          <div className="flex flex-wrap gap-2">
                            {completedSets.map((set, setIdx) => (
                              <div key={setIdx} className={`${darkMode ? 'bg-gray-900' : 'bg-gray-100'} px-3 py-1 rounded-lg text-sm`}>
                                {set.weight && parseFloat(set.weight) > 0 ? (
                                  <>
                                    <span className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} font-semibold`}>{set.weight}kg</span>
                                    <span className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} mx-1`}>Ã—</span>
                                  </>
                                ) : null}
                                <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>{set.reps}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))
            )}
          </div>
        )}

        {activeView === 'edit' && editingWorkout && (
          <div className="space-y-4">
            <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5`}>
              <h2 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-4`}>Edit Workout</h2>
              <div className="space-y-3">
                <input
                  type="text"
                  value={editingWorkout.name}
                  onChange={(e) => setEditingWorkout({ ...editingWorkout, name: e.target.value })}
                  className={`w-full px-4 py-3 ${darkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg text-lg focus:border-gray-500 focus:outline-none`}
                  placeholder="Workout name"
                />
                <div>
                  <label className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2 block`}>Select Icon:</label>
                  <IconPicker
                    selectedEmoji={editingWorkout.emoji || 'ðŸ’ª'}
                    onSelect={(emoji) => setEditingWorkout({ ...editingWorkout, emoji })}
                    darkMode={darkMode}
                  />
                </div>
              </div>
            </div>

            <div className="space-y-3">
              {editingWorkout.exercises.map((ex, idx) => (
                <div
                  key={`exercise-${idx}`}
                  className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-4 ${
                    draggedExerciseIndex === idx && isDraggingExercise ? 'opacity-30' : ''
                  } ${
                    dropTargetIndex === idx && draggedExerciseIndex !== idx ? 'ring-2 ring-blue-500' : ''
                  }`}
                  data-exercise-index={idx}
                >
                  <div className="flex gap-2 mb-3">
                    {/* Up/Down Buttons */}
                    <div className="flex flex-col gap-1">
                      <button
                        onClick={() => moveExerciseUp(idx)}
                        disabled={idx === 0}
                        className={`p-1 rounded ${idx === 0 ? 'opacity-30 cursor-not-allowed' : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} transition-colors`}
                      >
                        <ChevronUp size={16} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                      </button>
                      <button
                        onClick={() => moveExerciseDown(idx)}
                        disabled={idx === editingWorkout.exercises.length - 1}
                        className={`p-1 rounded ${idx === editingWorkout.exercises.length - 1 ? 'opacity-30 cursor-not-allowed' : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} transition-colors`}
                      >
                        <ChevronDown size={16} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                      </button>
                    </div>
                    <ExerciseInput
                      value={ex.name}
                      onChange={(value) => updateExercise(idx, 'name', value)}
                      darkMode={darkMode}
                      placeholder="Exercise name"
                    />
                    <button
                      onClick={() => deleteExercise(idx)}
                      className="p-2 bg-red-600 hover:bg-red-700 active:bg-red-800 rounded-lg transition-colors touch-manipulation"
                    >
                      <Trash2 size={20} className="text-white" />
                    </button>
                  </div>
                  <div className="flex gap-2 pl-7">
                    <input
                      type="number"
                      value={ex.sets}
                      onChange={(e) => updateExercise(idx, 'sets', parseInt(e.target.value))}
                      className={`w-20 px-3 py-2 ${darkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg text-center focus:border-gray-500 focus:outline-none`}
                      placeholder="Sets"
                    />
                    <input
                      type="text"
                      value={ex.reps}
                      onChange={(e) => updateExercise(idx, 'reps', e.target.value)}
                      className={`w-24 px-3 py-2 ${darkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg text-center focus:border-gray-500 focus:outline-none`}
                      placeholder="Reps"
                    />
                  </div>
                </div>
              ))}
            </div>

            <button
              onClick={addExercise}
              className={`w-full px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} text-${darkMode ? 'white' : 'gray-900'} rounded-xl flex items-center justify-center gap-2 transition-colors font-semibold`}
            >
              <Plus size={20} />
              Add Exercise
            </button>

            <div className="flex gap-3">
              <button
                onClick={() => {
                  setEditingWorkout(null);
                  setActiveView('home');
                }}
                className={`px-6 py-3 ${darkMode ? 'bg-gray-800 hover:bg-gray-700 border-gray-700' : 'bg-white hover:bg-gray-50 border-gray-300'} border text-${darkMode ? 'white' : 'gray-900'} rounded-xl font-semibold transition-colors`}
              >
                Cancel
              </button>
              <button
                onClick={saveEditedWorkout}
                className={`flex-1 px-6 py-3 ${darkMode ? 'bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500' : 'bg-gradient-to-r from-gray-800 to-gray-700 hover:from-gray-700 hover:to-gray-600'} text-white rounded-xl font-semibold transition-all`}
              >
                Save Changes
              </button>
            </div>
          </div>
        )}

        {activeView === 'edit-history' && editingHistory && (
          <div className="space-y-4">
            <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} backdrop-blur border rounded-2xl p-5`}>
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h2 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Edit Workout</h2>
                  <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    {new Date(editingHistory.date).toLocaleString('hr-HR', {
                      weekday: 'long',
                      day: 'numeric',
                      month: 'long',
                      year: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    })}
                  </p>
                </div>
              </div>

              {/* Exercises */}
              {editingHistory.exercises.map((exercise, exIdx) => (
                <div key={exIdx} className={`${darkMode ? 'bg-gray-900/50 border-gray-700' : 'bg-gray-50 border-gray-200'} border rounded-xl p-4 mb-4`}>
                  <h3 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} mb-3`}>{exercise.name}</h3>

                  <div className="space-y-3">
                    {exercise.sets.map((set, setIdx) => (
                      <div key={setIdx} className="flex items-center gap-2">
                        <div className="w-12 text-center">
                          <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Set</div>
                          <div className={`${darkMode ? 'text-white' : 'text-gray-900'} font-bold`}>{setIdx + 1}</div>
                        </div>

                        <input
                          type="text"
                          inputMode="decimal"
                          placeholder="kg"
                          value={set.weight}
                          onChange={(e) => updateHistorySet(exIdx, setIdx, 'weight', e.target.value)}
                          className={`w-20 px-3 py-2 ${darkMode ? 'bg-gray-800 border-gray-700 text-white' : 'bg-white border-gray-300 text-gray-900'} border rounded-lg text-center font-semibold focus:border-gray-500 focus:outline-none`}
                        />

                        <span className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} font-bold`}>Ã—</span>

                        <input
                          type="number"
                          placeholder="reps"
                          value={set.reps}
                          onChange={(e) => updateHistorySet(exIdx, setIdx, 'reps', e.target.value)}
                          className={`w-20 px-3 py-2 ${darkMode ? 'bg-gray-800 border-gray-700 text-white' : 'bg-white border-gray-300 text-gray-900'} border rounded-lg text-center font-semibold focus:border-gray-500 focus:outline-none`}
                        />
                      </div>
                    ))}
                  </div>
                </div>
              ))}

              <div className="flex gap-3 mt-6">
                <button
                  onClick={() => {
                    setEditingHistory(null);
                    setActiveView('history');
                  }}
                  className={`px-6 py-3 ${darkMode ? 'bg-gray-800 hover:bg-gray-700 border-gray-700' : 'bg-white hover:bg-gray-50 border-gray-300'} border rounded-xl font-semibold transition-colors ${darkMode ? 'text-white' : 'text-gray-900'}`}
                >
                  Cancel
                </button>
                <button
                  onClick={saveEditedHistory}
                  className={`flex-1 px-6 py-3 ${darkMode ? 'bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500' : 'bg-gradient-to-r from-gray-800 to-gray-700 hover:from-gray-700 hover:to-gray-600'} text-white rounded-xl font-semibold transition-all`}
                >
                  Save Changes
                </button>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Floating Drag Ghost */}
      {isDraggingExercise && draggedExerciseIndex !== null && editingWorkout && (
        <div
          style={{
            position: 'fixed',
            left: draggedExercisePosition.x,
            top: draggedExercisePosition.y,
            transform: 'translate(-50%, -50%)',
            pointerEvents: 'none',
            zIndex: 10000,
            width: '90%',
            maxWidth: '400px'
          }}
        >
          <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-4 shadow-2xl opacity-90`}>
            <div className="flex gap-2 mb-2">
              <GripVertical size={20} className={darkMode ? 'text-gray-500' : 'text-gray-400'} />
              <div className={`flex-1 font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {editingWorkout.exercises[draggedExerciseIndex].name || 'Exercise'}
              </div>
            </div>
            <div className="flex gap-2 pl-7">
              <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                {editingWorkout.exercises[draggedExerciseIndex].sets} sets Ã—{' '}
                {editingWorkout.exercises[draggedExerciseIndex].reps} reps
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      {showDeleteConfirm && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-6 max-w-md w-full shadow-2xl`}>
            <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-2`}>Delete Workout Day?</h3>
            <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-6`}>
              Are you sure you want to delete this workout day? This action cannot be undone.
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowDeleteConfirm(null)}
                className={`flex-1 px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-xl font-semibold transition-colors`}
              >
                Cancel
              </button>
              <button
                onClick={() => deleteWorkoutDay(showDeleteConfirm)}
                className="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-semibold transition-colors"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Add Day Modal */}
      {showAddDay && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-6 max-w-md w-full shadow-2xl`}>
            <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-2`}>Add New Workout Day</h3>
            <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-6`}>
              This will create a new workout day that you can customize with your exercises.
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowAddDay(false)}
                className={`flex-1 px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-xl font-semibold transition-colors`}
              >
                Cancel
              </button>
              <button
                onClick={addNewWorkoutDay}
                className={`flex-1 px-4 py-3 ${darkMode ? 'bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500' : 'bg-gradient-to-r from-gray-800 to-gray-700 hover:from-gray-700 hover:to-gray-600'} text-white rounded-xl font-semibold transition-colors`}
              >
                Add Day
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Upload Markdown Modal */}
      {showUploadModal && (
        <div
          className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999] p-4 overflow-y-auto"
          onClick={(e) => {
            // Close modal if clicking backdrop
            if (e.target === e.currentTarget) {
              setShowUploadModal(false);
            }
          }}
        >
          <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-6 max-w-md w-full shadow-2xl my-8`}>
            <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-2`}>
              Upload Workout Routine
            </h3>
            <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>
              Found {parsedWorkouts.length} workout day(s) in the file.
            </p>

            <div className="mb-6">
              <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                How would you like to import these workouts?
              </label>
              <div className="space-y-2">
                <button
                  onClick={() => handleImportChoice('replace')}
                  className={`w-full px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 active:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300 active:bg-gray-400'} rounded-xl text-left transition-colors touch-manipulation`}
                >
                  <div className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Replace All</div>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Clear existing workouts and use only these</div>
                </button>
                <button
                  onClick={() => handleImportChoice('add')}
                  className={`w-full px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 active:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300 active:bg-gray-400'} rounded-xl text-left transition-colors touch-manipulation`}
                >
                  <div className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Add to Existing</div>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Keep current workouts and add these</div>
                </button>
              </div>
            </div>

            <button
              onClick={() => setShowUploadModal(false)}
              className={`w-full px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 active:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 active:bg-gray-400 text-gray-900'} rounded-xl font-semibold touch-manipulation`}
            >
              Cancel
            </button>
          </div>
        </div>
      )}

      {/* Delete History Confirmation Modal */}
      {showDeleteHistory && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-6 max-w-md w-full shadow-2xl`}>
            <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-2`}>Delete Workout Entry?</h3>
            <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-6`}>
              Are you sure you want to delete this workout from your history? This will affect your statistics and cannot be undone.
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowDeleteHistory(null)}
                className={`flex-1 px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-xl font-semibold transition-colors`}
              >
                Cancel
              </button>
              <button
                onClick={() => deleteHistoryEntry(showDeleteHistory)}
                className="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-semibold transition-colors"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Exercise Progress Modal */}
      {/* 1RM Progression Modal */}
      {show1RMModal && (
        <div
          className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999] p-4"
          onClick={() => setShow1RMModal(null)}
        >
          <div
            className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-6 max-w-md w-full shadow-2xl max-h-[90vh] overflow-y-auto`}
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between mb-6">
              <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {show1RMModal.exerciseName} - 1RM Progression
              </h3>
              <button
                onClick={() => setShow1RMModal(null)}
                className={`p-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg transition-colors`}
              >
                <X size={20} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
              </button>
            </div>

            {show1RMModal.data.length === 0 ? (
              <div className={`text-center py-12 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                No 1RM data available
              </div>
            ) : (
              <>
                <div className="space-y-2 mb-6">
                  {show1RMModal.data.map((entry, idx) => (
                    <div
                      key={idx}
                      className={`flex justify-between items-center p-3 ${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg`}
                    >
                      <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        {new Date(entry.date).toLocaleDateString('hr-HR')}
                      </div>
                      <div className={`font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        {entry.estimated1RM.toFixed(1)} kg
                      </div>
                    </div>
                  ))}
                </div>

                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4`}>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>
                    Progress
                  </div>
                  <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {show1RMModal.data.length > 1
                      ? `+${(show1RMModal.data[show1RMModal.data.length - 1].estimated1RM - show1RMModal.data[0].estimated1RM).toFixed(1)} kg`
                      : '--'}
                  </div>
                  {show1RMModal.data.length > 1 && (
                    <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'} mt-1`}>
                      from {show1RMModal.data.length} workouts
                    </div>
                  )}
                </div>
              </>
            )}
          </div>
        </div>
      )}

      {exerciseProgressModal && (() => {
        const progressData = getExerciseProgress(exerciseProgressModal.exerciseName);
        const isCoreExercise = exerciseProgressModal.exerciseName.toLowerCase().includes('core') ||
                              exerciseProgressModal.exerciseName.toLowerCase().includes('plank') ||
                              exerciseProgressModal.exerciseName.toLowerCase().includes('hanging') ||
                              exerciseProgressModal.exerciseName.toLowerCase().includes('rollout');

        // Group by workout date and get max values
        const grouped = {};
        progressData.forEach(point => {
          const dateKey = new Date(point.date).toLocaleDateString('hr-HR');
          if (!grouped[dateKey]) {
            grouped[dateKey] = { date: point.date, maxWeight: point.weight, totalVolume: point.volume, totalReps: point.reps };
          } else {
            if (point.weight > grouped[dateKey].maxWeight) {
              grouped[dateKey].maxWeight = point.weight;
            }
            grouped[dateKey].totalVolume += point.volume;
            grouped[dateKey].totalReps += point.reps;
          }
        });

        const chartData = Object.values(grouped);
        const last10 = chartData.slice(-10);

        return (
          <div
            className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999] p-4"
            onClick={() => setExerciseProgressModal(null)}
          >
            <div
              className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-6 max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex items-center justify-between mb-6">
                <h3 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                  {exerciseProgressModal.exerciseName}
                </h3>
                <button
                  onClick={() => setExerciseProgressModal(null)}
                  className={`p-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg transition-colors`}
                >
                  <X size={20} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                </button>
              </div>

              {chartData.length === 0 ? (
                <div className={`text-center py-12 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  No workout data found for this exercise
                </div>
              ) : (
                <>
                  {/* Max Weight Chart (skip for core exercises) */}
                  {!isCoreExercise && (
                    <div className="mb-8">
                      <h4 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} mb-4`}>
                        Max Weight Progress
                      </h4>
                      <LineChart
                        data={last10}
                        dataKey="maxWeight"
                        label="kg"
                        darkMode={darkMode}
                        height={200}
                      />
                      <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mt-2 text-center`}>
                        Last {last10.length} workouts
                      </div>
                    </div>
                  )}

                  {/* Total Volume Chart */}
                  <div className="mb-8">
                    <h4 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} mb-4`}>
                      {isCoreExercise ? 'Total Reps Progress' : 'Total Volume Progress'}
                    </h4>
                    <LineChart
                      data={last10}
                      dataKey={isCoreExercise ? 'totalReps' : 'totalVolume'}
                      label={isCoreExercise ? 'reps' : 'kg'}
                      darkMode={darkMode}
                      height={200}
                    />
                    <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mt-2 text-center`}>
                      Last {last10.length} workouts
                    </div>
                  </div>

                  {/* Stats Summary */}
                  <div className="grid grid-cols-2 gap-4">
                    <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4`}>
                      <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>
                        Total Workouts
                      </div>
                      <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        {chartData.length}
                      </div>
                    </div>
                    {!isCoreExercise && (
                      <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4`}>
                        <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>
                          Peak Weight
                        </div>
                        <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                          {Math.max(...chartData.map(d => d.maxWeight))} kg
                        </div>
                      </div>
                    )}
                  </div>
                </>
              )}
            </div>
          </div>
        );
      })()}

      {/* Timeline Detail Modal */}
      {selectedTimelinePoint && (
        <div
          className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999] p-4 overflow-y-auto"
          onClick={(e) => {
            if (e.target === e.currentTarget) {
              setSelectedTimelinePoint(null);
            }
          }}
        >
          <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-6 max-w-md w-full shadow-2xl my-8`}>
            <div className="flex items-center justify-between mb-4">
              <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                Week of {new Date(selectedTimelinePoint.date).toLocaleDateString('en-US', {
                  month: 'short',
                  day: 'numeric',
                  year: 'numeric'
                })}
              </h3>
              <button
                onClick={() => setSelectedTimelinePoint(null)}
                className={`p-2 ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} rounded-lg transition-colors`}
              >
                <X size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
              </button>
            </div>

            {/* Summary Stats */}
            <div className="grid grid-cols-2 gap-3 mb-6">
              <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4`}>
                <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Total Volume</div>
                <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                  {(selectedTimelinePoint.volume / 1000).toFixed(1)}k
                </div>
                <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>kg</div>
              </div>

              <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4`}>
                <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Total Reps</div>
                <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                  {selectedTimelinePoint.reps}
                </div>
                <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>reps</div>
              </div>
            </div>

            {/* Main Lifts PRs */}
            {(selectedTimelinePoint.mainLifts.deadlift || selectedTimelinePoint.mainLifts.squat ||
              selectedTimelinePoint.mainLifts.bench || selectedTimelinePoint.mainLifts.ohp) && (
              <div className="mb-6">
                <h4 className={`text-sm font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-3`}>
                  Main Lifts (Max Weight)
                </h4>
                <div className="space-y-2">
                  {selectedTimelinePoint.mainLifts.deadlift && (
                    <div className="flex justify-between items-center">
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Deadlift</span>
                      <span className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        {selectedTimelinePoint.mainLifts.deadlift} kg
                      </span>
                    </div>
                  )}
                  {selectedTimelinePoint.mainLifts.squat && (
                    <div className="flex justify-between items-center">
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Squat</span>
                      <span className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        {selectedTimelinePoint.mainLifts.squat} kg
                      </span>
                    </div>
                  )}
                  {selectedTimelinePoint.mainLifts.bench && (
                    <div className="flex justify-between items-center">
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Bench Press</span>
                      <span className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        {selectedTimelinePoint.mainLifts.bench} kg
                      </span>
                    </div>
                  )}
                  {selectedTimelinePoint.mainLifts.ohp && (
                    <div className="flex justify-between items-center">
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Overhead Press</span>
                      <span className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        {selectedTimelinePoint.mainLifts.ohp} kg
                      </span>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Workouts List */}
            <div>
              <h4 className={`text-sm font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-3`}>
                Workouts Completed ({selectedTimelinePoint.workouts.length})
              </h4>
              <div className="space-y-2 max-h-48 overflow-y-auto">
                {selectedTimelinePoint.workouts.map((workout, idx) => (
                  <div
                    key={idx}
                    className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3 flex items-center justify-between`}
                  >
                    <div className="flex items-center gap-2">
                      <WorkoutIcon emoji={workout.workoutEmoji} className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`} size={16} />
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        {workout.workoutName}
                      </span>
                    </div>
                    <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                      {new Date(workout.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                    </span>
                  </div>
                ))}
              </div>
            </div>

            <button
              onClick={() => setSelectedTimelinePoint(null)}
              className={`w-full mt-6 px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-xl font-semibold transition-colors touch-manipulation`}
            >
              Close
            </button>
          </div>
        </div>
      )}

      {/* Bottom Navigation */}
      <div className={`fixed bottom-0 left-0 right-0 ${darkMode ? 'bg-gray-900' : 'bg-white'} border-t ${darkMode ? 'border-gray-800' : 'border-gray-200'} px-4 py-3 transform-gpu`}>
        <div className="max-w-6xl mx-auto flex justify-around">
          <button
            onClick={() => setActiveView('home')}
            className={`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition-colors ${
              activeView === 'home' || activeView === 'edit' || activeView === 'logging'
                ? darkMode ? 'text-gray-300' : 'text-gray-900'
                : darkMode ? 'text-gray-600' : 'text-gray-400'
            }`}
          >
            <Dumbbell size={24} />
            <span className="text-xs font-medium">Workouts</span>
          </button>
          
          <button
            onClick={() => setActiveView('stats')}
            className={`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition-colors ${
              activeView === 'stats'
                ? darkMode ? 'text-gray-300' : 'text-gray-900'
                : darkMode ? 'text-gray-600' : 'text-gray-400'
            }`}
          >
            <BarChart3 size={24} />
            <span className="text-xs font-medium">Stats</span>
          </button>
          
          <button
            onClick={() => setActiveView('history')}
            className={`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition-colors ${
              activeView === 'history' 
                ? darkMode ? 'text-gray-300' : 'text-gray-900'
                : darkMode ? 'text-gray-600' : 'text-gray-400'
            }`}
          >
            <Calendar size={24} />
            <span className="text-xs font-medium">History</span>
          </button>
        </div>
      </div>
    </div>
  );
};



    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<WorkoutTracker />);

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }
  </script>
</body>
</html>