<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#111827">
  <meta name="description" content="Track your workouts, monitor progress, and achieve your fitness goals">
  <title>Workout Pro</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="apple-touch-icon" href="/favicon.svg">
  <link rel="manifest" href="/manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Workout Pro">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overscroll-behavior-y: contain; }
    *::-webkit-scrollbar { width: 0; background: transparent; }
    * { -ms-overflow-style: none; scrollbar-width: none; }

    /* Mobile scrolling performance optimizations */
    .transform-gpu {
      transform: translateZ(0);
      will-change: transform;
      -webkit-transform: translateZ(0);
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }

    /* Smooth scrolling with hardware acceleration */
    #root {
      -webkit-overflow-scrolling: touch;
      transform: translateZ(0);
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // Simple SVG icon components
    const Dumbbell = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg>;
    
    const TrendingUp = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>;
    
    const Calendar = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
    
    const Download = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
    
    const Edit2 = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>;
    
    const Plus = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>;

    const PlusCircle = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>;

    const Trash2 = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
    
    const Check = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>;
    
    const X = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
    
    const ChevronRight = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>;
    
    const Sun = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>;
    
    const Moon = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>;
    
    const BarChart3 = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>;
    
    const Zap = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
    
    const Target = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>;
    
    const Award = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>;

    // Additional workout-specific icons
    const Activity = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>;

    const GripVertical = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>;

    const Flame = ({size = 24, className = ""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>;

    // Icon mapper - maps emoji to icon component
    const WorkoutIcon = ({emoji, size = 40, className = ""}) => {
      const iconMap = {
        'ðŸ¦µ': <Dumbbell size={size} className={className} />,
        'ðŸ’ª': <Activity size={size} className={className} />,
        'âš¡': <Zap size={size} className={className} />,
        'ðŸŽ¯': <Target size={size} className={className} />,
        'ðŸ”¥': <Flame size={size} className={className} />
      };
      return iconMap[emoji] || <span className="text-4xl">{emoji}</span>;
    };

    // LineChart component for timeline visualization
    const LineChart = ({data, metric, darkMode, onPointClick, selectedPoint}) => {
      if (!data || data.length === 0) return null;

      const width = 350;
      const height = 200;
      const padding = {top: 20, right: 20, bottom: 30, left: 50};

      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      // Get values for the selected metric
      const values = data.map(d => {
        if (metric === 'volume') return d.volume;
        if (metric === 'frequency') return d.frequency;
        return 0;
      });

      const maxValue = Math.max(...values, 1);
      const minValue = Math.min(...values, 0);

      // Scale functions
      const scaleX = (index) => padding.left + (index / (data.length - 1)) * chartWidth;
      const scaleY = (value) => padding.top + chartHeight - ((value - minValue) / (maxValue - minValue)) * chartHeight;

      // Generate path for line
      const pathData = data.map((point, i) => {
        const x = scaleX(i);
        const y = scaleY(values[i]);
        return i === 0 ? `M ${x} ${y}` : `L ${x} ${y}`;
      }).join(' ');

      // Format date labels
      const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        const month = date.toLocaleDateString('en-US', {month: 'short'});
        const day = date.getDate();
        return `${month} ${day}`;
      };

      // Y-axis labels
      const yAxisLabels = [maxValue, Math.round(maxValue / 2), 0];

      return (
        <svg width={width} height={height} className="touch-manipulation">
          {/* Grid lines */}
          {yAxisLabels.map((value, i) => {
            const y = scaleY(value);
            return (
              <g key={i}>
                <line
                  x1={padding.left}
                  y1={y}
                  x2={width - padding.right}
                  y2={y}
                  stroke={darkMode ? '#374151' : '#E5E7EB'}
                  strokeWidth="1"
                  strokeDasharray="3,3"
                />
                <text
                  x={padding.left - 10}
                  y={y + 4}
                  textAnchor="end"
                  fontSize="12"
                  fill={darkMode ? '#9CA3AF' : '#6B7280'}
                >
                  {value}
                </text>
              </g>
            );
          })}

          {/* Line */}
          <path
            d={pathData}
            fill="none"
            stroke={darkMode ? '#60A5FA' : '#3B82F6'}
            strokeWidth="3"
            strokeLinecap="round"
            strokeLinejoin="round"
          />

          {/* Data points */}
          {data.map((point, i) => {
            const x = scaleX(i);
            const y = scaleY(values[i]);
            const isSelected = selectedPoint && selectedPoint.date === point.date;

            return (
              <g key={i}>
                <circle
                  cx={x}
                  cy={y}
                  r={isSelected ? 8 : 5}
                  fill={darkMode ? '#60A5FA' : '#3B82F6'}
                  stroke={darkMode ? '#1F2937' : '#FFFFFF'}
                  strokeWidth="2"
                  style={{cursor: 'pointer'}}
                  onClick={() => onPointClick(point)}
                  className="transition-all"
                />
                {/* X-axis label */}
                {(i === 0 || i === data.length - 1 || i === Math.floor(data.length / 2)) && (
                  <text
                    x={x}
                    y={height - 5}
                    textAnchor="middle"
                    fontSize="11"
                    fill={darkMode ? '#9CA3AF' : '#6B7280'}
                  >
                    {formatDate(point.date)}
                  </text>
                )}
              </g>
            );
          })}
        </svg>
      );
    };

    // Icon picker component for selecting workout icons
    const IconPicker = ({selectedEmoji, onSelect, darkMode}) => {
      const availableIcons = [
        {emoji: 'ðŸ¦µ', name: 'Dumbbell'},
        {emoji: 'ðŸ’ª', name: 'Activity'},
        {emoji: 'âš¡', name: 'Zap'},
        {emoji: 'ðŸŽ¯', name: 'Target'},
        {emoji: 'ðŸ”¥', name: 'Flame'}
      ];

      return (
        <div className="grid grid-cols-5 gap-2 mt-2">
          {availableIcons.map(icon => (
            <button
              key={icon.emoji}
              type="button"
              onClick={() => onSelect(icon.emoji)}
              className={`p-3 rounded-lg transition-colors ${
                selectedEmoji === icon.emoji
                  ? 'bg-blue-600 ring-2 ring-blue-400'
                  : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'
              }`}
            >
              <WorkoutIcon emoji={icon.emoji} size={24} className={selectedEmoji === icon.emoji ? 'text-white' : (darkMode ? 'text-gray-300' : 'text-gray-700')} />
            </button>
          ))}
        </div>
      );
    };

// IndexedDB wrapper
const DB_NAME = 'WorkoutTrackerDB';
const DB_VERSION = 1;

const initDB = () => {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve(request.result);
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      
      if (!db.objectStoreNames.contains('workouts')) {
        db.createObjectStore('workouts', { keyPath: 'id' });
      }
      
      if (!db.objectStoreNames.contains('history')) {
        const historyStore = db.createObjectStore('history', { keyPath: 'id', autoIncrement: true });
        historyStore.createIndex('date', 'date', { unique: false });
        historyStore.createIndex('workoutId', 'workoutId', { unique: false });
      }
    };
  });
};

const dbOperations = {
  async saveWorkouts(workouts) {
    const db = await initDB();
    const tx = db.transaction('workouts', 'readwrite');
    const store = tx.objectStore('workouts');
    
    await store.clear();
    for (const workout of workouts) {
      await store.put(workout);
    }
    
    return new Promise((resolve, reject) => {
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },
  
  async getWorkouts() {
    const db = await initDB();
    const tx = db.transaction('workouts', 'readonly');
    const store = tx.objectStore('workouts');
    const request = store.getAll();
    
    return new Promise((resolve, reject) => {
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  },
  
  async saveHistory(history) {
    const db = await initDB();
    const tx = db.transaction('history', 'readwrite');
    const store = tx.objectStore('history');
    
    await store.put(history);
    
    return new Promise((resolve, reject) => {
      tx.oncomplete = () => resolve();
      tx.onerror = () => reject(tx.error);
    });
  },
  
  async getHistory() {
    const db = await initDB();
    const tx = db.transaction('history', 'readonly');
    const store = tx.objectStore('history');
    const request = store.getAll();
    
    return new Promise((resolve, reject) => {
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }
};

// Intelligent markdown parser - auto-detects any format
const parseMarkdownWorkout = (markdownText) => {
  // Helper: Check if line is likely a workout day separator
  const isWorkoutDayHeader = (line, upperLine) => {
    // Pattern 1: Starts with # or ##
    if (!line.startsWith('#')) return false;

    // Pattern 2: Contains day indicators
    const dayIndicators = ['DAY', 'DAN', 'WORKOUT', 'TRAINING', 'TRENING', 'WEEK', 'Ð¡Ð•Ð”ÐœÐ˜Ð¦Ð'];
    const hasDay = dayIndicators.some(indicator => upperLine.includes(indicator));

    // Pattern 3: Contains numbers (Day 1, Dan 2, etc.)
    const hasNumber = /\d/.test(line);

    // Pattern 4: Contains common workout types
    const workoutTypes = ['PUSH', 'PULL', 'LEG', 'UPPER', 'LOWER', 'FULL', 'CARDIO', 'STRENGTH'];
    const hasWorkoutType = workoutTypes.some(type => upperLine.includes(type));

    // Heuristic: It's a workout day if it has day indicator + number, or H1/H2 with workout type
    return (hasDay && hasNumber) || (line.match(/^#{1,2}\s/) && hasWorkoutType);
  };

  // Helper: Extract numeric value (handles ranges like "3-4", "8â€“10")
  const extractNumber = (text) => {
    const match = text.match(/(\d+)/);
    return match ? parseInt(match[1]) : null;
  };

  // Helper: Check if text looks like exercise data (sets/reps)
  const looksLikeExerciseData = (text) => {
    // Pattern: Contains numbers or x notation (3x8, 3 x 10, etc.)
    return /\d+\s*[xXÃ—]\s*\d+/.test(text) || /\d+/.test(text);
  };

  // Helper: Detect if line is likely a table header
  const isTableHeader = (cells) => {
    if (!cells || cells.length === 0) return false;
    const firstCell = cells[0].toLowerCase();
    const headerWords = ['exercise', 'vjeÅ¾ba', 'vjezba', 'name', 'naziv', 'sets', 'serije', 'reps', 'ponavljanja'];
    return headerWords.some(word => firstCell.includes(word));
  };

  // Helper: Smart extraction of sets/reps from any text
  const extractSetsReps = (text) => {
    // Try compact format first: "3x8", "4 x 10-12"
    const compactMatch = text.match(/(\d+)\s*[xXÃ—]\s*([\d\-â€“s]+)/);
    if (compactMatch) {
      return { sets: parseInt(compactMatch[1]), reps: compactMatch[2] };
    }

    // Try separate format: "Sets: 3" "Reps: 8"
    const setsMatch = text.match(/(?:sets?|serije):\s*(\d+)/i);
    const repsMatch = text.match(/(?:reps?|ponavljanja):\s*([\d\-â€“s]+)/i);

    return {
      sets: setsMatch ? parseInt(setsMatch[1]) : null,
      reps: repsMatch ? repsMatch[1] : null
    };
  };

  const workouts = [];
  let currentWorkout = null;
  let currentExercise = null;
  const lines = markdownText.split('\n');

  for (let line of lines) {
    line = line.trim();

    // Skip empty lines, dividers, and markdown table alignment rows
    if (!line || line.startsWith('|---') || line === '---' ||
        (line.startsWith('|') && line.includes(':---')) ||  // Markdown table alignment (| :--- | :---: |)
        (line.startsWith('**') && line.endsWith('**') && line.length < 100 && !line.includes(':'))) continue;

    const upperLine = line.toUpperCase();

    // STEP 1: Detect workout day headers using intelligent heuristics
    if (isWorkoutDayHeader(line, upperLine)) {
      // Save previous workout
      if (currentWorkout && currentWorkout.exercises.length > 0) {
        workouts.push(currentWorkout);
      }

      // Extract emoji
      const emojiMatch = line.match(/[\u{1F300}-\u{1F9FF}]/u);
      const emoji = emojiMatch ? emojiMatch[0] : 'ðŸ”¥';

      // Clean up name
      let name = line.replace(/^#+\s*/, '').replace(emoji, '').trim();

      currentWorkout = {
        id: Date.now() + workouts.length,
        name: name || 'Workout',
        emoji: emoji,
        exercises: []
      };
      currentExercise = null;
      continue;
    }

    // STEP 2: Append descriptions (H3, bold lines with "Fokus"/"Focus"/"Description")
    if (line.startsWith('###') || (line.match(/^\*\*(.+?)\*\*/) && currentWorkout)) {
      const description = line.replace(/^###\s*/, '').replace(/^\*\*/, '').replace(/\*\*$/, '').trim();

      // Only append if it looks like a description (contains keywords or is short)
      const isDescription = description.length < 80 &&
                           (description.toLowerCase().includes('fokus') ||
                            description.toLowerCase().includes('focus') ||
                            description.toLowerCase().includes(':'));

      if (isDescription && currentWorkout) {
        const cleanDesc = description.replace(/^(?:fokus|focus):\s*/i, '').trim();
        if (cleanDesc && !currentWorkout.name.includes(cleanDesc)) {
          currentWorkout.name = `${currentWorkout.name} - ${cleanDesc}`;
        }
      }
      continue;
    }

    // STEP 3: Parse table rows (most common format)
    if (line.startsWith('|') && line.endsWith('|')) {
      const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell);

      // Skip headers
      if (isTableHeader(cells)) continue;

      // Auto-create workout if table appears without header
      if (!currentWorkout) {
        currentWorkout = {
          id: Date.now(),
          name: 'Workout',
          emoji: 'ðŸ”¥',
          exercises: []
        };
      }

      // Smart column detection - find exercise name, sets, reps
      if (cells.length >= 2) {
        // Remove bold markers (**text**) and italic markers (*text* or _text_)
        const exerciseName = cells[0].trim()
          .replace(/^\*\*/, '').replace(/\*\*$/, '')  // Remove bold
          .replace(/^\*/, '').replace(/\*$/, '')      // Remove italic (*)
          .replace(/^_/, '').replace(/_$/, '');       // Remove italic (_)

        // Skip if first cell looks like data, not exercise name
        if (exerciseName.length < 3 || /^\d+$/.test(exerciseName)) continue;

        let sets = 3, reps = 10, notes = '';

        // Intelligently detect which columns contain sets/reps
        for (let i = 1; i < cells.length; i++) {
          const cell = cells[i];
          const extracted = extractSetsReps(cell);

          if (extracted.sets !== null) sets = extracted.sets;
          if (extracted.reps !== null) reps = extracted.reps;

          // Check if cell is pure number (likely sets or reps)
          if (/^\d+$/.test(cell) && i === 1) sets = parseInt(cell);
          else if (/^[\d\-â€“s]+$/.test(cell) && i === 2) reps = cell;

          // Last column or cells with text = notes
          if (i >= 4 && cell.length > 2 && !/^\d/.test(cell)) {
            // Clean up notes (remove bold/italic markers)
            notes = cell
              .replace(/\*\*/g, '')  // Remove all bold markers
              .replace(/\*/g, '')    // Remove all italic markers (*)
              .replace(/_/g, '');    // Remove all italic markers (_)
          }
        }

        currentWorkout.exercises.push({ name: exerciseName, sets, reps, notes });
      }
      continue;
    }

    // STEP 4: Parse list/heading format exercises (## Exercise or - Exercise)
    if (line.startsWith('##') && !isWorkoutDayHeader(line, upperLine)) {
      // Auto-create workout if needed
      if (!currentWorkout) {
        currentWorkout = {
          id: Date.now(),
          name: 'Workout',
          emoji: 'ðŸ”¥',
          exercises: []
        };
      }

      // Remove header marker and formatting (bold/italic)
      const exerciseName = line.replace(/^##\s*/, '').trim()
        .replace(/^\*\*/, '').replace(/\*\*$/, '')  // Remove bold
        .replace(/^\*/, '').replace(/\*$/, '')      // Remove italic (*)
        .replace(/^_/, '').replace(/_$/, '');       // Remove italic (_)

      currentExercise = { name: exerciseName, sets: 3, reps: 10, notes: '' };
      currentWorkout.exercises.push(currentExercise);
      continue;
    }

    // STEP 5: Parse exercise details (sets/reps/notes on following lines)
    if (currentExercise) {
      const extracted = extractSetsReps(line);
      if (extracted.sets) currentExercise.sets = extracted.sets;
      if (extracted.reps) currentExercise.reps = extracted.reps;

      // Notes detection
      const notesMatch = line.match(/(?:notes?|napomena):\s*(.+)/i);
      if (notesMatch) currentExercise.notes = notesMatch[1];
    }
  }

  // Save last workout
  if (currentWorkout && currentWorkout.exercises.length > 0) {
    workouts.push(currentWorkout);
  }

  // Auto-assign icons cyclically
  const defaultIcons = ['ðŸ¦µ', 'ðŸ’ª', 'âš¡', 'ðŸŽ¯', 'ðŸ”¥'];
  workouts.forEach((workout, idx) => {
    if (workout.emoji === 'ðŸ”¥') {
      workout.emoji = defaultIcons[idx % defaultIcons.length];
    }
  });

  return workouts;
};

// CSV/Excel parser - auto-detects workout structure
const parseCSVWorkout = (csvText) => {
  const workouts = [];
  let currentWorkout = null;

  // Parse CSV (simple split by comma, handling quoted values)
  const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);

  // Helper: Parse CSV line with quoted value support
  const parseCSVLine = (line) => {
    const cells = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];

      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        cells.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    cells.push(current.trim());
    return cells;
  };

  // Detect headers
  let headerRow = null;
  let workoutColIdx = -1, exerciseColIdx = -1, setsColIdx = -1, repsColIdx = -1, notesColIdx = -1;

  for (let i = 0; i < Math.min(5, lines.length); i++) {
    const cells = parseCSVLine(lines[i]);
    const lowerCells = cells.map(c => c.toLowerCase());

    // Check if this looks like a header row
    if (lowerCells.some(c => c.includes('workout') || c.includes('day') || c.includes('exercise') ||
                             c.includes('vjeÅ¾ba') || c.includes('sets') || c.includes('serije'))) {
      headerRow = i;

      // Find column indices
      lowerCells.forEach((cell, idx) => {
        if (cell.includes('workout') || cell.includes('day') || cell.includes('dan')) workoutColIdx = idx;
        if (cell.includes('exercise') || cell.includes('vjeÅ¾ba') || cell.includes('vjezba')) exerciseColIdx = idx;
        if (cell.includes('sets') || cell.includes('serije')) setsColIdx = idx;
        if (cell.includes('reps') || cell.includes('ponavljanja')) repsColIdx = idx;
        if (cell.includes('notes') || cell.includes('napomena')) notesColIdx = idx;
      });
      break;
    }
  }

  // If no clear headers, assume first row is header and guess columns
  if (headerRow === null) {
    headerRow = 0;
    const firstDataRow = lines.length > 1 ? parseCSVLine(lines[1]) : [];

    // Guess: Column 0 = workout/exercise, Column 1 = sets, Column 2 = reps
    if (firstDataRow.length >= 3) {
      exerciseColIdx = 0;
      setsColIdx = 1;
      repsColIdx = 2;
      if (firstDataRow.length >= 4) notesColIdx = 3;
    }
  }

  // Parse data rows
  for (let i = headerRow + 1; i < lines.length; i++) {
    const cells = parseCSVLine(lines[i]);
    if (cells.length === 0 || cells.every(c => !c)) continue;

    // Check if this row defines a new workout day
    const workoutName = workoutColIdx >= 0 && cells[workoutColIdx] ? cells[workoutColIdx].trim() : '';
    const exerciseName = exerciseColIdx >= 0 && cells[exerciseColIdx] ? cells[exerciseColIdx].trim() : cells[0]?.trim() || '';

    // If workout column has value, start new workout
    if (workoutName && workoutName !== currentWorkout?.name) {
      if (currentWorkout && currentWorkout.exercises.length > 0) {
        workouts.push(currentWorkout);
      }

      currentWorkout = {
        id: Date.now() + workouts.length,
        name: workoutName,
        emoji: 'ðŸ”¥',
        exercises: []
      };
    }

    // Auto-create workout if no workout column exists
    if (!currentWorkout) {
      currentWorkout = {
        id: Date.now(),
        name: 'Imported Workout',
        emoji: 'ðŸ”¥',
        exercises: []
      };
    }

    // Add exercise if we have a name
    if (exerciseName && exerciseName.length >= 2) {
      const sets = setsColIdx >= 0 && cells[setsColIdx] ? parseInt(cells[setsColIdx]) || 3 : 3;
      const reps = repsColIdx >= 0 && cells[repsColIdx] ? cells[repsColIdx] : '10';
      const notes = notesColIdx >= 0 && cells[notesColIdx] ? cells[notesColIdx] : '';

      currentWorkout.exercises.push({
        name: exerciseName,
        sets: sets,
        reps: reps,
        notes: notes
      });
    }
  }

  // Save last workout
  if (currentWorkout && currentWorkout.exercises.length > 0) {
    workouts.push(currentWorkout);
  }

  // Auto-assign icons
  const defaultIcons = ['ðŸ¦µ', 'ðŸ’ª', 'âš¡', 'ðŸŽ¯', 'ðŸ”¥'];
  workouts.forEach((workout, idx) => {
    if (workout.emoji === 'ðŸ”¥') {
      workout.emoji = defaultIcons[idx % defaultIcons.length];
    }
  });

  return workouts;
};

// Sound system - generates subtle beeps using Web Audio API
const soundSystem = {
  audioContext: null,

  init() {
    if (!this.audioContext) {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
  },

  playTone(frequency, duration, volume = 0.3) {
    if (!this.audioContext) this.init();

    const oscillator = this.audioContext.createOscillator();
    const gainNode = this.audioContext.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(this.audioContext.destination);

    oscillator.frequency.value = frequency;
    oscillator.type = 'sine';

    gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);

    oscillator.start(this.audioContext.currentTime);
    oscillator.stop(this.audioContext.currentTime + duration);
  },

  appLaunch() {
    // Gentle ascending beep
    this.playTone(440, 0.1, 0.2);
    setTimeout(() => this.playTone(554, 0.15, 0.15), 80);
  },

  workoutStart() {
    // Energetic double beep
    this.playTone(523, 0.12, 0.25);
    setTimeout(() => this.playTone(659, 0.15, 0.2), 100);
  },

  workoutComplete() {
    // Satisfying success chord
    this.playTone(523, 0.15, 0.2);
    setTimeout(() => this.playTone(659, 0.15, 0.2), 100);
    setTimeout(() => this.playTone(784, 0.25, 0.25), 200);
  }
};

const WorkoutTracker = () => {
  const [workouts, setWorkouts] = useState([
    {
      id: 1,
      name: "DAY 1 â€“ PUSH A (TeÅ¡ki Bench & Kvadriceps)",
      emoji: "ðŸ¦µ",
      exercises: [
        { name: "Bench Press", sets: 3, reps: 5, notes: "Glavni lift. Zadnja serija AMRAP." },
        { name: "Back Squat (ÄŒuÄanj)", sets: 3, reps: 8, notes: "Fokus na dubinu i kontrolu." },
        { name: "Lateral Raises", sets: 4, reps: "15â€“20", notes: "Mala teÅ¾ina, \"burn\" efekt." },
        { name: "Triceps Pushdown", sets: 3, reps: 12, notes: "Fokus na puni lockout." },
        { name: "Ab Wheel Rollout", sets: 3, reps: "8â€“10", notes: "Anti-extension core (Ävrsta leÄ‘a)." }
      ]
    },
    {
      id: 2,
      name: "DAY 2 â€“ PULL A (Mrtvo dizanje & Å irina leÄ‘a)",
      emoji: "ðŸ’ª",
      exercises: [
        { name: "Trap Bar Deadlift", sets: 3, reps: 5, notes: "Eksplozivno s poda." },
        { name: "Zgibovi / Lat Pulldown", sets: 3, reps: "8â€“10", notes: "Å iroki hvat za V-taper." },
        { name: "Face Pulls", sets: 3, reps: 15, notes: "Pauza 1 s u kontrakciji." },
        { name: "Hammer Curls", sets: 3, reps: 12, notes: "Za debljinu bicepsa i podlaktice." },
        { name: "Back Extension", sets: 3, reps: 12, notes: "JaÄanje donjeg dijela leÄ‘a." },
        { name: "Dead Bug", sets: 2, reps: "10/str", notes: "Core stabilnost bez pritiska na leÄ‘a." }
      ]
    },
    {
      id: 3,
      name: "DAY 3 â€“ PUSH B (TeÅ¡ki OHP & Gornja prsa)",
      emoji: "âš¡",
      exercises: [
        { name: "Overhead Press (OHP)", sets: 3, reps: "5â€“6", notes: "Stisnuti gluteusi, bez varanja." },
        { name: "Bugarski Iskorak", sets: 3, reps: 10, notes: "Po nozi. KljuÄ za atletski izgled." },
        { name: "Incline DB Press", sets: 3, reps: "10â€“12", notes: "Fokus na gornji dio prsa." },
        { name: "Dips (PropadaÄi)", sets: 3, reps: "Do otkaza", notes: "Nagnut trup prema naprijed." },
        { name: "Pallof Press", sets: 3, reps: "12/str", notes: "Anti-rotation core snaga." },
        { name: "Side Plank", sets: 2, reps: "30â€“45 s", notes: "Stabilnost boÄnog trbuÅ¡nog zida." }
      ]
    },
    {
      id: 4,
      name: "DAY 4 â€“ PULL B (Zadnja loÅ¾a & Debljina leÄ‘a)",
      emoji: "ðŸŽ¯",
      exercises: [
        { name: "Rumunjsko Mrtvo (RDL)", sets: 3, reps: 10, notes: "Fokus na istezanje zadnje loÅ¾e." },
        { name: "Dumbbell Row", sets: 3, reps: 10, notes: "Lakat vuÄ‡i prema kuku." },
        { name: "Farmer's Walk", sets: 3, reps: "40 m", notes: "TeÅ¡ke buÄice (drÅ¾anje i trbuh)." },
        { name: "Hanging Leg Raises", sets: 3, reps: "12â€“15", notes: "Kontrolirano podizanje nogu." },
        { name: "Back Extension Hold", sets: 2, reps: "30 s", notes: "IzdrÅ¾ljivost erektora leÄ‘a." }
      ]
    }
  ]);

  const [completedWorkouts, setCompletedWorkouts] = useState([]);
  const [activeView, setActiveView] = useState('home');
  const [currentLog, setCurrentLog] = useState(null);
  const [editingWorkout, setEditingWorkout] = useState(null);
  const [loading, setLoading] = useState(true);
  const [darkMode, setDarkMode] = useState(true);
  const [showStats, setShowStats] = useState(false);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(null);
  const [showAddDay, setShowAddDay] = useState(false);
  const [showDeleteHistory, setShowDeleteHistory] = useState(null);
  const [showUploadModal, setShowUploadModal] = useState(false);
  const [parsedWorkouts, setParsedWorkouts] = useState([]);
  const [draggedExerciseIndex, setDraggedExerciseIndex] = useState(null);
  const [draggedExercisePosition, setDraggedExercisePosition] = useState({ x: 0, y: 0 });
  const [dragStartPosition, setDragStartPosition] = useState({ x: 0, y: 0 });
  const [isDraggingExercise, setIsDraggingExercise] = useState(false);
  const [dropTargetIndex, setDropTargetIndex] = useState(null);
  const [timelineRange, setTimelineRange] = useState('4weeks'); // '4weeks', '3months', '6months', 'all'
  const [selectedTimelinePoint, setSelectedTimelinePoint] = useState(null);
  const fileInputRef = React.useRef(null);
  const dragExerciseRef = React.useRef(null);

  useEffect(() => {
    loadData();
    // Load theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      setDarkMode(savedTheme === 'dark');
    }

    // Play app launch sound after short delay
    setTimeout(() => {
      soundSystem.appLaunch();
    }, 500);
  }, []);

  // Global drag event listeners
  useEffect(() => {
    const handleGlobalMouseMove = (e) => {
      if (draggedExerciseIndex !== null) {
        handleExerciseDragMove(e);
      }
    };

    const handleGlobalMouseUp = (e) => {
      if (draggedExerciseIndex !== null) {
        handleExerciseDragEnd();
      }
    };

    const handleGlobalTouchMove = (e) => {
      if (draggedExerciseIndex !== null) {
        handleExerciseDragMove(e);
      }
    };

    const handleGlobalTouchEnd = (e) => {
      if (draggedExerciseIndex !== null) {
        handleExerciseDragEnd();
      }
    };

    if (draggedExerciseIndex !== null) {
      document.addEventListener('mousemove', handleGlobalMouseMove);
      document.addEventListener('mouseup', handleGlobalMouseUp);
      document.addEventListener('touchmove', handleGlobalTouchMove, { passive: false });
      document.addEventListener('touchend', handleGlobalTouchEnd);
    }

    return () => {
      document.removeEventListener('mousemove', handleGlobalMouseMove);
      document.removeEventListener('mouseup', handleGlobalMouseUp);
      document.removeEventListener('touchmove', handleGlobalTouchMove);
      document.removeEventListener('touchend', handleGlobalTouchEnd);
    };
  }, [draggedExerciseIndex, dragStartPosition]);

  const loadData = async () => {
    try {
      setLoading(true);
      const savedWorkouts = await dbOperations.getWorkouts();
      const savedHistory = await dbOperations.getHistory();
      
      if (savedWorkouts && savedWorkouts.length > 0) {
        setWorkouts(savedWorkouts);
      } else {
        await dbOperations.saveWorkouts(workouts);
      }
      
      if (savedHistory && savedHistory.length > 0) {
        setCompletedWorkouts(savedHistory);
      }
    } catch (error) {
      console.error('Error loading data:', error);
    } finally {
      setLoading(false);
    }
  };

  const saveWorkouts = async (newWorkouts) => {
    try {
      await dbOperations.saveWorkouts(newWorkouts);
      setWorkouts(newWorkouts);
    } catch (error) {
      console.error('Error saving workouts:', error);
    }
  };

  const saveHistory = async (newHistoryItem) => {
    try {
      await dbOperations.saveHistory(newHistoryItem);
      const allHistory = await dbOperations.getHistory();
      setCompletedWorkouts(allHistory);
    } catch (error) {
      console.error('Error saving history:', error);
    }
  };

  const getLastWeight = (exerciseName) => {
    for (let i = completedWorkouts.length - 1; i >= 0; i--) {
      const workout = completedWorkouts[i];
      const exercise = workout.exercises.find(ex => ex.name === exerciseName);
      if (exercise && exercise.sets.length > 0) {
        const lastSet = exercise.sets.find(s => s.weight);
        if (lastSet) return lastSet.weight;
      }
    }
    return '';
  };

  const startWorkout = (workout) => {
    soundSystem.workoutStart(); // Play sound

    const log = {
      workoutId: workout.id,
      workoutName: workout.name,
      workoutEmoji: workout.emoji,
      date: new Date().toISOString(),
      exercises: workout.exercises.map(ex => {
        const lastWeight = getLastWeight(ex.name);
        return {
          name: ex.name,
          plannedSets: ex.sets,
          plannedReps: ex.reps,
          sets: Array(ex.sets).fill(null).map(() => ({
            weight: lastWeight,
            reps: ex.reps,
            completed: false
          }))
        };
      })
    };
    setCurrentLog(log);
    setActiveView('logging');
  };

  const updateSet = (exerciseIndex, setIndex, field, value) => {
    const updated = { ...currentLog };
    
    // If updating weight, replace comma with dot for decimal support
    if (field === 'weight' && value) {
      value = value.replace(',', '.');
    }
    
    updated.exercises[exerciseIndex].sets[setIndex][field] = value;
    setCurrentLog(updated);
  };

  const toggleSetComplete = (exerciseIndex, setIndex) => {
    const updated = { ...currentLog };
    updated.exercises[exerciseIndex].sets[setIndex].completed = 
      !updated.exercises[exerciseIndex].sets[setIndex].completed;
    setCurrentLog(updated);
  };

  const finishWorkout = async () => {
    soundSystem.workoutComplete(); // Play sound
    await saveHistory(currentLog);
    setCurrentLog(null);
    setActiveView('home');
  };

  const exportToCSV = () => {
    if (completedWorkouts.length === 0) {
      alert('No workout data to export yet!');
      return;
    }

    const headers = ['Date', 'Workout', 'Exercise', 'Set', 'Weight', 'Reps'];
    const rows = [headers];

    completedWorkouts.forEach(workout => {
      workout.exercises.forEach(exercise => {
        exercise.sets.forEach((set, idx) => {
          rows.push([
            new Date(workout.date).toLocaleDateString('hr-HR'),
            workout.workoutName,
            exercise.name,
            idx + 1,
            set.weight || '',
            set.reps || ''
          ]);
        });
      });
    });

    const csv = rows.map(row => row.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `workout-data-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const startEditWorkout = (workout) => {
    setEditingWorkout(JSON.parse(JSON.stringify(workout)));
    setActiveView('edit');
  };

  const updateExercise = (index, field, value) => {
    const updated = { ...editingWorkout };
    updated.exercises[index][field] = value;
    setEditingWorkout(updated);
  };

  const addExercise = () => {
    const updated = { ...editingWorkout };
    updated.exercises.push({ name: '', sets: 3, reps: 10, notes: '' });
    setEditingWorkout(updated);
  };

  const deleteExercise = (index) => {
    const updated = { ...editingWorkout };
    updated.exercises.splice(index, 1);
    setEditingWorkout(updated);
  };

  const reorderExercise = (fromIndex, toIndex) => {
    if (fromIndex === toIndex) return;

    const updated = { ...editingWorkout };
    const exercises = [...updated.exercises];
    const [movedExercise] = exercises.splice(fromIndex, 1);
    exercises.splice(toIndex, 0, movedExercise);
    updated.exercises = exercises;
    setEditingWorkout(updated);
  };

  const handleExerciseDragStart = (e, index) => {
    e.stopPropagation();

    const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
    const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;

    setDraggedExerciseIndex(index);
    setDragStartPosition({ x: clientX, y: clientY });
    setDraggedExercisePosition({ x: clientX, y: clientY });
    setIsDraggingExercise(false); // Not dragging until moved a bit
    soundSystem.buttonPress();
  };

  const handleExerciseDragMove = (e) => {
    if (draggedExerciseIndex === null) return;

    e.preventDefault();
    const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
    const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;

    // Start dragging if moved more than 5px
    const distance = Math.sqrt(
      Math.pow(clientX - dragStartPosition.x, 2) +
      Math.pow(clientY - dragStartPosition.y, 2)
    );

    if (distance > 5) {
      setIsDraggingExercise(true);
    }

    setDraggedExercisePosition({ x: clientX, y: clientY });

    // Find which exercise we're hovering over
    const exerciseElements = document.querySelectorAll('[data-exercise-index]');
    let foundTarget = null;

    exerciseElements.forEach(el => {
      const rect = el.getBoundingClientRect();
      const elIndex = parseInt(el.dataset.exerciseIndex);

      if (elIndex !== draggedExerciseIndex &&
          clientY >= rect.top && clientY <= rect.bottom) {
        foundTarget = elIndex;
      }
    });

    setDropTargetIndex(foundTarget);
  };

  const handleExerciseDragEnd = () => {
    if (draggedExerciseIndex !== null && dropTargetIndex !== null && isDraggingExercise) {
      reorderExercise(draggedExerciseIndex, dropTargetIndex);
      soundSystem.setComplete();
    }

    setDraggedExerciseIndex(null);
    setIsDraggingExercise(false);
    setDropTargetIndex(null);
    setDraggedExercisePosition({ x: 0, y: 0 });
  };

  const saveEditedWorkout = async () => {
    const updatedWorkouts = workouts.map(w =>
      w.id === editingWorkout.id ? editingWorkout : w
    );
    await saveWorkouts(updatedWorkouts);
    setEditingWorkout(null);
    setActiveView('home');
  };

  const toggleTheme = () => {
    const newMode = !darkMode;
    setDarkMode(newMode);
    localStorage.setItem('theme', newMode ? 'dark' : 'light');
  };

  const deleteWorkoutDay = async (workoutId) => {
    const updatedWorkouts = workouts.filter(w => w.id !== workoutId);
    await saveWorkouts(updatedWorkouts);
    setShowDeleteConfirm(null);
  };

  const addNewWorkoutDay = async () => {
    const newId = Math.max(...workouts.map(w => w.id), 0) + 1;
    const newWorkout = {
      id: newId,
      name: `Dan ${newId}: New Workout`,
      emoji: "ðŸ”¥",
      exercises: [
        { name: "New Exercise", sets: 3, reps: 10, notes: "" }
      ]
    };
    const updatedWorkouts = [...workouts, newWorkout];
    await saveWorkouts(updatedWorkouts);
    setShowAddDay(false);
    startEditWorkout(newWorkout);
  };

  const triggerFileUpload = () => {
    // Mobile-friendly file input trigger
    if (fileInputRef.current) {
      // Reset the input first to allow re-uploading the same file
      fileInputRef.current.value = '';

      // Use setTimeout to ensure the click happens in a fresh event loop
      // This helps with iOS Safari compatibility
      setTimeout(() => {
        fileInputRef.current?.click();
      }, 100);
    }
  };

  const handleFileChange = async (e) => {
    const file = e.target.files?.[0];
    if (!file) {
      console.log('No file selected');
      return;
    }

    console.log('File selected:', file.name, 'Size:', file.size, 'Type:', file.type);

    const fileName = file.name.toLowerCase();
    const isMarkdown = fileName.endsWith('.md');
    const isCSV = fileName.endsWith('.csv');
    const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');

    if (!isMarkdown && !isCSV && !isExcel) {
      alert('Please upload a markdown (.md), CSV (.csv), or Excel (.xlsx/.xls) file');
      e.target.value = '';
      return;
    }

    try {
      let parsed = [];

      if (isMarkdown) {
        const text = await file.text();
        console.log('Markdown text length:', text.length);
        console.log('First 200 chars:', text.substring(0, 200));
        parsed = parseMarkdownWorkout(text);
        console.log('Parsed workouts:', parsed.length, parsed);
      } else if (isCSV) {
        const text = await file.text();
        console.log('CSV text length:', text.length);
        parsed = parseCSVWorkout(text);
        console.log('Parsed workouts:', parsed.length, parsed);
      } else if (isExcel) {
        alert('Excel files (.xlsx/.xls) support coming soon! For now, please export to CSV and upload that file.');
        e.target.value = '';
        return;
      }

      if (parsed && parsed.length > 0) {
        console.log('Setting parsed workouts and showing modal');
        setParsedWorkouts(parsed);
        setShowUploadModal(true);
      } else {
        alert(`No valid workouts found in the file. Please check the format.\n\nFile: ${file.name}\nSize: ${file.size} bytes`);
      }
    } catch (error) {
      console.error('Error parsing file:', error);
      alert(`Failed to parse file: ${error.message}\n\nFile: ${file.name}\nPlease check the console for details.`);
    }

    // Reset input
    e.target.value = '';
  };

  const handleImportChoice = async (choice) => {
    let finalWorkouts;

    if (choice === 'replace') {
      finalWorkouts = parsedWorkouts;
    } else {
      // Add to existing - ensure unique IDs
      const maxId = Math.max(...workouts.map(w => w.id), 0);
      const updatedParsed = parsedWorkouts.map((w, idx) => ({
        ...w,
        id: maxId + idx + 1
      }));
      finalWorkouts = [...workouts, ...updatedParsed];
    }

    await saveWorkouts(finalWorkouts);
    setShowUploadModal(false);
    setParsedWorkouts([]);
    alert(`Successfully imported ${parsedWorkouts.length} workout day(s)!`);
  };

  const deleteHistoryEntry = async (entryId) => {
    try {
      const db = await initDB();
      const tx = db.transaction('history', 'readwrite');
      const store = tx.objectStore('history');
      
      await store.delete(entryId);
      
      await new Promise((resolve, reject) => {
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      });
      
      // Reload history
      const allHistory = await dbOperations.getHistory();
      setCompletedWorkouts(allHistory);
      setShowDeleteHistory(null);
    } catch (error) {
      console.error('Error deleting history entry:', error);
    }
  };

  const getWeekStats = () => {
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const recentWorkouts = completedWorkouts.filter(w => new Date(w.date) >= weekAgo);
    
    let totalVolume = 0;
    let totalReps = 0;
    let coreSets = 0;
    let totalSets = 0;
    
    recentWorkouts.forEach(workout => {
      workout.exercises.forEach(exercise => {
        const isCoreExercise = exercise.name.toLowerCase().includes('core') || 
                               exercise.name.toLowerCase().includes('plank') ||
                               exercise.name.toLowerCase().includes('hanging');
        
        exercise.sets.forEach(set => {
          const weight = parseFloat(set.weight) || 0;
          const reps = parseFloat(set.reps) || 0;
          
          // Skip sets with no data (skipped exercises)
          if (reps === 0 && weight === 0) return;
          
          if (isCoreExercise && reps > 0) {
            // Core exercises count separately
            coreSets += 1;
          } else if (weight > 0 && reps > 0) {
            // Only count volume and reps for weighted exercises
            totalVolume += weight * reps;
            totalReps += reps;
            totalSets += 1;
          }
        });
      });
    });
    
    return {
      count: recentWorkouts.length,
      totalSets: totalSets,
      coreSets: coreSets,
      totalVolume: Math.round(totalVolume),
      totalReps: totalReps
    };
  };

  const getDetailedStats = () => {
    const now = new Date();
    const thisWeekStart = new Date(now);
    thisWeekStart.setDate(now.getDate() - 7);
    const lastWeekStart = new Date(now);
    lastWeekStart.setDate(now.getDate() - 14);
    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    
    const calculatePeriodStats = (workouts) => {
      let volume = 0;
      let reps = 0;
      let sets = 0;
      let coreSets = 0;
      
      workouts.forEach(workout => {
        workout.exercises.forEach(exercise => {
          const isCoreExercise = exercise.name.toLowerCase().includes('core') || 
                                 exercise.name.toLowerCase().includes('plank') ||
                                 exercise.name.toLowerCase().includes('hanging');
          
          exercise.sets.forEach(set => {
            const weight = parseFloat(set.weight) || 0;
            const rep = parseFloat(set.reps) || 0;
            
            // Skip empty sets (skipped exercises)
            if (rep === 0 && weight === 0) return;
            
            if (isCoreExercise && rep > 0) {
              // Core exercises counted separately
              coreSets += 1;
            } else if (weight > 0 && rep > 0) {
              // Only count weighted exercises
              volume += weight * rep;
              reps += rep;
              sets += 1;
            }
          });
        });
      });
      
      return { volume: Math.round(volume), reps, sets, coreSets, workouts: workouts.length };
    };
    
    const thisWeekWorkouts = completedWorkouts.filter(w => new Date(w.date) >= thisWeekStart);
    const lastWeekWorkouts = completedWorkouts.filter(w => 
      new Date(w.date) >= lastWeekStart && new Date(w.date) < thisWeekStart
    );
    const thisMonthWorkouts = completedWorkouts.filter(w => new Date(w.date) >= thisMonthStart);
    const lastMonthWorkouts = completedWorkouts.filter(w => 
      new Date(w.date) >= lastMonthStart && new Date(w.date) < thisMonthStart
    );
    
    const thisWeek = calculatePeriodStats(thisWeekWorkouts);
    const lastWeek = calculatePeriodStats(lastWeekWorkouts);
    const thisMonth = calculatePeriodStats(thisMonthWorkouts);
    const lastMonth = calculatePeriodStats(lastMonthWorkouts);
    
    const volumeChange = lastWeek.volume > 0 
      ? Math.round(((thisWeek.volume - lastWeek.volume) / lastWeek.volume) * 100) 
      : 0;
    
    const monthVolumeChange = lastMonth.volume > 0
      ? Math.round(((thisMonth.volume - lastMonth.volume) / lastMonth.volume) * 100)
      : 0;
    
    // Personal records - only track main lifts
    const mainLiftsForPRs = {
      'Mrtvo dizanje (Trap Bar)': null,
      'Squat': null,
      'Bench Press': null,
      'Overhead Press (vojniÄki press)': null,
      'Lat Pulldown (ili zgibovi)': null
    };
    
    completedWorkouts.forEach(workout => {
      workout.exercises.forEach(exercise => {
        exercise.sets.forEach(set => {
          const weight = parseFloat(set.weight) || 0;
          if (weight > 0) {
            // Check for Deadlift
            if (exercise.name.includes('Mrtvo dizanje')) {
              if (!mainLiftsForPRs['Mrtvo dizanje (Trap Bar)'] || weight > mainLiftsForPRs['Mrtvo dizanje (Trap Bar)']) {
                mainLiftsForPRs['Mrtvo dizanje (Trap Bar)'] = weight;
              }
            }
            // Check for Squat (Front or Back)
            else if (exercise.name.includes('ÄŒuÄanj')) {
              if (!mainLiftsForPRs['Squat'] || weight > mainLiftsForPRs['Squat']) {
                mainLiftsForPRs['Squat'] = weight;
              }
            }
            // Check for Bench Press (regular or Incline)
            else if (exercise.name.includes('Bench Press')) {
              if (!mainLiftsForPRs['Bench Press'] || weight > mainLiftsForPRs['Bench Press']) {
                mainLiftsForPRs['Bench Press'] = weight;
              }
            }
            // Check for Overhead Press
            else if (exercise.name.includes('Overhead Press')) {
              if (!mainLiftsForPRs['Overhead Press (vojniÄki press)'] || weight > mainLiftsForPRs['Overhead Press (vojniÄki press)']) {
                mainLiftsForPRs['Overhead Press (vojniÄki press)'] = weight;
              }
            }
            // Check for Lat Pulldown or Pull-ups
            else if (exercise.name.includes('Lat Pulldown') || exercise.name.includes('Zgibovi')) {
              if (!mainLiftsForPRs['Lat Pulldown (ili zgibovi)'] || weight > mainLiftsForPRs['Lat Pulldown (ili zgibovi)']) {
                mainLiftsForPRs['Lat Pulldown (ili zgibovi)'] = weight;
              }
            }
          }
        });
      });
    });
    
    // Filter out lifts with no data
    const exerciseMaxes = {};
    Object.entries(mainLiftsForPRs).forEach(([lift, weight]) => {
      if (weight !== null) {
        exerciseMaxes[lift] = weight;
      }
    });
    
    // Average per workout
    const avgVolumePerWorkout = thisWeek.workouts > 0 
      ? Math.round(thisWeek.volume / thisWeek.workouts) 
      : 0;
    
    // Calculate all-time total volume
    let allTimeVolume = 0;
    completedWorkouts.forEach(workout => {
      workout.exercises.forEach(exercise => {
        const isCoreExercise = exercise.name.toLowerCase().includes('core') || 
                               exercise.name.toLowerCase().includes('plank') ||
                               exercise.name.toLowerCase().includes('hanging');
        
        exercise.sets.forEach(set => {
          const weight = parseFloat(set.weight) || 0;
          const rep = parseFloat(set.reps) || 0;
          
          if (!isCoreExercise && weight > 0 && rep > 0) {
            allTimeVolume += weight * rep;
          }
        });
      });
    });
    
    // Calculate average workouts per week
    let avgWorkoutsPerWeek = 0;
    if (completedWorkouts.length > 0) {
      // Sort workouts by date to find the earliest one
      const sortedWorkouts = [...completedWorkouts].sort((a, b) => new Date(a.date) - new Date(b.date));
      const firstWorkoutDate = new Date(sortedWorkouts[0].date);
      const lastWorkoutDate = new Date(sortedWorkouts[sortedWorkouts.length - 1].date);
      
      const daysBetween = (lastWorkoutDate - firstWorkoutDate) / (1000 * 60 * 60 * 24);
      const weeksBetween = daysBetween / 7;
      
      // If less than a week of data, use current week calculation
      if (weeksBetween < 1) {
        avgWorkoutsPerWeek = completedWorkouts.length;
      } else {
        avgWorkoutsPerWeek = Math.round((completedWorkouts.length / weeksBetween) * 10) / 10;
      }
    }
    
    return {
      thisWeek,
      lastWeek,
      thisMonth,
      lastMonth,
      volumeChange,
      monthVolumeChange,
      exerciseMaxes,
      avgVolumePerWorkout,
      totalWorkouts: completedWorkouts.length,
      allTimeVolume: Math.round(allTimeVolume),
      avgWorkoutsPerWeek
    };
  };

  const getTimelineData = () => {
    if (completedWorkouts.length === 0) return [];

    const now = new Date();
    let startDate;
    let groupBy = 'week'; // 'week' or 'month'

    // Determine date range based on timelineRange
    switch (timelineRange) {
      case '4weeks':
        startDate = new Date(now);
        startDate.setDate(now.getDate() - 28);
        groupBy = 'week';
        break;
      case '3months':
        startDate = new Date(now);
        startDate.setMonth(now.getMonth() - 3);
        groupBy = 'week';
        break;
      case '6months':
        startDate = new Date(now);
        startDate.setMonth(now.getMonth() - 6);
        groupBy = 'month';
        break;
      case 'all':
        const sortedWorkouts = [...completedWorkouts].sort((a, b) => new Date(a.date) - new Date(b.date));
        startDate = new Date(sortedWorkouts[0].date);
        // Determine groupBy based on data span
        const daysDiff = (now - startDate) / (1000 * 60 * 60 * 24);
        groupBy = daysDiff > 180 ? 'month' : 'week';
        break;
    }

    // Group workouts by week or month
    const grouped = {};

    completedWorkouts.forEach(workout => {
      const workoutDate = new Date(workout.date);
      if (workoutDate < startDate) return;

      let key;
      if (groupBy === 'week') {
        // Get start of week (Monday)
        const weekStart = new Date(workoutDate);
        const day = weekStart.getDay();
        const diff = weekStart.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday
        weekStart.setDate(diff);
        weekStart.setHours(0, 0, 0, 0);
        key = weekStart.toISOString().split('T')[0];
      } else {
        // Get start of month
        const monthStart = new Date(workoutDate.getFullYear(), workoutDate.getMonth(), 1);
        key = monthStart.toISOString().split('T')[0];
      }

      if (!grouped[key]) {
        grouped[key] = {
          date: key,
          workouts: [],
          volume: 0,
          frequency: 0,
          mainLifts: {
            deadlift: [],
            squat: [],
            bench: [],
            ohp: []
          }
        };
      }

      grouped[key].workouts.push(workout);
      grouped[key].frequency += 1;

      // Calculate volume and track main lifts
      workout.exercises.forEach(exercise => {
        const isCoreExercise = exercise.name.toLowerCase().includes('core') ||
                               exercise.name.toLowerCase().includes('plank') ||
                               exercise.name.toLowerCase().includes('hanging');

        exercise.sets.forEach(set => {
          const weight = parseFloat(set.weight) || 0;
          const reps = parseFloat(set.reps) || 0;

          if (weight === 0 && reps === 0) return; // Skip empty sets

          if (!isCoreExercise && weight > 0 && reps > 0) {
            grouped[key].volume += weight * reps;
          }

          // Track main lifts
          if (weight > 0) {
            if (exercise.name.toLowerCase().includes('deadlift') || exercise.name.toLowerCase().includes('mrtvo')) {
              grouped[key].mainLifts.deadlift.push(weight);
            } else if (exercise.name.toLowerCase().includes('squat') || exercise.name.toLowerCase().includes('ÄuÄanj')) {
              grouped[key].mainLifts.squat.push(weight);
            } else if (exercise.name.toLowerCase().includes('bench press')) {
              grouped[key].mainLifts.bench.push(weight);
            } else if (exercise.name.toLowerCase().includes('overhead press') || exercise.name.toLowerCase().includes('ohp')) {
              grouped[key].mainLifts.ohp.push(weight);
            }
          }
        });
      });

      // Get max weight for each main lift
      Object.keys(grouped[key].mainLifts).forEach(lift => {
        if (grouped[key].mainLifts[lift].length > 0) {
          grouped[key].mainLifts[lift] = Math.max(...grouped[key].mainLifts[lift]);
        } else {
          grouped[key].mainLifts[lift] = null;
        }
      });
    });

    // Convert to array and sort by date
    const timelineData = Object.values(grouped).sort((a, b) => new Date(a.date) - new Date(b.date));

    // Round volume
    timelineData.forEach(point => {
      point.volume = Math.round(point.volume);
    });

    return timelineData;
  };

  if (loading) {
    return (
      <div className={`min-h-screen ${darkMode ? 'bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950' : 'bg-gradient-to-br from-gray-100 via-white to-gray-100'} flex items-center justify-center`}>
        <div className="flex flex-col items-center gap-6">
          <Dumbbell size={120} className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} animate-pulse`} />
          <div className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Workout Pro</div>
        </div>
      </div>
    );
  }

  const stats = getWeekStats();
  const detailedStats = getDetailedStats();

  return (
    <div className={`min-h-screen ${darkMode ? 'bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950' : 'bg-gradient-to-br from-gray-100 via-white to-gray-100'} pb-24`}>
      {/* Header */}
      <div className={`sticky top-0 z-10 ${darkMode ? 'bg-gray-900/95' : 'bg-white/95'} ${darkMode ? 'border-gray-800' : 'border-gray-200'} border-b transform-gpu`}>
        <div className="max-w-6xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Dumbbell className={darkMode ? 'text-gray-400' : 'text-gray-600'} size={28} />
              <h1 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Workout Pro</h1>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={toggleTheme}
                className={`p-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg transition-colors`}
              >
                {darkMode ? <Sun size={20} className="text-gray-300" /> : <Moon size={20} className="text-gray-700" />}
              </button>
              {activeView === 'history' && (
                <button
                  onClick={exportToCSV}
                  disabled={completedWorkouts.length === 0}
                  className={`p-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg disabled:opacity-50`}
                >
                  <Download size={20} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                </button>
              )}
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-6xl mx-auto px-4 py-6">
        {activeView === 'home' && (
          <div className="space-y-6">
            {/* Stats Cards */}
            <div className="grid grid-cols-2 gap-4">
              <div className={`${darkMode ? 'bg-gradient-to-br from-gray-800 to-gray-700 border-gray-700' : 'bg-gradient-to-br from-gray-50 to-white border-gray-200'} rounded-2xl p-4 shadow-md border transform-gpu`}>
                <div className="flex items-center gap-2 mb-2">
                  <TrendingUp size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                  <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm font-medium`}>This Week</span>
                </div>
                <div className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{stats.count}</div>
                <div className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm`}>Workouts</div>
              </div>
              
              <div className={`${darkMode ? 'bg-gradient-to-br from-gray-800 to-gray-700 border-gray-700' : 'bg-gradient-to-br from-gray-50 to-white border-gray-200'} rounded-2xl p-4 shadow-md border transform-gpu`}>
                <div className="flex items-center gap-2 mb-2">
                  <Zap size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                  <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm font-medium`}>Volume</span>
                </div>
                <div className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{(stats.totalVolume / 1000).toFixed(1)}k</div>
                <div className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm`}>kg lifted</div>
              </div>

              <div className={`${darkMode ? 'bg-gradient-to-br from-gray-800 to-gray-700 border-gray-700' : 'bg-gradient-to-br from-gray-50 to-white border-gray-200'} rounded-2xl p-4 shadow-md border transform-gpu`}>
                <div className="flex items-center gap-2 mb-2">
                  <Dumbbell size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                  <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm font-medium`}>Total Reps</span>
                </div>
                <div className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{stats.totalReps}</div>
                <div className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm`}>{stats.totalSets} sets</div>
              </div>

              <div className={`${darkMode ? 'bg-gradient-to-br from-gray-800 to-gray-700 border-gray-700' : 'bg-gradient-to-br from-gray-50 to-white border-gray-200'} rounded-2xl p-4 shadow-md border transform-gpu`}>
                <div className="flex items-center gap-2 mb-2">
                  <Target size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                  <span className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm font-medium`}>Core Work</span>
                </div>
                <div className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{stats.coreSets}</div>
                <div className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm`}>sets completed</div>
              </div>
            </div>

            {/* View Detailed Stats Button */}
            <button
              onClick={() => setActiveView('stats')}
              className={`w-full ${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-4 flex items-center justify-between hover:scale-[1.02] transition-all`}
            >
              <div className="flex items-center gap-3">
                <BarChart3 size={24} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
                <div className="text-left">
                  <div className={`font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Detailed Statistics</div>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Progress tracking & PRs</div>
                </div>
              </div>
              <ChevronRight size={20} className={darkMode ? 'text-gray-500' : 'text-gray-400'} />
            </button>

            {/* Workouts */}
            <div>
              <div className="flex items-center justify-between mb-4">
                <h2 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} flex items-center gap-2`}>
                  <span>Your Program</span>
                </h2>
                <div className="flex gap-2">
                  {/* Mobile-friendly file upload using label */}
                  <label
                    htmlFor="workout-file-input"
                    className={`px-4 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-lg flex items-center gap-2 font-semibold transition-colors cursor-pointer active:scale-95 touch-manipulation`}
                  >
                    <Download size={18} />
                    Upload Program
                  </label>
                  <button
                    onClick={() => setShowAddDay(true)}
                    className={`px-4 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-lg flex items-center gap-2 font-semibold transition-colors`}
                  >
                    <PlusCircle size={18} />
                    Add Day
                  </button>
                </div>
              </div>

              {/* Mobile-friendly file input using both hidden input and id-based label */}
              <input
                id="workout-file-input"
                ref={fileInputRef}
                type="file"
                accept="*/*"
                onChange={handleFileChange}
                style={{display: 'none'}}
              />
              <div className="grid gap-4">
                {workouts.map(workout => (
                  <div
                    key={workout.id}
                    className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5 shadow-lg transform-gpu`}
                  >
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex items-center gap-3">
                        <WorkoutIcon emoji={workout.emoji} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                        <div>
                          <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{workout.name}</h3>
                          <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{workout.exercises.length} exercises</div>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={() => startEditWorkout(workout)}
                          className={`p-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg transition-colors`}
                        >
                          <Edit2 size={16} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                        </button>
                        <button
                          onClick={() => setShowDeleteConfirm(workout.id)}
                          className="p-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors"
                        >
                          <Trash2 size={16} className="text-white" />
                        </button>
                      </div>
                    </div>
                    
                    <button
                      onClick={() => startWorkout(workout)}
                      className={`w-full ${darkMode ? 'bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500' : 'bg-gradient-to-r from-gray-800 to-gray-700 hover:from-gray-700 hover:to-gray-600'} text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg`}
                    >
                      Start Workout
                      <ChevronRight size={20} />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {activeView === 'stats' && (
          <div className="space-y-4">
            <div className="flex items-center justify-between mb-4">
              <h2 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} flex items-center gap-2`}>
                <BarChart3 size={24} />
                Statistics
              </h2>
              <button
                onClick={() => setActiveView('home')}
                className={`p-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg`}
              >
                <X size={20} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
              </button>
            </div>

            {/* Weekly Progress */}
            <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5`}>
              <h3 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} mb-4`}>Weekly Progress</h3>
              
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Volume</div>
                  <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {(detailedStats.thisWeek.volume / 1000).toFixed(1)}k kg
                  </div>
                  {detailedStats.volumeChange !== 0 && (
                    <div className={`text-sm ${detailedStats.volumeChange > 0 ? 'text-green-500' : 'text-red-500'}`}>
                      {detailedStats.volumeChange > 0 ? 'â†‘' : 'â†“'} {Math.abs(detailedStats.volumeChange)}% vs last week
                    </div>
                  )}
                </div>
                
                <div>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Total Reps</div>
                  <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {detailedStats.thisWeek.reps}
                  </div>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                    {detailedStats.thisWeek.sets} weighted sets
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4 mb-4">
                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3`}>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Core Sets</div>
                  <div className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {detailedStats.thisWeek.coreSets}
                  </div>
                </div>

                <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3`}>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Avg per workout</div>
                  <div className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {(detailedStats.avgVolumePerWorkout / 1000).toFixed(1)}k kg
                  </div>
                </div>
              </div>
            </div>

            {/* Monthly Overview */}
            <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5`}>
              <h3 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} mb-4`}>Monthly Overview</h3>
              
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>This Month</div>
                  <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {detailedStats.thisMonth.workouts}
                  </div>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>workouts</div>
                </div>
                
                <div>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Volume</div>
                  <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {(detailedStats.thisMonth.volume / 1000).toFixed(1)}k
                  </div>
                  {detailedStats.monthVolumeChange !== 0 && (
                    <div className={`text-sm ${detailedStats.monthVolumeChange > 0 ? 'text-green-500' : 'text-red-500'}`}>
                      {detailedStats.monthVolumeChange > 0 ? 'â†‘' : 'â†“'} {Math.abs(detailedStats.monthVolumeChange)}%
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Personal Records */}
            <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5`}>
              <h3 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} mb-4 flex items-center gap-2`}>
                <Award size={20} />
                Personal Records (Main Lifts)
              </h3>
              
              {Object.keys(detailedStats.exerciseMaxes).length === 0 ? (
                <div className={`text-center py-4 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                  No records yet. Complete workouts to see your PRs!
                </div>
              ) : (
                <div className="space-y-2">
                  {/* Display in specific order */}
                  {['Mrtvo dizanje (Trap Bar)', 'Squat', 'Bench Press', 'Overhead Press (vojniÄki press)', 'Lat Pulldown (ili zgibovi)'].map(lift => {
                    const weight = detailedStats.exerciseMaxes[lift];
                    if (!weight) return null;
                    
                    return (
                      <div key={lift} className={`flex justify-between items-center p-3 ${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg`}>
                        <div className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>{lift}</div>
                        <div className={`font-bold text-lg ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{weight} kg</div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Total Stats */}
            <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5`}>
              <h3 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} mb-4`}>All Time</h3>
              
              <div className="grid grid-cols-3 gap-4 text-center">
                <div>
                  <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {detailedStats.totalWorkouts}
                  </div>
                  <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Total Workouts</div>
                </div>
                <div>
                  <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {(detailedStats.allTimeVolume / 1000).toFixed(0)}k
                  </div>
                  <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Total Volume (kg)</div>
                </div>
                <div>
                  <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                    {detailedStats.avgWorkoutsPerWeek}
                  </div>
                  <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Avg Per Week</div>
                </div>
              </div>
            </div>

            {/* Progress Timeline */}
            <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5`}>
              <h3 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} mb-4 flex items-center gap-2`}>
                <TrendingUp size={20} />
                Progress Timeline
              </h3>

              {/* Time Range Selector */}
              <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                {[
                  { value: '4weeks', label: '4 Weeks' },
                  { value: '3months', label: '3 Months' },
                  { value: '6months', label: '6 Months' },
                  { value: 'all', label: 'All Time' }
                ].map(range => (
                  <button
                    key={range.value}
                    onClick={() => {
                      setTimelineRange(range.value);
                      setSelectedTimelinePoint(null);
                    }}
                    className={`px-4 py-2 rounded-lg whitespace-nowrap font-medium transition-all touch-manipulation ${
                      timelineRange === range.value
                        ? darkMode
                          ? 'bg-blue-600 text-white'
                          : 'bg-blue-500 text-white'
                        : darkMode
                          ? 'bg-gray-700 hover:bg-gray-600 text-gray-300'
                          : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                    }`}
                  >
                    {range.label}
                  </button>
                ))}
              </div>

              {(() => {
                const timelineData = getTimelineData();

                if (timelineData.length === 0) {
                  return (
                    <div className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      No workout data available for this time range.
                    </div>
                  );
                }

                return (
                  <div className="space-y-6">
                    {/* Volume Chart */}
                    <div>
                      <div className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                        Total Volume (kg)
                      </div>
                      <div className="flex justify-center">
                        <LineChart
                          data={timelineData}
                          metric="volume"
                          darkMode={darkMode}
                          onPointClick={setSelectedTimelinePoint}
                          selectedPoint={selectedTimelinePoint}
                        />
                      </div>
                    </div>

                    {/* Frequency Chart */}
                    <div>
                      <div className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2`}>
                        Workout Frequency (sessions)
                      </div>
                      <div className="flex justify-center">
                        <LineChart
                          data={timelineData}
                          metric="frequency"
                          darkMode={darkMode}
                          onPointClick={setSelectedTimelinePoint}
                          selectedPoint={selectedTimelinePoint}
                        />
                      </div>
                    </div>
                  </div>
                );
              })()}
            </div>
          </div>
        )}

        {activeView === 'logging' && currentLog && (
          <div className="space-y-4">
            {/* Workout Header */}
            <div className={`${darkMode ? 'bg-gradient-to-br from-gray-800 to-gray-700 border-gray-700' : 'bg-gradient-to-br from-gray-100 to-gray-50 border-gray-200'} rounded-2xl p-6 shadow-md border transform-gpu`}>
              <div className="flex items-center gap-3 mb-2">
                <WorkoutIcon emoji={currentLog.workoutEmoji} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                <div>
                  <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{currentLog.workoutName}</h2>
                  <div className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-sm`}>
                    {new Date(currentLog.date).toLocaleString('hr-HR', { 
                      day: 'numeric', 
                      month: 'long',
                      hour: '2-digit',
                      minute: '2-digit'
                    })}
                  </div>
                </div>
              </div>
            </div>

            {/* Exercises */}
            {currentLog.exercises.map((exercise, exIdx) => (
              <div key={exIdx} className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-5 shadow-sm transform-gpu`}>
                <h3 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-900'} mb-1`}>{exercise.name}</h3>
                <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>Target: {exercise.plannedSets} Ã— {exercise.plannedReps}</div>
                
                <div className="space-y-3">
                  {exercise.sets.map((set, setIdx) => (
                    <div key={setIdx} className="flex items-center gap-2">
                      <div className="w-12 text-center">
                        <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Set</div>
                        <div className={`${darkMode ? 'text-white' : 'text-gray-900'} font-bold`}>{setIdx + 1}</div>
                      </div>
                      
                      <input
                        type="text"
                        inputMode="decimal"
                        placeholder="kg"
                        value={set.weight}
                        onChange={(e) => updateSet(exIdx, setIdx, 'weight', e.target.value)}
                        className={`w-20 px-3 py-2 ${darkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg text-center font-semibold focus:border-gray-500 focus:outline-none`}
                        disabled={exercise.name.toLowerCase().includes('core') || 
                                 exercise.name.toLowerCase().includes('plank') ||
                                 exercise.name.toLowerCase().includes('hanging')}
                      />
                      
                      <span className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} font-bold`}>Ã—</span>
                      
                      <input
                        type="number"
                        placeholder="reps"
                        value={set.reps}
                        onChange={(e) => updateSet(exIdx, setIdx, 'reps', e.target.value)}
                        className={`w-20 px-3 py-2 ${darkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg text-center font-semibold focus:border-gray-500 focus:outline-none`}
                      />
                      
                      <button
                        onClick={() => toggleSetComplete(exIdx, setIdx)}
                        className={`ml-auto p-3 rounded-lg transition-colors transform-gpu ${
                          set.completed
                            ? 'bg-green-600'
                            : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'
                        }`}
                      >
                        <Check size={20} className={set.completed ? 'text-white' : darkMode ? 'text-gray-400' : 'text-gray-500'} />
                      </button>
                    </div>
                  ))}

                  {/* Add Set Button */}
                  <button
                    onClick={() => {
                      const updatedLog = { ...currentLog };
                      const lastSet = exercise.sets[exercise.sets.length - 1];
                      updatedLog.exercises[exIdx].sets.push({
                        weight: lastSet?.weight || '',
                        reps: lastSet?.reps || exercise.plannedReps,
                        completed: false
                      });
                      setCurrentLog(updatedLog);
                      soundSystem.buttonPress();
                    }}
                    className={`w-full mt-2 px-4 py-2 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-lg flex items-center justify-center gap-2 transition-colors text-sm font-medium touch-manipulation`}
                  >
                    <Plus size={16} />
                    Add Set
                  </button>
                </div>
              </div>
            ))}

            {/* Action Buttons */}
            <div className="flex gap-3 sticky bottom-4">
              <button
                onClick={() => {
                  setCurrentLog(null);
                  setActiveView('home');
                }}
                className={`px-6 py-4 ${darkMode ? 'bg-gray-800 hover:bg-gray-700 border-gray-700' : 'bg-white hover:bg-gray-50 border-gray-300'} border text-${darkMode ? 'white' : 'gray-900'} rounded-xl font-semibold transition-all`}
              >
                Cancel
              </button>
              <button
                onClick={finishWorkout}
                className="flex-1 px-6 py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold transition-colors transform-gpu"
              >
                Finish Workout
              </button>
            </div>
          </div>
        )}

        {activeView === 'history' && (
          <div className="space-y-4">
            <h2 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-4 flex items-center gap-2`}>
              <Calendar size={24} />
              History
            </h2>
            
            {completedWorkouts.length === 0 ? (
              <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} backdrop-blur border rounded-2xl p-12 text-center`}>
                <div className="mb-4 flex justify-center"><BarChart3 size={64} className={darkMode ? 'text-gray-600' : 'text-gray-400'} /></div>
                <div className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} text-lg`}>No workouts yet</div>
                <div className={`${darkMode ? 'text-gray-500' : 'text-gray-500'} text-sm mt-2`}>Start your first workout to see it here!</div>
              </div>
            ) : (
              completedWorkouts.slice().reverse().map((workout) => (
                <div key={workout.id} className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} backdrop-blur border rounded-2xl p-5 shadow-lg`}>
                  <div className="flex items-start gap-3 mb-4">
                    <WorkoutIcon emoji={workout.workoutEmoji} size={32} className={darkMode ? 'text-gray-300' : 'text-gray-700'} />
                    <div className="flex-1">
                      <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{workout.workoutName}</h3>
                      <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        {new Date(workout.date).toLocaleString('hr-HR', {
                          weekday: 'short',
                          day: 'numeric',
                          month: 'short',
                          hour: '2-digit',
                          minute: '2-digit'
                        })}
                      </p>
                    </div>
                    <button
                      onClick={() => setShowDeleteHistory(workout.id)}
                      className="p-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors"
                    >
                      <Trash2 size={16} className="text-white" />
                    </button>
                  </div>
                  
                  <div className="space-y-3">
                    {workout.exercises.map((ex, exIdx) => {
                      // Filter out skipped sets
                      const completedSets = ex.sets.filter(set => {
                        const weight = parseFloat(set.weight) || 0;
                        const reps = parseFloat(set.reps) || 0;
                        const isCoreExercise = ex.name.toLowerCase().includes('core') || 
                                              ex.name.toLowerCase().includes('plank') ||
                                              ex.name.toLowerCase().includes('hanging');
                        
                        // For core exercises, only check reps
                        if (isCoreExercise) return reps > 0;
                        // For weighted exercises, check both weight and reps
                        return weight > 0 && reps > 0;
                      });
                      
                      // Don't render exercise if all sets were skipped
                      if (completedSets.length === 0) return null;
                      
                      return (
                        <div key={exIdx} className={`border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'} pt-3`}>
                          <div className={`font-medium text-sm ${darkMode ? 'text-white' : 'text-gray-900'} mb-2`}>{ex.name}</div>
                          <div className="flex flex-wrap gap-2">
                            {completedSets.map((set, setIdx) => (
                              <div key={setIdx} className={`${darkMode ? 'bg-gray-900' : 'bg-gray-100'} px-3 py-1 rounded-lg text-sm`}>
                                {set.weight && parseFloat(set.weight) > 0 ? (
                                  <>
                                    <span className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} font-semibold`}>{set.weight}kg</span>
                                    <span className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} mx-1`}>Ã—</span>
                                  </>
                                ) : null}
                                <span className={darkMode ? 'text-gray-400' : 'text-gray-600'}>{set.reps}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))
            )}
          </div>
        )}

        {activeView === 'edit' && editingWorkout && (
          <div className="space-y-4">
            <div className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} backdrop-blur border rounded-2xl p-5`}>
              <h2 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-4`}>Edit Workout</h2>
              <div className="space-y-3">
                <input
                  type="text"
                  value={editingWorkout.name}
                  onChange={(e) => setEditingWorkout({ ...editingWorkout, name: e.target.value })}
                  className={`w-full px-4 py-3 ${darkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg text-lg focus:border-gray-500 focus:outline-none`}
                  placeholder="Workout name"
                />
                <div>
                  <label className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-2 block`}>Select Icon:</label>
                  <IconPicker
                    selectedEmoji={editingWorkout.emoji || 'ðŸ’ª'}
                    onSelect={(emoji) => setEditingWorkout({ ...editingWorkout, emoji })}
                    darkMode={darkMode}
                  />
                </div>
              </div>
            </div>
            
            <div className="space-y-3">
              {editingWorkout.exercises.map((ex, idx) => (
                <div
                  key={idx}
                  className={`${darkMode ? 'bg-gray-800/50 border-gray-700' : 'bg-white border-gray-200'} backdrop-blur border rounded-2xl p-4 transition-all duration-200 ${
                    draggedExerciseIndex === idx && isDraggingExercise ? 'opacity-30' : ''
                  } ${
                    dropTargetIndex === idx && draggedExerciseIndex !== idx ? 'ring-2 ring-blue-500' : ''
                  }`}
                  data-exercise-index={idx}
                >
                  <div className="flex gap-2 mb-3">
                    {/* Drag Handle */}
                    <div
                      className={`flex items-center justify-center cursor-grab active:cursor-grabbing ${darkMode ? 'text-gray-500 hover:text-gray-400' : 'text-gray-400 hover:text-gray-600'} touch-manipulation select-none`}
                      onMouseDown={(e) => handleExerciseDragStart(e, idx)}
                      onTouchStart={(e) => handleExerciseDragStart(e, idx)}
                      style={{ touchAction: 'none' }}
                    >
                      <GripVertical size={20} />
                    </div>
                    <input
                      type="text"
                      value={ex.name}
                      onChange={(e) => updateExercise(idx, 'name', e.target.value)}
                      className={`flex-1 px-3 py-2 ${darkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg focus:border-gray-500 focus:outline-none`}
                      placeholder="Exercise name"
                    />
                    <button
                      onClick={() => deleteExercise(idx)}
                      className="p-2 bg-red-600 hover:bg-red-700 active:bg-red-800 rounded-lg transition-colors touch-manipulation"
                    >
                      <Trash2 size={20} className="text-white" />
                    </button>
                  </div>
                  <div className="flex gap-2 pl-7">
                    <input
                      type="number"
                      value={ex.sets}
                      onChange={(e) => updateExercise(idx, 'sets', parseInt(e.target.value))}
                      className={`w-20 px-3 py-2 ${darkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg text-center focus:border-gray-500 focus:outline-none`}
                      placeholder="Sets"
                    />
                    <input
                      type="text"
                      value={ex.reps}
                      onChange={(e) => updateExercise(idx, 'reps', e.target.value)}
                      className={`w-24 px-3 py-2 ${darkMode ? 'bg-gray-900 border-gray-700 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg text-center focus:border-gray-500 focus:outline-none`}
                      placeholder="Reps"
                    />
                  </div>
                </div>
              ))}
            </div>

            <button
              onClick={addExercise}
              className={`w-full px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} text-${darkMode ? 'white' : 'gray-900'} rounded-xl flex items-center justify-center gap-2 transition-colors font-semibold`}
            >
              <Plus size={20} />
              Add Exercise
            </button>

            <div className="flex gap-3">
              <button
                onClick={() => {
                  setEditingWorkout(null);
                  setActiveView('home');
                }}
                className={`px-6 py-3 ${darkMode ? 'bg-gray-800 hover:bg-gray-700 border-gray-700' : 'bg-white hover:bg-gray-50 border-gray-300'} border text-${darkMode ? 'white' : 'gray-900'} rounded-xl font-semibold transition-colors`}
              >
                Cancel
              </button>
              <button
                onClick={saveEditedWorkout}
                className={`flex-1 px-6 py-3 ${darkMode ? 'bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500' : 'bg-gradient-to-r from-gray-800 to-gray-700 hover:from-gray-700 hover:to-gray-600'} text-white rounded-xl font-semibold transition-all`}
              >
                Save Changes
              </button>
            </div>
          </div>
        )}
      </div>

      {/* Floating Drag Ghost */}
      {isDraggingExercise && draggedExerciseIndex !== null && editingWorkout && (
        <div
          style={{
            position: 'fixed',
            left: draggedExercisePosition.x,
            top: draggedExercisePosition.y,
            transform: 'translate(-50%, -50%)',
            pointerEvents: 'none',
            zIndex: 10000,
            width: '90%',
            maxWidth: '400px'
          }}
        >
          <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-4 shadow-2xl opacity-90`}>
            <div className="flex gap-2 mb-2">
              <GripVertical size={20} className={darkMode ? 'text-gray-500' : 'text-gray-400'} />
              <div className={`flex-1 font-medium ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                {editingWorkout.exercises[draggedExerciseIndex].name || 'Exercise'}
              </div>
            </div>
            <div className="flex gap-2 pl-7">
              <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                {editingWorkout.exercises[draggedExerciseIndex].sets} sets Ã—{' '}
                {editingWorkout.exercises[draggedExerciseIndex].reps} reps
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      {showDeleteConfirm && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-6 max-w-md w-full shadow-2xl`}>
            <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-2`}>Delete Workout Day?</h3>
            <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-6`}>
              Are you sure you want to delete this workout day? This action cannot be undone.
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowDeleteConfirm(null)}
                className={`flex-1 px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-xl font-semibold transition-colors`}
              >
                Cancel
              </button>
              <button
                onClick={() => deleteWorkoutDay(showDeleteConfirm)}
                className="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-semibold transition-colors"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Add Day Modal */}
      {showAddDay && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-6 max-w-md w-full shadow-2xl`}>
            <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-2`}>Add New Workout Day</h3>
            <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-6`}>
              This will create a new workout day that you can customize with your exercises.
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowAddDay(false)}
                className={`flex-1 px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-xl font-semibold transition-colors`}
              >
                Cancel
              </button>
              <button
                onClick={addNewWorkoutDay}
                className={`flex-1 px-4 py-3 ${darkMode ? 'bg-gradient-to-r from-gray-700 to-gray-600 hover:from-gray-600 hover:to-gray-500' : 'bg-gradient-to-r from-gray-800 to-gray-700 hover:from-gray-700 hover:to-gray-600'} text-white rounded-xl font-semibold transition-colors`}
              >
                Add Day
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Upload Markdown Modal */}
      {showUploadModal && (
        <div
          className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999] p-4 overflow-y-auto"
          onClick={(e) => {
            // Close modal if clicking backdrop
            if (e.target === e.currentTarget) {
              setShowUploadModal(false);
            }
          }}
        >
          <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-6 max-w-md w-full shadow-2xl my-8`}>
            <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-2`}>
              Upload Workout Routine
            </h3>
            <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>
              Found {parsedWorkouts.length} workout day(s) in the file.
            </p>

            <div className="mb-6">
              <label className={`block text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'} mb-2`}>
                How would you like to import these workouts?
              </label>
              <div className="space-y-2">
                <button
                  onClick={() => handleImportChoice('replace')}
                  className={`w-full px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 active:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300 active:bg-gray-400'} rounded-xl text-left transition-colors touch-manipulation`}
                >
                  <div className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Replace All</div>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Clear existing workouts and use only these</div>
                </button>
                <button
                  onClick={() => handleImportChoice('add')}
                  className={`w-full px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 active:bg-gray-500' : 'bg-gray-200 hover:bg-gray-300 active:bg-gray-400'} rounded-xl text-left transition-colors touch-manipulation`}
                >
                  <div className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>Add to Existing</div>
                  <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Keep current workouts and add these</div>
                </button>
              </div>
            </div>

            <button
              onClick={() => setShowUploadModal(false)}
              className={`w-full px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 active:bg-gray-500 text-white' : 'bg-gray-200 hover:bg-gray-300 active:bg-gray-400 text-gray-900'} rounded-xl font-semibold touch-manipulation`}
            >
              Cancel
            </button>
          </div>
        </div>
      )}

      {/* Delete History Confirmation Modal */}
      {showDeleteHistory && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-6 max-w-md w-full shadow-2xl`}>
            <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'} mb-2`}>Delete Workout Entry?</h3>
            <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-6`}>
              Are you sure you want to delete this workout from your history? This will affect your statistics and cannot be undone.
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowDeleteHistory(null)}
                className={`flex-1 px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-xl font-semibold transition-colors`}
              >
                Cancel
              </button>
              <button
                onClick={() => deleteHistoryEntry(showDeleteHistory)}
                className="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-semibold transition-colors"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Timeline Detail Modal */}
      {selectedTimelinePoint && (
        <div
          className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[9999] p-4 overflow-y-auto"
          onClick={(e) => {
            if (e.target === e.currentTarget) {
              setSelectedTimelinePoint(null);
            }
          }}
        >
          <div className={`${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border rounded-2xl p-6 max-w-md w-full shadow-2xl my-8`}>
            <div className="flex items-center justify-between mb-4">
              <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                Week of {new Date(selectedTimelinePoint.date).toLocaleDateString('en-US', {
                  month: 'short',
                  day: 'numeric',
                  year: 'numeric'
                })}
              </h3>
              <button
                onClick={() => setSelectedTimelinePoint(null)}
                className={`p-2 ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} rounded-lg transition-colors`}
              >
                <X size={20} className={darkMode ? 'text-gray-400' : 'text-gray-600'} />
              </button>
            </div>

            {/* Summary Stats */}
            <div className="grid grid-cols-2 gap-3 mb-6">
              <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4`}>
                <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Total Volume</div>
                <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                  {(selectedTimelinePoint.volume / 1000).toFixed(1)}k
                </div>
                <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>kg</div>
              </div>

              <div className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-4`}>
                <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-1`}>Workouts</div>
                <div className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                  {selectedTimelinePoint.frequency}
                </div>
                <div className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>sessions</div>
              </div>
            </div>

            {/* Main Lifts PRs */}
            {(selectedTimelinePoint.mainLifts.deadlift || selectedTimelinePoint.mainLifts.squat ||
              selectedTimelinePoint.mainLifts.bench || selectedTimelinePoint.mainLifts.ohp) && (
              <div className="mb-6">
                <h4 className={`text-sm font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-3`}>
                  Main Lifts (Max Weight)
                </h4>
                <div className="space-y-2">
                  {selectedTimelinePoint.mainLifts.deadlift && (
                    <div className="flex justify-between items-center">
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Deadlift</span>
                      <span className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        {selectedTimelinePoint.mainLifts.deadlift} kg
                      </span>
                    </div>
                  )}
                  {selectedTimelinePoint.mainLifts.squat && (
                    <div className="flex justify-between items-center">
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Squat</span>
                      <span className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        {selectedTimelinePoint.mainLifts.squat} kg
                      </span>
                    </div>
                  )}
                  {selectedTimelinePoint.mainLifts.bench && (
                    <div className="flex justify-between items-center">
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Bench Press</span>
                      <span className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        {selectedTimelinePoint.mainLifts.bench} kg
                      </span>
                    </div>
                  )}
                  {selectedTimelinePoint.mainLifts.ohp && (
                    <div className="flex justify-between items-center">
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Overhead Press</span>
                      <span className={`text-sm font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                        {selectedTimelinePoint.mainLifts.ohp} kg
                      </span>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Workouts List */}
            <div>
              <h4 className={`text-sm font-semibold ${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-3`}>
                Workouts Completed ({selectedTimelinePoint.workouts.length})
              </h4>
              <div className="space-y-2 max-h-48 overflow-y-auto">
                {selectedTimelinePoint.workouts.map((workout, idx) => (
                  <div
                    key={idx}
                    className={`${darkMode ? 'bg-gray-900' : 'bg-gray-50'} rounded-lg p-3 flex items-center justify-between`}
                  >
                    <div className="flex items-center gap-2">
                      <WorkoutIcon emoji={workout.workoutEmoji} className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`} size={16} />
                      <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                        {workout.workoutName}
                      </span>
                    </div>
                    <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                      {new Date(workout.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                    </span>
                  </div>
                ))}
              </div>
            </div>

            <button
              onClick={() => setSelectedTimelinePoint(null)}
              className={`w-full mt-6 px-4 py-3 ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-900'} rounded-xl font-semibold transition-colors touch-manipulation`}
            >
              Close
            </button>
          </div>
        </div>
      )}

      {/* Bottom Navigation */}
      <div className={`fixed bottom-0 left-0 right-0 ${darkMode ? 'bg-gray-900' : 'bg-white'} border-t ${darkMode ? 'border-gray-800' : 'border-gray-200'} px-4 py-3 transform-gpu`}>
        <div className="max-w-6xl mx-auto flex justify-around">
          <button
            onClick={() => setActiveView('home')}
            className={`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition-colors ${
              activeView === 'home' || activeView === 'edit' || activeView === 'logging'
                ? darkMode ? 'text-gray-300' : 'text-gray-900'
                : darkMode ? 'text-gray-600' : 'text-gray-400'
            }`}
          >
            <Dumbbell size={24} />
            <span className="text-xs font-medium">Workouts</span>
          </button>
          
          <button
            onClick={() => setActiveView('stats')}
            className={`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition-colors ${
              activeView === 'stats'
                ? darkMode ? 'text-gray-300' : 'text-gray-900'
                : darkMode ? 'text-gray-600' : 'text-gray-400'
            }`}
          >
            <BarChart3 size={24} />
            <span className="text-xs font-medium">Stats</span>
          </button>
          
          <button
            onClick={() => setActiveView('history')}
            className={`flex flex-col items-center gap-1 px-4 py-2 rounded-lg transition-colors ${
              activeView === 'history' 
                ? darkMode ? 'text-gray-300' : 'text-gray-900'
                : darkMode ? 'text-gray-600' : 'text-gray-400'
            }`}
          >
            <Calendar size={24} />
            <span className="text-xs font-medium">History</span>
          </button>
        </div>
      </div>
    </div>
  );
};



    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<WorkoutTracker />);

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }
  </script>
</body>
</html>